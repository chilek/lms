if: (repo = chilek/lms) OR (branch =~ /^stable/)

env:
  global:
    - COMPOSER_DISABLE_XDEBUG_WARN="1"

matrix:
  include:
    - os: linux
      language: php
      php: 7.2
      dist: xenial
      env:
        PHPCS_VER="^3"
        PHPCS_STANDARD="phpcs3.xml"
        INSTALL_PHP_ZIP_EXTENSION=false

    - os: linux
      language: php
      php: 7.3
      dist: xenial
      env:
        PHPCS_VER="^3"
        PHPCS_STANDARD="phpcs3.xml"
        INSTALL_PHP_ZIP_EXTENSION=false

    - os: linux
      language: php
      php: 7.4
      dist: xenial
      env:
        PHPCS_VER="^3"
        PHPCS_STANDARD="phpcs3.xml"
        INSTALL_PHP_ZIP_EXTENSION=true

    - os: linux
      language: php
      php: 8.0
      dist: xenial
      env:
        PHPCS_VER="^3"
        PHPCS_STANDARD="phpcs3.xml"
        INSTALL_PHP_ZIP_EXTENSION=true

addons:
  postgresql: 9.4

services:
  - postgresql
  - mysql

#before_install:
#   - if ${INSTALL_PHP_ZIP_EXTENSION}; then sudo apt-get install libzip-dev; pecl install zip; fi
#   - echo "extension = libzip.so" >> ~/.phpenv/versions/$(phpenv version-name)/etc/php.ini
#  - echo "extension = snmp.so" >> ~/.phpenv/versions/$(phpenv version-name)/etc/php.ini

install:
  - composer install

before_script:
  - psql -U postgres -c 'CREATE DATABASE lms;'
  - psql -U postgres -f doc/lms.pgsql
  - psql -U postgres -f doc/lms-stable.pgsql
  - mysql -e 'CREATE DATABASE lms;'
  - mysql lms < doc/lms.mysql
  - mysql lms < doc/lms-stable.mysql

  - cd /var/www/html/lms/; for dir in 'backups cache documents templates_c userpanel/templates_c rtattachments js/xajax_js/deferred storage/rt storage/voipcalls storage/customercalls'; do mkdir -p $dir && chmod o-rwx -R $dir; done
  - php devel/upgradedb.php -C sample/lms-pgsql-travis.ini
  - php devel/upgradedb.php -C sample/lms-mysql-travis.ini
  - if find . -mtime -1 -name "*.php" ! -path "./vendor/*" -print0 | xargs -0 -n 1 -P 8 php -l | grep -v "No syntax errors detected"; then exit 1; fi
  - if find templates -mtime -1 -type f -iname '*.html' | xargs devel/smartylint.php |grep -i "syntax error"; then exit 1; fi
  - ./vendor/bin/phpcs --standard=$PHPCS_STANDARD .
  - npm install -g jshint
  - jshint .
  #- ./vendor/bin/phpunit

script: true

notifications:
  email:
#    recipients:
#      - admin@chilan.com
#      - r.pietraszewicz@gmail.com
    on_success: change
    on_failure: always
