/*
**********************************************************
****** Upgrade bazy danych LMS z wersji 1.0 do 1.1 *******
**********************************************************
Zaleca siê wcze¶niejszy backup bazy:
	$ mysqldump -u lms lms > db.out
Sposób u¿ycia:
	$ mysql -u lms
	mysql> use lms;
	mysql> source doc/UPGRADE.mysql;
Po tej operacji wystartuj LMS i uruchom modu³ ?m=upgrade01
Na samym koñcu mo¿esz wyrzuciæ niepotrzebne rzeczy:
	mysql> ALTER TABLE users DROP tariff, DROP payday;
**********************************************************
*/

/* Ta tabela ju¿ nie jest u¿ywana */
DROP TABLE IF EXISTS options;

/* Nowe kolumny */
ALTER TABLE users ADD deleted BOOL DEFAULT '0' NOT NULL;
ALTER TABLE users ADD payday INT DEFAULT '1' NOT NULL;

/* Nowe pola w tabeli */
ALTER TABLE networks ADD dns2 VARCHAR(16) AFTER dns;
ALTER TABLE networks ADD interface VARCHAR(8) AFTER mask;

/* Zmiana typu adresu */
UPDATE nodes SET ipaddr=INET_ATON(ipaddr);
ALTER TABLE nodes CHANGE ipaddr ipaddr INT(16) UNSIGNED NOT NULL;
/* Zmiana formatu zapisu czy komputer jest dostêpny */
UPDATE nodes SET access='1' WHERE access='Y';
UPDATE nodes SET access='0' WHERE access='N';
ALTER TABLE nodes CHANGE access access BOOL NOT NULL DEFAULT '1';
/* Dodatkowe poprawki w bazie */
ALTER TABLE nodes CHANGE ownerid ownerid INT(11) DEFAULT '0' NOT NULL;
ALTER TABLE nodes CHANGE mac mac VARCHAR(20) NOT NULL;
/* Linki do urz±dzeñ */
ALTER TABLE nodes ADD netdev INT(11) NOT NULL DEFAULT '0' AFTER modid;

/* Zmiana zapisu limitu */
ALTER TABLE tariffs CHANGE uprate uprate INT(11), CHANGE downrate downrate INT(11);

/* Faktury inaczej */
ALTER TABLE cash ADD invoiceid INT DEFAULT '0' NOT NULL;
ALTER TABLE tariffs ADD taxvalue INT DEFAULT '0' NOT NULL AFTER value;
ALTER TABLE tariffs ADD sww VARCHAR(255) DEFAULT '' NOT NULL AFTER taxvalue;
    
CREATE TABLE invoices (
      id INT NOT NULL AUTO_INCREMENT ,
      number INT NOT NULL ,
      cdate INT NOT NULL ,
      paytime TINYINT( 8 ) NOT NULL ,
      customerid INT NOT NULL ,
      name VARCHAR( 255 ) NOT NULL ,
      address VARCHAR( 255 ) NOT NULL ,
      nip VARCHAR( 16 ) NOT NULL ,
      zip VARCHAR( 6 ) NOT NULL ,
      city VARCHAR( 32 ) NOT NULL ,
      phone VARCHAR( 255 ) NOT NULL ,
      finished TINYINT( 1 ) NOT NULL DEFAULT '0',
      PRIMARY KEY (id),
      UNIQUE KEY id (id),
      KEY id_2 (id)
) TYPE=MyISAM;

CREATE TABLE invoicecontents (
    invoiceid INT NOT NULL,
    value DOUBLE NOT NULL,
    taxvalue INT NOT NULL,
    sww VARCHAR( 255 ) NOT NULL DEFAULT '',
    content VARCHAR( 16 ) NOT NULL,
    count INT NOT NULL,
    description VARCHAR( 255 ) NOT NULL,
    tariffid INT NOT NULL
) TYPE=MyISAM;

/* Nowa tabela dla statystyk */
DROP TABLE IF EXISTS stats;
CREATE TABLE stats (
    nodeid int(11) NOT NULL DEFAULT '0',
    dt int(11) NOT NULL DEFAULT '0',
    upload int(11) DEFAULT '0',
    download int(11) DEFAULT '0',
    PRIMARY KEY (nodeid, dt)
) TYPE=MyISAM;

/* Nowa tabela - urz±dzenia sieciowe */
DROP TABLE IF EXISTS netdevices;
CREATE TABLE netdevices (
   id int(11) NOT NULL auto_increment,
   name varchar(32) default NULL,
   location varchar(255),
   description varchar(255) default NULL,
   producer varchar(64) default NULL,
   model varchar(32) default NULL,
   serialnumber varchar(32) default NULL,
   ports int(10) default NULL,
   PRIMARY KEY  (id),
   KEY name (name)
) TYPE=MyISAM;

/* Nowa tabela - po³aczenia sieciowe */
CREATE TABLE netlinks (
  id int(11) NOT NULL auto_increment,
  src int(11) NOT NULL default '0',
  dst int(11) NOT NULL default '0',
  PRIMARY KEY  (id)
) TYPE=MyISAM;

/* Na koniec rewolucja w finansach */
DROP TABLE IF EXISTS assignments;
CREATE TABLE assignments (
   id int(11) NOT NULL auto_increment,
   tariffid int(11) NOT NULL default '0',
   userid int(11) NOT NULL default '0',
   period int(11) NOT NULL default '0',
   at int(11) NOT NULL default '0',
   invoice tinyint(1) NOT NULL default '0',
   PRIMARY KEY  (id),
   UNIQUE KEY id (id),
   KEY id_2 (id)
) TYPE=MyISAM;

/* Chyba o niczym nie zapomnia³em? */
/*
$Id$
*/
