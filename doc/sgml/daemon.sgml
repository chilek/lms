<!-- $Id$ -->
<chapter id="daemon">
     <title>A.L.E.C's LMS Daemon</title>
     <sect1 id="daemon-intro">
     <title>Basics</title>
     <para>Written in C program facilitate management of services. Daemon is
         responsible for starting of appropriate modules on user demand only. Modules
         are making configuration files based on data from LMS's database and
         restarting selected services on a server.
         </para>
     <para>Why such name? The better part of daemon code was written by one of developers - Aleksander 
     'A.L.E.C' Machniak, nevertheless must underline a contribution of Marcina 'Lexx' Krol. Program
     include fragments of code of Mateusza 'mteg' Golicz's old daemon and use Nicolas Devillard's iniparser
     library.
     </para>
          <sect2 id="daemon-requirements">
          <title>Requirements</title>
               <para><emphasis>A.L.E.C's LMS Daemon</emphasis> require:
                     <itemizedlist>
               <listitem>
                    <para>LMS user interface installation</para>
               </listitem>
               <listitem>
                    <para><filename>libmysqlclient</filename> (full MySQL installation or respective packet) 
                    or <filename>libpq</filename> in case of PostgreSQL database or <filename>sqlite</filename></para>
                     </listitem>
               <listitem>
                    <para><filename>libdl</filename> (that is in every present-day distribution)</para>
               </listitem>
               <listitem>
                    <para>C compiler</para>
               </listitem>
               </itemizedlist>
                     </para>
          </sect2>
          <sect2 id="daemon-install">
          <title>Installation</title>
               <para>Prior to compilation you must set options described on following listing
               with help of <filename>./configure</filename> script (in brackets are shown
               default values):
<screen>
  --help                help
  --enable-debug0       SQL queries logging (disabled)
  --enable-debug1       events logging (disabled)
  --with-pgsql          enables using of PostgreSQL database (disabled)
  --with-mysql          enables using of MySQL database (enabled)
  --with-sqlite         enables using of SQLite database (disabled)
  --prefix=DIR          program install directory (/usr/local/bin)
  --libdir=DIR          location of database libraries (/usr/lib)
  --incdir=DIR          location of database header files (/usr/include)
</screen>
               Then, required is to set database which you will use (--with-mysql 
               or --with-pgsql) and location of libraries supplied with database (--incdir, --libdir).
               You can use only one database. If you will change database, you must to recompile daemon.
<screen>
# ./configure --with-pgsql --libdir=/usr/local/pgsql/lib --incdir=/usr/local/pgsql/include
</screen>
               After that you can compile and install (put daemon in directory
               given with --prefix option):
<screen>
# make && make install
</screen>
               Finally, compiled modules (files with <filename>.so</filename> extension),
               found in directory <filename>modules/module_name</filename> move to any 
               directory. Their location you will set in configuration file.
               </para>
          </sect2>
          <sect2 id="daemon-config">
          <title>Configuration</title>
               <para>Example daemon configuration you can find in file <filename>lms.ini.sample</filename>.
               Following listing describe basic options for daemon (modules configuration is described 
               in separate chapters concerning modules):
<screen>
[database]
host            = localhost     # host name or IP, default: localhost
user            = lms           # user name, default: lms
password        = mypasswd      # database password, default: empty
database        = lms           # database name, default: lms
port            = 0             # port number, default: 0

[lmsd]
sleeptime       = 30            # time interval (in seconds) how often to
                                # check for reload order, default: 30
instances       = hosts oident firewall       # module instances list
command         = 'echo Connecting...'        # shell command to run before every database connection 
</screen>
               <note><para>List of instances contains instances names detached with 
               spaces. Instance is a name of section in configuration file.</para></note>
               </para>
               <para>In instance section, beside config modules params, you must specify
               primary options, as on following listing:
<screen>
[instance_name]
module = /path/to/module.so
info = "Additional description of module"
</screen>          
               </para>
               <para>Change of 'instances' and any option i instances sections do not
               require daemon restart. For other global options restart is required.</para>
          </sect2>
          <sect2 id="daemon-run">
          <title>Starting</title>
               <para>You can run program as a daemon working in background (option '-b'). Then
               configuration and services reload is done on demand with use of 
               'Reload' menu in <emphasis>LMS-UI</emphasis>. Option 'sleeptime' (-s) specify interval
               between database reads. When daemon detects reload order, he runs
               modules defined by 'instances' option in <filename>lms.ini</filename>.
               For example:
<screen>
# almsd -b
</screen>               
               </para>
               <para>Other way to run is disposable reload with usage of cron. 
               You must to use this manner of reload for runing modules like 'payments'
               'notify' or 'traffic'. In that case you can specify instances to reload
               with use of option '-i'. Example crontab's entry:
<screen>
  1 0 * * *    /usr/local/bin/almsd -qi "payments notify"
</screen>
               </para>
               <para>Following listing describe program command line options:
<screen>
  -c     path to config (default: /etc/lms/lms.ini)
  -i     list of instances (separated by space) to reload
  -b     run in background (daemon mode)
  -s     'reload' table reading interval in sec. (default: 30)
  -q      reload and quit
  -h      prints command line options
</screen>
               </para>
          </sect2>
     </sect1>
     <sect1 id="daemon-modules">
     <title>Modules</title>
     <para>Daemon can only run modules and they are doing all job. 
     Most of modules are designed to specific application, only 'hostfile' 
     can be used to many different configs (services), i.e. various firewall types. 
     Daemon and modules configuration examples contains file <filename>daemon/lms.ini.sample</filename>.
     Modules configuration parameters must be placed in appropriate instances sections.</para>
          <sect2 id="daemon-moduleslist">
          <title>Modules list</title>
               <table>
               <title>List of almsd daemon modules</title>
               <tgroup cols="2">
               <colspec ALIGN="center" COLWIDTH="200">
               <colspec ALIGN="center" COLWIDTH="300">
                    <thead>
                    <row>
                    <entry>Name</entry>
                    <entry>Description</entry>
                    </row>
                    </thead>
                    <tbody>
                    <row>
                    <entry><xref linkend="daemon-system"></entry>
                    <entry>Shell commands execution</entry>
                    </row>
                    <row>
                    <entry><xref linkend="daemon-dhcp"></entry>
                    <entry>Configuration of DHCP server</entry>
                    </row>
                    <row>
                    <entry><xref linkend="daemon-cutoff"></entry>
                    <entry>Disconnection of indebted users</entry>
                    </row>
                    <row>
                    <entry><xref linkend="daemon-dns"></entry>
                    <entry>Configuration of DNS server</entry>
                    </row>
                    <row>
                    <entry><xref linkend="daemon-ethers"></entry>
                    <entry>Making of /etc/ethers file</entry>
                    </row>
                    <row>
                    <entry><xref linkend="daemon-hostfile"></entry>
                    <entry>Universal module (e.g. making iptables rules)</entry>
                    </row>
                    <row>
                    <entry><xref linkend="daemon-notify"></entry>
                    <entry>E-mail notifying users about payments</entry>
                    </row>
                    <row>
                    <entry><xref linkend="daemon-ggnotify"></entry>
                    <entry>Gadu-Gadu (polish internet messenger) notifying users about payments</entry>
                    </row>
                    <row>
                    <entry><xref linkend="daemon-payments"></entry>
                    <entry>Payments accounting</entry>
                    </row>
                    <row>
                    <entry><xref linkend="daemon-oident"></entry>
                    <entry>Configuration of oident daemon</entry>
                    </row>
                    <row>
                    <entry><xref linkend="daemon-tc"></entry>
                    <entry>Making HTB rules</entry>
                    </row>
                    <row>
                    <entry><xref linkend="daemon-traffic"></entry>
                    <entry>Internet link usage statistics</entry>
                    </row>
                    <row>
                    <entry><xref linkend="daemon-pinger"></entry>
                    <entry>Users activity scanning</entry>
                    </row>
                    </tbody>
               </tgroup>
               </table>
          </sect2>
          <sect2 id="daemon-system" xreflabel="system">
          <title>System</title>
              <sect3 id="system-desc">
              <title>Description</title>
              <para>This module doing only one thing. It's executing of given command 
	      of linux shell. It can be usefull when you want to execute some command
	      or run external script while configuration reload, e.g. one of them, 
              which are in LMS <filename>/bin</filename> directory.</para>
              </sect3>
              <sect3 id="system-config">
              <title>Configuration</title>
              <para>By reason of above-mentioned you can define only command contents.
              Shell should advise with list of commands separated by semicolons:</para>
              <itemizedlist>
               <listitem>
                   <para>command</para>
                   <para>Shell command. Default: empty.</para>
                   <para>Example: <prompt>command = 'echo "hello"'</prompt></para>
               </listitem>
              </itemizedlist>
              </sect3>
          </sect2>
          <sect2 id="daemon-payments" xreflabel="payments">
          <title>Payments</title>
              <sect3 id="payments-desc">
              <title>Description</title>
              <para>Module accounts customers subscription payments and solid payments. It should 
              be executed commonly once a day. Payments are accounted on base of customers
              liabilities and writed to database with description defined in 'comment' option.
              After accounting are created invoices. Description of solid payment is a 
              mass of its name and creditor name. At the end from database are removed
	      out-of-dated customers liabilities.</para>
              </sect3>
              <sect3 id="payments-config">
              <title>Configuration</title>
              <para>For that module you can use following options:</para>
              <itemizedlist>
               <listitem>
                   <para>comment</para>
                   <para>Operation description. '%period' will be replaced by dates from-to 
                   of subscription, e.g. '10.10.2003 - 09.11.2003', and '%tariff' by name
                   of tariff. Default: 'Abonament wg taryfy: '%tariff' za okres: %period'.</para>
                   <para>Example: <prompt>comment = 'Subscription: %tariff for period %period' </prompt></para>
               </listitem>
               <listitem>
                   <para>up_payments</para>
                   <para>Decision how should be counted period in comment - forward
                   or backward relatively to date of payment accounting. Default: yes.</para>
                   <para>Example: <prompt>up_payments = no</prompt></para>
               </listitem>
               <listitem>
                   <para>expiry_days</para>
                   <para>Defines number of days from date of liability expiration, after which 
                   that liability will be removed from database. When you set '0' data will be
                   removed immediately after date, for which binds that liability. Default: 30.</para>
                   <para>Example: <prompt>expiry_days = 365</prompt></para>
               </listitem>
               <listitem>
                   <para>deadline</para>
                   <para>Payment deadline in days. Default: 14.</para>
                   <para>Example: <prompt>deadline = 21</prompt></para>
               </listitem>
               <listitem>
                   <para>paytype</para>
                   <para>Payment type. Default: 'PRZELEW'.</para>
                   <para>Example: <prompt>paytype = 'CASH'</prompt></para>
               </listitem>
              </itemizedlist>
              </sect3>
          </sect2>
          <sect2 id="daemon-notify" xreflabel="notify">
          <title>Notify</title>
              <sect3 id="notify-desc">
              <title>Description</title>
              <para>Module 'notify' is destined to inform customers of debt
              in payments using electronic mail. Current customer balance
              is compared with 'limit' option, if is lower - message will 
	      be sent. Message content is taken from prepared template, which
              can consists following variables:
              <itemizedlist>
               <listitem>
                   <para>%saldo - current customer balance</para>
               </listitem>
               <listitem>
                   <para>%name - customer forename</para>
               </listitem>
               <listitem>
                   <para>%lastname - customer name/lastname</para>
               </listitem>
               <listitem>
                   <para>%last_10_in_a_table - last 10 operations on customer account</para>
               </listitem>
              </itemizedlist></para>
              </sect3>
              <sect3 id="notify-config">
              <title>Configuration</title>
              <para>Below are presented configuration options of 'notify' module:</para>
              <itemizedlist>
               <listitem>
                   <para>template</para>
                   <para>Location of message template file. Default: empty.</para>
                   <para>Example: <prompt>template = modules/notify/sample/mailtemplate</prompt></para>
               </listitem>
               <listitem>
                   <para>file</para>
                   <para>Location of temprary file. Default: /tmp/mail</para>
                   <para>Example: <prompt>file = /tmp/mail.txt</prompt></para>
               </listitem>
               <listitem>
                   <para>command</para>
                   <para>Shell command for e-maila sending. '%address' will be replaced
                   by customer e-mail address. Default: 'mail -s "Liabilities Information" %address &lt; /tmp/mail'.</para>
                   <para>Example: <prompt>command = 'mail -s "You must pay or ..." $address &lt; /tmp/mail.txt'</prompt></para>
               </listitem>          
               <listitem>
                   <para>limit</para>
                   <para>Message is sended when customer balance will decrease
                   below value defined in that option. Default: 0</para>
                   <para>Example: <prompt>limit = -20</prompt></para>
               </listitem>
               <listitem>
                   <para>debug_mail</para>
                   <para>If set, at this address goes all messages. Useful
                   for testing. Default: empty.</para>
                   <para>Example: <prompt>debug_mail = localhost@my.net</prompt></para>
               </listitem>
              </itemizedlist>
              </sect3>
          </sect2>
          <sect2 id="daemon-ggnotify" xreflabel="ggnotify">
          <title>Ggnotify</title>
              <sect3 id="ggnotify-desc">
              <title>Description</title>
              <para>Equivalent of 'notify' module destined to sending gadu-gadu messages.
	      Gadu-Gadu it's a most popular polish internet messenger.</para>
              <para>Module require installed <filename>libgadu</filename> library and sources
              of <filename>ekg</filename> program. Appropriate paths for them must to be
	      put in <filename>modules/ggnotify/Makefile</filename> before module compilation.</para>
              </sect3>
              <sect3 id="ggnotify-config">
              <title>Configuration</title>
              <para>Podobnie jak w 'notify' masz do dyspozycji nastêpuj±ce zmienne:</para>
              <itemizedlist>
               <listitem>
                   <para>template</para>
                   <para>Location of message template file. Default: empty.</para>
                   <para>Example: <prompt>template = modules/notify/sample/mailtemplate</prompt></para>
               </listitem>
               <listitem>
                   <para>uin</para>
                   <para>Gadu-gadu identifier of message sender. 
                   Default: empty.</para>
                   <para>Example: <prompt>uin = 1234567</prompt></para>
               </listitem>
               <listitem>
                   <para>password</para>
                   <para>Password for account specified in 'uin'. Default: empty.</para>
                   <para>Example: <prompt>password = "my_HURD.password"</prompt></para>
               </listitem>          
               <listitem>
                   <para>limit</para>
                   <para>Message is sended when customer balance will decrease
                   below value defined in that option. Default: 0</para>
                   <para>Example: <prompt>limit = -20</prompt></para>
               </listitem>
               <listitem>
                   <para>debug_uin</para>
                   <para>If is set, there will go all messages. Default: empty.</para>
                   <para>Example: <prompt>debug_uin = 7654321</prompt></para>
               </listitem>
              </itemizedlist>
              </sect3>
          </sect2>
          <sect2 id="daemon-cutoff" xreflabel="cutoff">
          <title>Cutoff</title>
              <sect3 id="cutoff-desc">
              <title>Description</title>
              <para>Cutoff do change nodes status to 'disconnected' and/or enable warnings
              for customers, which have debts at an account greater than specified limit.
              This module do not blocking network access.</para>
              </sect3>
              <sect3 id="cutoff-config">
              <title>Configuration</title>
              <para>For module 'cutoff' we have following options:</para>
              <itemizedlist>
               <listitem>
                   <para>limit</para>
                   <para>Disconnection ensue if customer balance will decrease below
                   specified value. Default: 0.</para>
                   <para>Example: <prompt>limit = -20</prompt></para>
               </listitem>
               <listitem>
                   <para>command</para>
                   <para>Specify system command, wich will be executed if at least one
                   customer will be disconnected or warning will be enabled. 
                   Default: empty.</para>
                   <para>Example: <prompt>command = 'almsd -qi firewall'</prompt></para>
               </listitem>
               <listitem>
                   <para>warning</para>
                   <para>Enable warning for disconnected customer and write specified 
                   by this option message. If empty, warning will be not enabled.
                   Date in message is hidden in '%time' variable.
                   Default: 'Automatyczna blokada spowodowana przekroczeniem terminu wp³aty (dd.mm.yyyy)".</para>
                   <para>Example: <prompt>warning = ""</prompt></para>
               </listitem>
               <listitem>
                   <para>warnings_only</para>
                   <para>Here you can to decide, if you want to use this module
                   only for warnings enabling. Default: false.</para>
                   <para>Example: <prompt>warnings_only = true</prompt></para>
               </listitem>
              </itemizedlist>
              </sect3>
          </sect2>
          <sect2 id="daemon-dhcp" xreflabel="dhcp">
          <title>Dhcp</title>
              <sect3 id="dhcp-desc">
              <title>Description</title>
              <para>Module for management of DHCP server, creates configuration file
              and restarts service. Option 'command' make possible execution of other 
              functions (programs).</para>
              </sect3>
              <sect3 id="dhcp-config">
              <title>Configuration</title>
              <para>Most of configuration parameters match with parts of 
              dhcpd configuration file, which in typical purposes do not need
              change:</para>
              <itemizedlist>
               <listitem>
                   <para>file</para>
                   <para>Specify location of dhcp server configuration file. 
                   Default: /etc/dhcpd.conf.</para>
                   <para>Example: <prompt>file = /etc/dhcp/dhcpd.conf</prompt></para>
               </listitem>
               <listitem>
                   <para>command</para>
                   <para>Shell command executed after file generation. 
                   Default: 'killall dhcpd; /usr/sbin/dhcpd'.</para>
                   <para>Example: <prompt>command = '/etc/rc.d/rc.dhcpd restart'</prompt></para>
               </listitem>
               <listitem>
                   <para>begin</para>
                   <para>File header. Default: "shared-network LMS {".</para>
                   <para>Example: <prompt>begin = "shared-network LMS {"</prompt></para>
               </listitem>
               <listitem>
                   <para>end</para>
                   <para>File footer. Default: "}".</para>
                   <para>Example: <prompt>end = "\n}"</prompt></para>
               </listitem>
               <listitem>
                   <para>subnet_start</para>
                   <para>Subnet header. '%a' - name, '%m' - mask. Default: "subnet %a netmask %m {\ndefault-lease-time 86400;\nmax-lease-time 86400;".</para>
                   <para>Example: <prompt>subnet_start = "subnet %a netmask %m {default-lease-time 3600;"</prompt></para>
               </listitem>
               <listitem>
                   <para>subnet_end</para>
                   <para>Subnet footer. Default: "}".</para>
                   <para>Example: <prompt>subnet_end = '\t}'</prompt></para>
               </listitem>
               <listitem>
                   <para>subnet_gateway</para>
                   <para>Subnet gateway. '%i' will be changed to ip address. Default: 'option routers %i;'.</para>
                   <para>Example: <prompt>subnet_gateway = "option routers %i"</prompt></para>
               </listitem>
               <listitem>
                   <para>subnet_dns</para>
                   <para>Subnet DNS servers. '%i - dns addresses. Default: "option domain-name-servers %i;".</para>
                   <para>Example: <prompt>subnet_dns = "option domain-name-servers 192.168.0.1"</prompt></para>
               </listitem>
               <listitem>
                   <para>subnet_domain</para>
                   <para>Subnet domain name. '%n' - name. Default: "option domain-name %n;".</para>
                   <para>Example: <prompt>subnet_domain = "option domain-name test.%n;"</prompt></para>
               </listitem>
               <listitem>
                   <para>subnet_wins</para>
                   <para>WINS servers. '%i' - server IP address. Default: "option netbios-name-servers %i;".</para>
                   <para>Example: <prompt>subnet_wins = ""</prompt></para>
               </listitem>
               <listitem>
                   <para>subnet_range</para>
                   <para>Subnet address range. '%s' - initial address, '%e' - end of range. Default: "range %s %e;".</para>
                   <para>Example: <prompt>subnet_range = "range %s %e;"</prompt></para>
               </listitem>
               <listitem>
                   <para>host</para>
                   <para>Hosts parameters, where '%n' - host name, '%m' - MAC, '%i' - IP address. 
                   Default: "\thost %n {\n\t\thardware ethernet %m; fixed-address %i; \n\t}".</para>
                   <para>Example: <prompt>host = "host %n {hardware ethernet %m; fixed-address %i;}"</prompt></para>
               </listitem>
               <listitem>
                   <para>networks</para>
                   <para>List of network names to take into consideration. Letters size is not important.
                   Default: empty (all networks).</para>
                   <para>Example: <prompt>networks = "lan1 lan2"</prompt></para>
               </listitem>
               <listitem>
                   <para>usergroups</para>
                   <para>List of customers groups to take into consideration. Letters size is not important.
                   Default: empty (all groups).</para>
                   <para>Example: <prompt>usergroups = "group1 group2"</prompt></para>
               </listitem>
              </itemizedlist>
              </sect3>
          </sect2>
          <sect2 id="daemon-hostfile" xreflabel="hostfile">
          <title>Hostfile</title>
              <sect3 id="hostfile-desc">
              <title>Description</title>
              <para>Module 'hostfile' is a rather multipurposed tool. It performs 
              loop on all hosts from database distingue status of them
              (connected/diconnected), network for which are they connected and
              groups of they owners. Because of that it is possible to create e.g. any
              firewall rules, or file /etc/hosts. Data are writed to file 
              and after that is executed specified shell command.</para>
              </sect3>
              <sect3 id="hostfile-config">
              <title>Configuration</title>
              <para>In 'grantedhost' and 'deniedhost' options can be used special sequences,
              which during write to file will be replaced by '%i' - IP address, '%m' - MAC
              address, '%n' - host name, '%p' - password, '%info' - node description, '%domain' - domain, 
              '%net' - net name, '%gw' - gateway address of network for which belongs given node.
              This module has following options:</para>
              <itemizedlist>
               <listitem>
                   <para>file</para>
                   <para>Location of generated file. Default: /tmp/hostfile</para>
                   <para>Example: <prompt>file = /etc/rc.d/rc.firewall</prompt></para>
               </listitem>
               <listitem>
                   <para>command</para>
                   <para>Shell command(s) executed after 'file' generation. Default: empty</para>
                   <para>Example: <prompt>command = '/bin/sh /etc/rc.d/rc.firewall'</prompt></para>
               </listitem>
               <listitem>
                   <para>begin</para>
                   <para>File header. Default: "/usr/sbin/iptables -F FORWARD\n"</para>
                   <para>Example: <prompt>begin = "IPT=/usr/sbin/iptables \n$IPT -F FORWARD\n"</prompt></para>
               </listitem>
               <listitem>
                   <para>end</para>
                   <para>File footer. Default: "/usr/sbin/iptables -A FORWARD -J REJECT\n"</para>
                   <para>Example: <prompt>end = "$IPT -A FORWARD -J REJECT\n"</prompt></para>
               </listitem>
               <listitem>
                   <para>grantedhost</para>
                   <para>Text of rule for connected node. Default: "/usr/sbin/iptables -A FORWARD -s %i -m mac --mac-source %m -j ACCEPT\n"</para>
                   <para>Example: <prompt>grantedhost = "$IPT -A FORWARD -s %i -m mac --mac-source %m -j ACCEPT\n"</prompt></para>
               </listitem>
               <listitem>
                   <para>deniedhost</para>
                   <para>Text of rule for disconnected node. Default: "/usr/sbin/iptables -A FORWARD -s %i -m mac --mac-source %m -j REJECT\n"</para>
                   <para>Example: <prompt>deniedhost = "$IPT -A FORWARD -s %i -m mac --mac-source %m -j REJECT\n"</prompt></para>
               </listitem>
               <listitem>
                   <para>networks</para>
                   <para>List of network names for consideration. Letters size doesn't matter.
                   Default: empty (all networks).</para>
                   <para>Example: <prompt>networks = "lan1 lan2"</prompt></para>
               </listitem>
               <listitem>
                   <para>usergroups</para>
                   <para>List of customers groups names for consideration. Letters size doesn't matter. 
                   Default: empty (all groups).</para>
                   <para>Example: <prompt>usergroups = "grupa1 grupa2"</prompt></para>
               </listitem>
               <listitem>
                   <para>skip_dev_ips</para>
                   <para>If enabled (yes, true) addresses of network devices will be ignored (omitted). Default: yes</para>
                   <para>Example: <prompt>skip_dev_ips = no</prompt></para>
               </listitem>
              </itemizedlist>
              </sect3>
          </sect2>         
          <sect2 id="daemon-traffic" xreflabel="traffic">
          <title>Traffic</title>
              <sect3 id="traffic-desc">
              <title>Description</title>
              <para>'Traffic' is an equivalent of perl's script lms-traffic, load to 
	      database internet link stats from file created by user. That file must
	      have format: host_IP upload download. More informations (including how to make 
	      such file) can be found in chapter with lms-traffic description.</para>
              </sect3>
              <sect3 id="traffic-config">
              <title>Configuration</title>
              <para>Only one available option is also mandatory:</para>
              <itemizedlist>
               <listitem>
                   <para>file</para>
                   <para>Location of file with firewall stats. Default: /var/log/traffic.log</para>
                   <para>Example: <prompt>file = /tmp/log</prompt></para>
               </listitem>
              </itemizedlist>
              </sect3>
          </sect2>
          <sect2 id="daemon-tc" xreflabel="tc">
          <title>Tc (HTB)</title>
              <sect3 id="tc-desc">
              <title>Description</title>
              <para>Generate script containing iptables and tc rules for traffic control
              i.e. band and customer connections limiting. Rules for nodes can be freely
              defined and used not only for traffic control. Principle of operation of this 
	      module is following: First of all are retrived data of all customers.
              Accounted are totals of limitations (uprate, downrate, upceil, downceil, connection limit) 
	      for each customer. Then is performed loop with checking of networks and groups
	      (if specified). If limit values are not zeroes rules are writed to file with
              variables replacement. In rules can be used following variables:
              %name - host name, %i - IP address, %m - MAC, %uprate, %downrate, %upceil, 
              %downceil, %plimit, %climit, and %x - counter with initial value 100 incremented 
              by one for each node.</para>
              <para>Default policy of htb class creating assume one class for
              all nodes of each customer. In can be changed with 
              'one_class_per_host' option.</para>
              <para>Default configuration assume that your system supports
	      htb and iptables with modules limit, connlimit, mark and ipp2p.
              You can patch kernel or use sources available at polish project
              <ulink url="http://www.inet.one.pl">www.inet.one.pl</ulink>.</para>
              </sect3>
              <sect3 id="tc-config">
              <title>Configuration</title>
              <para>For your disposal we have basic options like groups of customers, 
	      file, command, networks and extra options which are define tc and firewall
	      rules.
              Default config is designed for 512/128 kbit and 100mbit links.</para>
              <para><note><para>Values of configuration options in <filename>lms.ini</filename>
              must be putted in one line. In case of that module it can be not very handy,
              so you can create file containing whole header (option <filename>
              begin</filename>), and then use option <filename>command</filename> for
              join with the rest of file generated by this module.</para></note></para>
              <itemizedlist>
               <listitem>
                   <para>file</para>
                   <para>Location of file. Default: /etc/rc.d/rc.htb.</para>
                   <para>Example: <prompt>file = /tmp/rc.htb</prompt></para>
               </listitem>
               <listitem>
                   <para>command</para>
                   <para>Shell command executed after file creation. Default: "sh /etc/rc.d/rc.htb start".</para>
                   <para>Example: <prompt>command = "chmod 700 /tmp/rc.htb; /tmp/rc.htb start"</prompt></para>
               </listitem>
               <listitem>
                   <para>begin</para>
                   <para>Script header. Default:
<screen>
"#!/bin/sh
IPT=/usr/sbin/iptables
TC=/sbin/tc
LAN=eth0
WAN=eth1
BURST="burst 30k"

stop ()
{
$IPT -t mangle -D FORWARD -i $WAN -j LIMITS >/dev/null 2>&1
$IPT -t mangle -D FORWARD -o $WAN -j LIMITS >/dev/null 2>&1
$IPT -t mangle -F LIMITS >/dev/null 2>&1
$IPT -t mangle -X LIMITS >/dev/null 2>&1
$IPT -t mangle -F OUTPUT
$IPT -t filter -F FORWARD
$TC qdisc del dev $LAN root 2> /dev/null
$TC qdisc del dev $WAN root 2> /dev/null
}

start ()
{
stop
$IPT -t mangle -N LIMITS
$IPT -t mangle -I FORWARD -i $WAN -j LIMITS
$IPT -t mangle -I FORWARD -o $WAN -j LIMITS
# incomming traffic
$IPT -t mangle -A OUTPUT -j MARK --set-mark 1
$TC qdisc add dev $LAN root handle 1:0 htb default 3 r2q 1
$TC class add dev $LAN parent 1:0 classid 1:1 htb rate 99000kbit ceil 99000kbit quantum 1500
$TC class add dev $LAN parent 1:1 classid 1:2 htb rate   500kbit ceil   500kbit
$TC class add dev $LAN parent 1:1 classid 1:3 htb rate 98500kbit ceil 98500kbit prio 9 quantum 1500
$TC qdisc add dev $LAN parent 1:3 esfq perturb 10 hash dst
# priorities for ICMP, TOS 0x10 and ports 22 and 53
$TC class add dev $LAN parent 1:2 classid 1:20 htb rate 50kbit ceil 500kbit $BURST prio 1 quantum 1500
$TC qdisc add dev $LAN parent 1:20 esfq perturb 10 hash dst
$TC filter add dev $LAN parent 1:0 protocol ip prio 2 u32 match ip sport 22 0xffff flowid 1:20
$TC filter add dev $LAN parent 1:0 protocol ip prio 2 u32 match ip sport 53 0xffff flowid 1:20
$TC filter add dev $LAN parent 1:0 protocol ip prio 1 u32 match ip tos 0x10 0xff flowid 1:20
$TC filter add dev $LAN parent 1:0 protocol ip prio 1 u32 match ip protocol 1 0xff flowid 1:20
# server -> LAN
$TC filter add dev $LAN parent 1:0 protocol ip prio 4 handle 1 fw flowid 1:3

# outgoing traffic
$TC qdisc add dev $WAN root handle 2:0 htb default 11 r2q 1
$TC class add dev $WAN parent 2:0 classid 2:1 htb rate 120kbit ceil 120kbit
# priorities for ACK, ICMP, TOS 0x10, ports 22 and 53
$TC class add dev $WAN parent 2:1 classid 2:10 htb rate 60kbit ceil 120kbit prio 1 quantum 1500
$TC qdisc add dev $WAN parent 2:10 esfq perturb 10 hash dst
$TC filter add dev $WAN parent 2:0 protocol ip prio 1 u32 match ip protocol 6 0xff \
match u8 0x05 0x0f at 0 match u16 0x0000 0xffc0 at 1 match u8 0x10 0xff at 33 flowid 2:10
$TC filter add dev $WAN parent 2:0 protocol ip prio 1 u32 match ip dport 22 0xffff flowid 2:10
$TC filter add dev $WAN parent 2:0 protocol ip prio 1 u32 match ip dport 53 0xffff flowid 2:10
$TC filter add dev $WAN parent 2:0 protocol ip prio 1 u32 match ip tos 0x10 0xff flowid 2:10
$TC filter add dev $WAN parent 2:0 protocol ip prio 1 u32 match ip protocol 1 0xff flowid 2:10
# server -> Internet
$TC class add dev $WAN parent 2:1 classid 2:11 htb rate 30kbit ceil 120kbit prio 2 quantum 1500
$TC qdisc add dev $WAN parent 2:11 esfq perturb 10 hash dst
$TC filter add dev $WAN parent 2:0 protocol ip prio 3 handle 1 fw flowid 2:11
$TC filter add dev $WAN parent 2:0 protocol ip prio 9 u32 match ip dst 0/0 flowid 2:11
</screen></para>
                   <para>Example: <prompt>begin = "#!/bin/bash\n$TC=/usr/local/sbin/tc\n"</prompt></para>
               </listitem>    
               <listitem>
                   <para>end</para>
                   <para>Script footer. Default:
<screen>
}

case "$1" in
    'start')
     start
    ;;
    'stop')
     stop
    ;;
    'status')
     echo "WAN Interface"
     echo "============="
     $TC class show dev $WAN | grep root
     $TC class show dev $WAN | grep -v root | sort | nl
     echo "LAN Interface"
     echo "============="
     $TC class show dev $LAN | grep root
     $TC class show dev $LAN | grep -v root | sort | nl
    ;;
    *)
     echo -e "\nUsage: rc.htb start|stop|status"
    ;;
esac
</screen>
                   </para>
                   <para>Example: <prompt>end = ""</prompt></para>
               </listitem>
               <listitem>
                   <para>one_class_per_host</para>
                   <para>Specify policy of htb class creation. In default setting
                   all computers of customer will be placed in one class.
                   Setting it on 'true' will made that rules specified in  
                   host_htb_up and host_htb_down will be generated for all
                   customer's computers (with different value of '%x'). Rules host_mark_down,
                   host_mark_up, host_plimit and host_climit are generated for each
                   node regardless of this option setting. Default: false</para>
                   <para>Example: <prompt>one_class_per_host = 1</prompt></para>
               </listitem>
               <listitem>
                   <para>host_mark_down</para>
                   <para>Mark rule for each computer. Default:
<screen>
# %n
$IPT -t mangle -A LIMITS -d %i -j MARK --set-mark %x
</screen>
                   </para>
                   <para>Example: <prompt>host_mark_down = ""</prompt></para>
               </listitem>
               <listitem>
                   <para>host_mark_up</para>
                   <para>Mark rule for each computer. Default:
<screen>
$IPT -t mangle -A LIMITS -s %i -j MARK --set-mark %x
</screen>
                   </para>
                   <para>Example: <prompt>host_mark_up = ""</prompt></para>
               </listitem>
               <listitem>
                   <para>host_htb_down</para>
                   <para>Rules for each computer executed when uprate and downrate 
		   are not zeroes. Default:
<screen>
$TC class add dev $LAN parent 1:2 classid 1:%x htb rate %downratekbit ceil %downceilkbit $BURST prio 2 quantum 1500
$TC qdisc add dev $LAN parent 1:%x esfq perturb 10 hash dst
$TC filter add dev $LAN parent 1:0 protocol ip prio 5 handle %x fw flowid 1:%x
</screen>
                   </para>
                   <para>Example: <prompt>host_htb_down = ""</prompt></para>
               </listitem>
               <listitem>
                   <para>host_htb_up</para>
                   <para>Rules for each computer executed when uprate and downrate 
		   are not zeroes. Default:
<screen>
$TC class add dev $WAN parent 2:1 classid 2:%x htb rate %upratekbit ceil %upceilkbit $BURST prio 2 quantum 1500
$TC qdisc add dev $WAN parent 2:%x esfq perturb 10 hash dst
$TC filter add dev $WAN parent 2:0 protocol ip prio 5 handle %x fw flowid 2:%x
</screen>
                   </para>
                   <para>Example: <prompt>host_htb_up = ""</prompt></para>
               </listitem>
               <listitem>
                   <para>host_climit</para>
                   <para>Rule with simultaneous tcp connections limit. Executed
                   when climit in not a zero. Default:
<screen>
$IPT -t filter -I FORWARD -p tcp -s %i -m connlimit --connlimit-above %climit -m ipp2p --ipp2p -j REJECT
</screen>
                   </para>
                   <para>Example: <prompt>host_climit = "$IPT -t filter -I FORWARD -p tcp -s %i -m connlimit --connlimit-above -j REJECT"</prompt></para>
               </listitem>
               <listitem>
                   <para>host_plimit</para>
                   <para>Rule with limiting of packets in time unit (here second). Executed
                   when plimit is not a zero. Default:
<screen>
$IPT -t filter -I FORWARD -p tcp -d %i -m limit --limit %plimit/s -m ipp2p --ipp2p -j ACCEPT
$IPT -t filter -I FORWARD -p tcp -s %i -m limit --limit %plimit/s -m ipp2p --ipp2p -j ACCEPT
</screen>
                   </para>
                   <para>Example: <prompt>host_plimit = ""</prompt></para>
               </listitem>
               <listitem>
                   <para>networks</para>
                   <para>List of network names for consideration. Case insensitive.
                   Default: empty (all networks).</para>
                   <para>Example: <prompt>networks = "lan1 lan2"</prompt></para>
               </listitem>
               <listitem>
                   <para>usergroups</para>
                   <para>List of customer groups for consideration. Case insensitive. 
                   Default: empty (all groups).</para>
                   <para>Example: <prompt>usergroups = "grupa1 grupa2"</prompt></para>
               </listitem>
              </itemizedlist>
              </sect3>
          </sect2>
          <sect2 id="daemon-dns" xreflabel="dns">
          <title>Dns</title>
              <sect3 id="dns-desc">
              <title>Description</title>
              <para>Configuration of named zones. This is a one from most complicated modules.
              Create zone files for each network and equivalent entries in named.conf on the
              basis of templates of this files. Example templates are placed in
              <filename>/modules/dns/sample</filename> directory.</para>
              </sect3>
              <sect3 id="dns-config">
              <title>Configuration</title>
              <para></para>
              <itemizedlist>
               <listitem>
                   <para>forward-patterns</para>
                   <para>Directory with zone templates. Default: forward.</para>
                   <para>Example: <prompt>forward-patterns = /dns/patterns/forward</prompt></para>
               </listitem>
               <listitem>
                   <para>reverse-patterns</para>
                   <para>Directory with reverse zone templates. Default: reverse.</para>
                   <para>Example: <prompt>reverse-patterns = /dns/patterns/revers</prompt></para>
               </listitem>
               <listitem>
                   <para>generic-forward</para>
                   <para>Default template. It'll be used if in directory specified by
                   'forward-patterns' will not found file with name corresponding to network domain name.
                   Default: modules/dns/sample/forward/generic.</para>
                   <para>Example: <prompt>generic-forward = /dns/patterns/forward</prompt></para>
               </listitem>
               <listitem>
                   <para>generic-reverse</para>
                   <para>Default template. It'll be used if in directory specified by
                   'reverse-patterns' will not found file with name corresponding to network IP address.
                   Default: modules/dns/sample/reverse/generic.</para>
                   <para>Example: <prompt>generic-reverse = /dns/patterns/forward</prompt></para>
               </listitem>
               <listitem>
                   <para>forward-zones</para>
                   <para>Directory for generated zones files.
                   Default: modules/dns/sample/out/forward.</para>
                   <para>Example: <prompt>forward-zones = /dns/forward</prompt></para>
               </listitem>
               <listitem>
                   <para>reverse-zones</para>
                   <para>Directory for generated reverse zones files.
                   Default: modules/dns/sample/out/reverse.</para>
                   <para>Example: <prompt>reverse-zones = /dns/reverse</prompt></para>
               </listitem>
               <listitem>
                   <para>host-reverse</para>
                   <para>Line in reverse zone file for each computer of given network.
                   Default: "%n IN A %i\n".</para>
                   <para>Example: <prompt>host-reverse = "\t %n IN A %i\n"</prompt></para>
               </listitem>
               <listitem>
                   <para>host-forward</para>
                   <para>Line in zone file for each computer of given network.
                   Default: "%c IN PTR %n.%d.\n".</para>
                   <para>Example: <prompt>host-forward = "\t %c IN PTR %n.%d.\n"</prompt></para>
               </listitem>
               <listitem>
                   <para>conf-pattern</para>
                   <para>Location of main template of server configuration file.
                   Default: modules/dns/sample/named.conf.</para>
                   <para>Example: <prompt>conf-pattern = /dns/patterns/named.conf</prompt></para>
               </listitem>
               <listitem>
                   <para>conf-output</para>
                   <para>Location of main configuration file.
                   Default: /tmp/named.conf.</para>
                   <para>Example: <prompt>conf-output = /etc/named.conf</prompt></para>
               </listitem>
               <listitem>
                   <para>conf-forward-entry</para>
                   <para>Entry for each zone in main configuration file.
		   Default: 'zone "%n" {\ntype master;\n file "forward/%n"; \nnotify yes; \n}; \n'.</para>
                   <para>Example: <prompt>conf-forward-entry = 'zone "%n" { \n\ttype master; \n\tfile "forward/%n"; \n\tnotify yes; \n}; \n'</prompt></para>
               </listitem>
               <listitem>
                   <para>conf-reverse-entry</para>
                   <para>Entry for each reverse zone in main configuration file.
                   Default: 'zone "%c.in-addr.arpa" { \ntype master; \nfile "reverse/%i"; \nnotify yes; \n}; \n'.</para>
                   <para>Example: <prompt>conf-revers-entry = 'zone "%c.in-addr.arpa" { \n\ttype master; \n\tfile "reverse/%i"; \n\tnotify yes; \n}; \n'</prompt></para>
               </listitem>
               <listitem>
                   <para>command</para>
                   <para>Shell command executed after creation of files. Default: empty.</para>
                   <para>Example: <prompt>command = "killall -HUP named"</prompt></para>
               </listitem>
               <listitem>
                   <para>networks</para>
                   <para>List of network names for consideration. Case insensitive.
                   Default: empty (all networks).</para>
                   <para>Example: <prompt>networks = "lan1 lan2"</prompt></para>
               </listitem>
               <listitem>
                   <para>usergroups</para>
                   <para>List of customer (user) groups for consideration. Case insensitive. 
                   Default: empty (all groups).</para>
                   <para>Example: <prompt>usergroups = "grupa1 grupa2"</prompt></para>
               </listitem>
              </itemizedlist>
              </sect3>
          </sect2>
          <sect2 id="daemon-ethers" xreflabel="ethers">
          <title>Ethers</title>
              <sect3 id="ethers-desc">
              <title>Description</title>
              <para>This module creates configuration of system ARP table. Setting option
              'dummy_macs' you can make that all disconnected computers will have 
              mac address 00:00:00:00:00:00.</para>
              </sect3>
              <sect3 id="ethers-config">
              <title>Configuration</title>
              <para>Basic options:</para>
              <itemizedlist>
               <listitem>
                   <para>file</para>
                   <para>Location of output file. Default: /etc/ethers.</para>
                   <para>Example: <prompt>file = /tmp/ethers</prompt></para>
               </listitem>
               <listitem>
                   <para>command</para>
                   <para>Shell command to execute after config creation. Default: 'erp -f /etc/ethers'.</para>
                   <para>Example: <prompt>command = ""</prompt></para>
               </listitem>
               <listitem>
                   <para>dummy_macs</para>
                   <para>If you set to 'yes', disconnected computers will get
                   MAC '00:00:00:00:00:00'. Default: "no".</para>
                   <para>Example: <prompt>dummy_macs = yes</prompt></para>
               </listitem>
               <listitem>
                   <para>networks</para>
                   <para>List of network names for consideration. Letters size doesn't matter.
                   Default: empty (all networks).</para>
                   <para>Example: <prompt>networks = "lan1 lan2"</prompt></para>
               </listitem>
               <listitem>
                   <para>usergroups</para>
                   <para>List of customer groups names for consideration. Letter size doesn't matter. 
                   Default: empty (all groups).</para>
                   <para>Example: <prompt>usergroups = "grupa1 grupa2"</prompt></para>
               </listitem>
              </itemizedlist>
              </sect3>
          </sect2>
          <sect2 id="daemon-oident" xreflabel="oident">
          <title>Oident</title>
              <sect3 id="oident-desc">
              <title>Description</title>
              <para>Module for oidentd configuration. Basically it can be made
              with hostfile module, but here you have ready-made default settings
	      for that purpose.</para>
              </sect3>
              <sect3 id="oident-config">
              <title>Configuration</title>
              <para>And here are the options of oident:</para>
              <itemizedlist>
               <listitem>
                   <para>begin</para>
                   <para>Text inserted on the beginning of file. Default: empty.</para>
                   <para>Example: <prompt>begin = "#Auto-generated\n"</prompt></para>
               </listitem>
               <listitem>
                   <para>end</para>
                   <para>Text inserted on the end of file. Default: empty.</para>
                   <para>Example: <prompt>end = ""</prompt></para>
               </listitem>
               <listitem>
                   <para>host</para>
                   <para>Line of text for each of computers. Default: "%i\t%n\tUNIX".</para>
                   <para>Example: <prompt>host = "%i %n WINDOWS"</prompt></para>
               </listitem>
               <listitem>
                   <para>file</para>
                   <para>Configuration file. Default: /etc/oidentd.conf.</para>
                   <para>Example: <prompt>file = /tmp/identd.conf</prompt></para>
               </listitem>
               <listitem>
                   <para>networks</para>
                   <para>List of networks. Default: empty (all networks).</para>
                   <para>Example: <prompt>networks = 'lan1 lan2'</prompt></para>
               </listitem>
               <listitem>
                   <para>command</para>
                   <para>Shell command(s) to execute after file creation. Default: empty.</para>
                   <para>Example: <prompt>command = "killall -HUP oidentd"</prompt></para>
               </listitem>
              </itemizedlist>
              </sect3>
          </sect2>
          <sect2 id="daemon-pinger" xreflabel="pinger">
          <title>Pinger</title>
              <sect3 id="pinger-desc">
              <title>Description</title>
              <para>Module pinger it's an equivalent to perl's script lms-fping. However differences
              are fundamental. It not need external program and work with use of
              ARP protocol. It follows more or less twice faster execution of 
              network scanning. Also there are not problems with hosts wich have disabled
              ping responsing. After scanning, for all online hosts in database is set
              time of scanning, used to illustrate hosts activity e.g. on network 
	      map.</para>
              </sect3>
              <sect3 id="pinger-config">
              <title>Configuration</title>
              <para>Pinger has only one config option:</para>
              <itemizedlist>
               <listitem>
                   <para>networks</para>
                   <para>List of network names. Default: empty (all networks).</para>
                   <para>Example: <prompt>networks = 'lan1 lan2'</prompt></para>
               </listitem>
              </itemizedlist>
              </sect3>
          </sect2>
     </sect1>
</chapter>

    