<!-- $Id$ -->
<chapter id="daemon">
	<title>A.L.E.C's LMS Daemon</title>
	<sect1 id="daemon-intro">
	<title>Informacje podstawowe</title>
	<para>Napisany w jêzyku C program ma u³atwiaæ zarz±dzanie us³ugami. Sam demon odpowiada
    	za uruchamianie odpowiednich modu³ów na ¿±danie u¿ytkownika. Modu³y
    	natomiast, s³u¿± do tworzenia plików konfiguracyjnych na podstawie 
    	danych z bazy LMS'a oraz restartowania odpowiednich us³ug na serwerze.
    	</para>
	<para>Dlaczego taka nazwa? Wiêkszo¶æ kodu demona napisa³ jeden z developerów - Aleksander 
	'A.L.E.C' Machniak, niemniej nale¿y tak¿e podkre¶liæ udzia³ Marcina 'Lexx' Króla. Program zawiera
	fragmenty kodu autorstwa Mateusza 'mteg' Golicza oraz korzysta z biblioteki
	iniparser Nicolasa Devillarda. Je¶li Ty masz ochotê napisaæ jaki¶ modu³ lub poprawiæ 
	funkcjonalno¶æ demona jak najbardziej do tego zachêcam.
	</para>
		<sect2 id="daemon-requirements">
		<title>Wymagania</title>
			<para><emphasis>A.L.E.C's LMS Daemon</emphasis> potrzebuje:
      			<itemizedlist>
			<listitem>
				<para>instalacji interfejsu u¿ytkownika <emphasis>LMS-UI</emphasis></para>
			</listitem>
			<listitem>
				<para><filename>libmysqlclient</filename> (tj. pe³nej instalacji MySQL'a lub odpowiedniego 
				pakietu) lub <filename>libpq</filename> w przypadku bazy PostgreSQL</para>
      			</listitem>
			<listitem>
				<para><filename>libdl</filename> (to w ka¿dej dzisiejszej dystrybucji jest)</para>
			</listitem>
			<listitem>
				<para>kompilatora jêzyka C </para>
			</listitem>
			</itemizedlist>
      			</para>
		</sect2>
		<sect2 id="daemon-install">
		<title>Instalacja</title>
			<para>Przed kompilacj± nale¿y przy pomocy skryptu <filename>./configure</filename>
			ustaliæ opcje przedstawione na poni¿szym listingu (w nawiasach podano
			warto¶ci domy¶lne opcji):
<screen>
  --help                pomoc
  --enable-debug0       logowanie zapytañ SQL (wy³±czone)
  --enable-debug1       logowanie zdarzeñ (wy³±czone)
  --with-pgsql          gdy korzystamy z bazy PostgreSQL (wy³±czone)
  --with-mysql          gdy korzystamy z bazy MySQL (w³±czone)
  --prefix=DIR          katalog instalacyjny demona (/usr/local/bin)
  --libdir=DIR          lokalizacja bibliotek bazy danych (/usr/lib)
  --incdir=DIR          lokalizacja plików nag³ówkowych bazy danych (/usr/include)
</screen>
			Zatem wymagane jest okre¶lenie bazy z jakiej bêdziemy korzystaæ (-with-mysql 
			lub -with-pgsql) oraz po³o¿enia bibliotek dostarczanych wraz z baz± (--incdir, --libdir).
<screen>
# ./configure --with-pgsql --libdir=/usr/local/pgsql/lib --incdir=/usr/local/pgsql/include
</screen>
    			Nastêpnie kompilacja i instalacja (umieszczenie demona w katalogu
			okre¶lonym zmienn± --prefix):
<screen>
# make && make install
</screen>
			Na koniec skompilowane modu³y (pliki z rozszerzeniem <filename>.so</filename>),
			znajduj±ce siê w katalogu <filename>modules/nazwa_modu³u</filename> przenie¶ 
			do dowolnego katalogu. Ich lokalizacjê bêdziesz okre¶la³ w pliku konfiguracyjnym.
			</para>
		</sect2>
		<sect2 id="daemon-config">
		<title>Konfiguracja</title>
			<para>Na pocz±tku nale¿y w pliku konfiguracyjnym <emphasis>LMS-UI</emphasis>
			(standardowo <filename>/etc/lms/lms.ini</filename>) ustawiæ typ reloadu 
			obs³ugiwany przez demona:
<screen>
reload_type	= sql
reload_sqlquery	= "INSERT INTO reload VALUES('reload')"
</screen>
			<note><para>Struktura tabeli 'reload' jest dowolna, zatem musisz zadbaæ 
			o odpowiedni insert.</para></note>
			</para>
			<para>Przyk³adowy konfig demona i modu³ów zawarto w pliku <filename>lms.ini.sample</filename>.
			Poni¿szy listing przedstawia podstawowe opcje dla demona (konfiguracjê modu³ów omówiono w 
			osobnych rozdzia³ach ich dotycz±cych):
<screen>
[database]
host            = localhost     # nazwa lub ip hosta, domy¶lnie: localhost
user            = lms           # nazwa u¿ytkownika, domy¶lnie: lms
password        = mypasswd      # has³o do bazy, domy¶lnie: puste
database        = lms           # nazwa bazy, domy¶lnie: lms
port            = 0             # numer portu, domy¶lnie: 0

[lmsd]
sleeptime       = 30            # okre¶la odstêp czasu (w sekundach) jak czêsto ma 
                                # ma byæ sprawdzana tabela 'reload', domy¶lnie: 30
instances       = hosts oident firewall       # lista instancji modu³ów
</screen>
			<note><para>Lista instancji sk³ada siê z nazw instancji oddzielonych 
			spacj±. Instancja to nazwa sekcji w pliku konfiguracyjnym.</para></note>
			</para>
			<para>W sekcji dotycz±cej instancji, oprócz parametrów konfiguracji
			modu³ów, umieszcza siê opcje podstawowe, jak na poni¿szym listingu:
<screen>
[nazwa_instancji]
module = /¶cie¿ka/nazwa_modu³u.so
info = "Opcjonalny opis modu³u"
</screen>		
			</para>
		</sect2>
		<sect2 id="daemon-run">
		<title>Uruchomienie</title>
			<para>Program mo¿esz uruchamiaæ jako demona pracuj±cego w tle (opcja '-b'). Wtedy 
			prze³adowanie konfiguracji i us³ug jest dokonywane na ¿±danie, przez wpis do tabeli 
			'reload'. Opcja 'sleeptime' (-s) okre¶la okres miêdzy
			odczytami tej tabeli. Gdy do tabeli 'reload' zostan± zapisane dowolne dane 
			(przy pomocy menu 'Prze³adowanie' w <emphasis>LMS-UI</emphasis>)
			demon wykona modu³y okre¶lone opcj± 'instances' z <filename>lms.ini</filename>.
			Na przyk³ad:
<screen>
# almsd -b
</screen>			
			</para>
			<para>Innym sposobem uruchomienia jest jednorazowy reload w wykorzystaniem
			crona. Z tego sposobu nale¿y korzystaæ uruchamiaj±c modu³y takie jak 'payments'
			'notify' 'traffic'. W tym wypadku musisz stworzyæ osobny plik konfiguracyjny 
			dla ka¿dego modu³u (zawieraj±cy równie¿ opcje dla demona) i podaæ go demonowi
			przy pomocy opcji '-c'. Przyk³adowy wpis do crontab'a wygl±da nastêpuj±co:
<screen>
  1 0 * * *    /usr/local/bin/almsd -q -c /etc/lms/payments.lms.ini
</screen>
			</para>
			<para>Poni¿szy listing przedstawia dostêpne opcje linii poleceñ programu:
<screen>
  -c	¶cie¿ka do pliku konfiguracyjnego (domy¶lnie: /etc/lms/lms.ini)
  -b	uruchomienie w tle
  -s	czas w sek. miêdzy odczytami tabeli 'reload' (domy¶lnie: 30)
  -q 	wykonaj reload i zakoñcz
  -h 	wy¶wietla opcje linii poleceñ
</screen>
			</para>
		</sect2>
	</sect1>
	<sect1 id="daemon-modules">
	<title>Modu³y</title>
	<para>Sam demon potrafi tylko uruchamiaæ modu³y i to one odwalaj± ca³± robotê. 
	Wiêkszo¶æ modu³ów jest przeznaczona do okre¶lonego zastosowania, jedynie 'hostfile' 
	mo¿na u¿ywaæ do ró¿nych konfigów (us³ug), np. ró¿nych typów firewalli. Przyk³ady 
	konfiguracji demona i modu³ów zawiera plik <filename>daemon/lms.ini.sample</filename>.
	Parametry konfiguracyjne modu³ów umieszcza siê w sekcjach instancji je wywo³uj±cych.</para>
		<sect2 id="daemon-moduleslist">
		<title>Lista dostêpnych modu³ów</title>
			<table>
			<title>Lista modu³ów demona almsd</title>
			<tgroup cols="2">
			<colspec ALIGN="center" COLWIDTH="200">
			<colspec ALIGN="center" COLWIDTH="300">
				<thead>
				<row>
				<entry>Nazwa</entry>
				<entry>Opis</entry>
				</row>
				</thead>
				<tbody>
				<row>
				<entry>dhcp</entry>
				<entry>Konfiguracja serwera dhcpd</entry>
				</row>
				<row>
				<entry>cutoff</entry>
				<entry>Od³±czanie u¿ytkowników z zaleg³o¶ciami w op³atach</entry>
				</row>
				<row>
				<entry>dns</entry>
				<entry>Konfiguracja serwera dns</entry>
				</row>
				<row>
				<entry>ethers</entry>
				<entry>Tworzenie pliku /etc/ethers</entry>
				</row>
				<row>
				<entry>hostfile</entry>
				<entry>Modu³ uniwersalny (np. tworzenie regó³ iptables)</entry>
				</row>
				<row>
				<entry>notify</entry>
				<entry>Powiadamianie u¿ytkowników o zaleg³o¶ciach w op³atach</entry>
				</row>
				<row>
				<entry>payments</entry>
				<entry>Naliczanie op³at abonamentowych</entry>
				</row>
				<row>
				<entry>oident</entry>
				<entry>Konfiguracja oident</entry>
				</row>
				<row>
				<entry>tc</entry>
				<entry>Tworzenie regó³ HTB</entry>
				</row>
				<row>
				<entry>traffic</entry>
				<entry>Statystyki wykorzystania ³±cza</entry>
				</row>
				</tbody>
			</tgroup>
			</table>
		</sect2>
		<sect2 id="daemon-payments">
		<title>Payments</title>
		    <sect3 id="payments-desc">
		    <title>Opis</title>
		    <para>Modu³ nalicza u¿ytkownikom op³aty abonamentowe. Nale¿y go uruchamiaæ 
		    codziennie. Op³aty naliczane na podstawie przypisanych u¿ytkownikowi
		    taryf zapisywane s± do bazy wraz z komentarzem okre¶lonym zmienn± 'comment'.</para>
		    </sect3>
		    <sect3 id="payments-config">
		    <title>Konfiguracja</title>
		    <para>Dla tego modu³u jest dostêpna tylko jedna zmienna kofiguracyjna:</para>
		    <itemizedlist>
			<listitem>
			    <para>comment</para>
			    <para>Komentarz do operacji. '%period' zostanie zamienione na daty od-do 
			    nale¿nego abonamentu, np. '10.10.2003 - 09.11.2003'. Domy¶lnie: 'Abonament za okres %period'.</para>
			    <para>Przyk³ad: <prompt>comment = 'Abonament miesiêczny za okres %period' </prompt></para>
			</listitem>
		    </itemizedlist>
		    </sect3>
		</sect2>
		<sect2 id="daemon-notify">
		<title>Notify</title>
		    <sect3 id="notify-desc">
		    <title>Opis</title>
		    <para>Modu³ 'notify' s³u¿y do informowania u¿ytkowników o zaleg³o¶ciach
		    w op³atach za pomoc± poczty elektronicznej. Aktualne saldo u¿ytkownika
		    porównywane jest ze zmienn± 'limit', je¶li jest ni¿sze - wiadomo¶æ
		    zostaje wys³ana. Tre¶æ wiadomo¶ci pobierana jest z przygotowanego szablonu, 
		    w którym mo¿na stosowaæ nastêpuj±ce zmienne:
		    <itemizedlist>
			<listitem>
			    <para>%saldo - aktualne saldo u¿ytkownika</para>
			</listitem>
			<listitem>
			    <para>%name - imiê u¿ytkownika</para>
			</listitem>
			<listitem>
			    <para>%lastname - nazwisko/nazwa u¿ytkownika</para>
			</listitem>
			<listitem>
			    <para>%last_10_in_a_table - wyci±g ostatnich 10 operacji na kocie u¿ytkownika</para>
			</listitem>
		    </itemizedlist></para>
		    </sect3>
		    <sect3 id="notify-config">
		    <title>Konfiguracja</title>
		    <para>Poni¿ej przedstawiono dostêpne opcje konfiguracyjne modu³u 'notify':</para>
		    <itemizedlist>
			<listitem>
			    <para>mailtemplate</para>
			    <para>Lokalizacja pliku z szablonem wiadomo¶ci. Domy¶lnie: pusty</para>
			    <para>Przyk³ad: <prompt>mailtemplate = modules/notify/sample/mailtemplate</prompt></para>
			</listitem>
			<listitem>
			    <para>file</para>
			    <para>Lokalizacja pliku tymczasowego. Domy¶lnie: /tmp/mail</para>
			    <para>Przyk³ad: <prompt>file = /tmp/mail.txt</prompt></para>
			</listitem>
			<listitem>
			    <para>command</para>
			    <para>Polecenie pow³oki wysy³aj±ce e-maila. '%address' zostanie zast±pione
			    adresem e-mail u¿ytkownika. Domy¶lnie: 'mail %address -s "Inf. o zaleg³o¶ciach w op³atach" &lt; /tmp/mail'.</para>
			    <para>Przyk³ad: <prompt>command = 'mail %address -s "musisz zap³aciæ, bo jak nie..." &lt; /tmp/mail.txt'</prompt></para>
			</listitem>		
			<listitem>
			    <para>limit</para>
			    <para>Wiadomo¶æ o zaleg³o¶ciach zostaje wys³ana je¶li saldo u¿ytkownika 
			    spadnie poni¿ej kwoty okre¶lonej zmienn± limit. Domy¶lnie: 0</para>
			    <para>Przyk³ad: <prompt>limit = -20</prompt></para>
			</listitem>
			<listitem>
			    <para>debug_mail</para>
			    <para>Okre¶la adres na który zostan± wys³ane wszystkie wiadomo¶ci, przydatne
			    podczas testów. Domy¶lnie: puste.</para>
			    <para>Przyk³ad: <prompt>debug_mail = localhost@moja.net</prompt></para>
			</listitem>
		    </itemizedlist>
		    </sect3>
		</sect2>
		<sect2 id="daemon-cutoff">
		<title>Cutoff</title>
		    <sect3 id="cutoff-desc">
		    <title>Opis</title>
		    <para>Cutoff zmienia na 'od³±czony' status komputerów u¿ytkownikom, którzy
		    maj± na koncie zaleg³o¶ci wiêksze ni¿ okre¶lony limit. Ten modu³ nie zajmuje
		    siê fizycznym blokowaniem dostêpu do sieci. Nale¿y pamiêtaæ aby uruchamiaæ
		    go przed modu³ami takimi jak np. 'hostfile'. Wa¿na jest kolejno¶æ instancji
		    na li¶cie w zmiennej 'instances'. Modu³ 'cutoff' najlepiej uruchamiaæ codziennie.</para>
		    </sect3>
		    <sect3 id="cutoff-config">
		    <title>Konfiguracja</title>
		    <para>Modu³ 'cutoff' posiada tylko jeden parametr:</para>
		    <itemizedlist>
			<listitem>
			    <para>limit</para>
			    <para>Od³±czenie nastêpuje je¶li saldo u¿ytkownika spadnie poni¿ej
			    kwoty okre¶lonej t± zmienn±. Domy¶lnie: 0.</para>
			    <para>Przyk³ad: <prompt>limit = -20</prompt></para>
			</listitem>
		    </itemizedlist>
		    </sect3>
		</sect2>
		<sect2 id="daemon-dns">
		<title>DNS</title>
		    <sect3 id="dns-desc">
		    <title>Opis</title>
		    <para>Modu³ zarz±dzaj±cy serwerem DHCP, tworzy plik konfiguracyjny oraz
		    restartuje us³ugê. Zmienna 'command' umo¿liwia równie¿ wykonywanie innych 
		    czynno¶ci (programów).</para>
		    </sect3>
		    <sect3 id="dns-config">
		    <title>Konfiguracja</title>
		    <para>Wiêkszo¶æ parametrów konfiguracyjnych odpowiada fragmentom 
		    pliku konfiguracyjnego dhcpd, które w typowych zastosowaniach
		    nie wymagaj± zmiany:</para>
		    <itemizedlist>
			<listitem>
			    <para>file</para>
			    <para>Okre¶la lokalizacjê pliku konfiguracyjnego serwera dhcp. 
			    Domy¶lnie: /tmp/dhcpd.conf.</para>
			    <para>Przyk³ad: <prompt>file = /etc/dhcpd.conf</prompt></para>
			</listitem>
			<listitem>
			    <para>command</para>
			    <para>Polecenie wykonywane po utworzeniu pliku konfiguracyjnego. 
			    Domy¶lnie: pusta.</para>
			    <para>Przyk³ad: <prompt>command = 'killall -HUP dhcpd'</prompt></para>
			</listitem>
			<listitem>
			    <para>start</para>
			    <para>Nag³ówek pliku. Domy¶lnie: "shared-network LMS {".</para>
			    <para>Przyk³ad: <prompt>start = "shared-network LMS {"</prompt></para>
			</listitem>
			<listitem>
			    <para>end</para>
			    <para>Stopka pliku. Domy¶lnie: "}".</para>
			    <para>Przyk³ad: <prompt>end = "\n}"</prompt></para>
			</listitem>
			<listitem>
			    <para>subnet_start</para>
			    <para>Nag³ówek podsieci. '%a' - nazwa, '%m' - maska. Domy¶lnie: "subnet %a netmask %m {\ndefault-lease-time 86400;\nmax-lease-time 86400;".</para>
			    <para>Przyk³ad: <prompt>subnet_start = "subnet %a netmask %m {default-lease-time 3600;"</prompt></para>
			</listitem>
			<listitem>
			    <para>subnet_end</para>
			    <para>Stopka podsieci. Domy¶lnie: "}".</para>
			    <para>Przyk³ad: <prompt>subnet_end = '\t}'</prompt></para>
			</listitem>
			<listitem>
			    <para>subnet_gateway</para>
			    <para>Brama podsieci. '%i' zostanie zamienione na adres ip. Domy¶lnie: 'option routers %i;'.</para>
			    <para>Przyk³ad: <prompt>subnet_gateway = "option routers %i"</prompt></para>
			</listitem>
			<listitem>
			    <para>subnet_dns</para>
			    <para>DNS'y podsieci. '%i - adresy dns'ów. Domy¶lnie: "option domain-name-servers %i;".</para>
			    <para>Przyk³ad: <prompt>subnet_dns = "option domain-name-servers 192.168.0.1"</prompt></para>
			</listitem>
			<listitem>
			    <para>subnet_domain</para>
			    <para>Nazwa domenowa podsieci. '%n' - nazwa. Domy¶lnie: "option domain-name %n;".</para>
			    <para>Przyk³ad: <prompt>subnet_domain = "option domain-name test.%n;"</prompt></para>
			</listitem>
			<listitem>
			    <para>subnet_wins</para>
			    <para>Serwery wins. '%i' - adres ip serwera. Domy¶lnie: "option netbios-name-servers %i;".</para>
			    <para>Przyk³ad: <prompt>subnet_wins = ""</prompt></para>
			</listitem>
			<listitem>
			    <para>subnet_range</para>
			    <para>Zakres adresów podsieci. '%s' - adres pocz±tkowy, '%e' - koniec zakresu. Domy¶lnie: "range %s %e;".</para>
			    <para>Przyk³ad: <prompt>subnet_range = "range %s %e;"</prompt></para>
			</listitem>
			<listitem>
			    <para>host</para>
			    <para>Parametry hostów, gdzie '%n' - nazwa hosta, '%m' - MAC, '%i' - adres ip. 
			    Domy¶lnie: "\thost %n {\n\t\thardware ethernet %m; fixed-address %i; \n\t}".</para>
			    <para>Przyk³ad: <prompt>host = "host %n {hardware ethernet %m; fixed-address %i;}"</prompt></para>
			</listitem>
		    </itemizedlist>
		    </sect3>
		</sect2>	    
	</sect1>
</chapter>