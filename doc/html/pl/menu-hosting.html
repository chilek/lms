<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN""http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>Konta</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REL="HOME"
TITLE="LMS - LAN Management System 1.11-cvs"
HREF="index.html"><LINK
REL="UP"
TITLE="Interfejs Użytkownika (LMS-UI)"
HREF="user.html"><LINK
REL="PREVIOUS"
TITLE="Dokumenty"
HREF="menu-documents.html"><LINK
REL="NEXT"
TITLE="Mailing"
HREF="menu-mailing.html"><LINK
REL="STYLESHEET"
TYPE="text/css"
HREF="../images/style.css"><META
HTTP-EQUIV="Content-Type"
CONTENT="text/html; charset=UTF-8"></HEAD
><BODY
CLASS="SECT1"
BGCOLOR="#EBE4D6"
TEXT="#000000"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>LMS - LAN Management System 1.11-cvs</TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="menu-documents.html"
ACCESSKEY="P"
>Poprzedni</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
>Rozdzia&#322; 3. Interfejs Użytkownika (LMS-UI)</TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="menu-mailing.html"
ACCESSKEY="N"
>Nast&#281;pny</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="MENU-HOSTING"
>3.9. Konta</A
></H1
><P
>Zarządzanie kontami różnych usług na serwerze jest teraz
	możliwe. Funkcjonalność ta jest przeznaczona dla zaawansowanych 
	użytkowników. Wymaga znajomości tych usług i ich konfiguracji
	w celu korzystania z bazy danych.</P
><P
>W LMSie można utworzyć pięć rodzajów kont: shell (1), poczta (2),
	www (4), ftp (8) i sql (16). W nawiasach podano numeryczne wewnętrzne oznaczenie
	typu konta w bazie. Konta mogą być wielotypowe. Przykładowo, jeśli 
	zdefiniujesz konto shell+poczta+ftp w bazie zostanie zapisana cyfra 11.
	Oznacza to, że do rozpoznawania typu konta w warunkach WHERE zapytań
	SQL należy stosować sumowanie binarne (jak na przykładach w dalszej
	części rozdziału).</P
><P
>Masz także możliwość definiowania domen i aliasów.</P
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="MENU-HOSTING-ACCOUNTS"
>3.9.1. Konta</A
></H2
><P
>Na liście przedstawione są podstawowe informacje o kontach.
	    Możliwe jest dowolne sortowanie listy poprzez kliknięcie nazwy
	    kolumny oraz filtrowanie wg zadanych kryteriów. Przejście do edycji 
	    danych konta następuje po wybraniu ikony [Edytuj]. Użytkownik ma 
	    także prawo do zmiany hasła.</P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="MENU-HOSTING-NEW-ACCOUNT"
>3.9.2. Nowe konto</A
></H2
><P
>Definiując dane konto musisz podać login, hasło, wybrać domenę,
	    wybrać typ konta oraz przypisać klienta (lub utworzyć tzw. konto
	    systemowe). Data ważności konta jest opcjonalna. Pozostawienie pustego pola z datą 
	    oznacza, że konto nigdy nie wygasa. </P
><P
>Masz możliwość zdefiniować dowolny katalog domowy użytkownika (konta).
	    Opcja konfiguracyjna <TT
CLASS="FILENAME"
>homedir_prefix</TT
> w sekcji 
	    <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>[phpui]</I
></SPAN
> zawiera prefix katalogu domowego, domyślnie
	    ustawiony na wartość "/home/".</P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="MENU-HOSTING-ALIASES"
>3.9.3. Aliasy</A
></H2
><P
>Konta (głównie mailowe) mogą posiadać dowolną ilość aliasów.
	    Administrator serwera pocztowego może przekierować (lokalnie) pocztę
	    z wszystkich aliasów do jednego konta. Na liście aliasów przedstawione 
	    są podstawowe informacje o nich i o kontach na które aliasy te wskazują.
	    Możliwe jest dowolne sortowanie listy poprzez kliknięcie nazwy
	    kolumny oraz filtrowanie wg zadanych kryteriów.</P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="MENU-HOSTING-NEW-ALIAS"
>3.9.4. Nowy alias</A
></H2
><P
>Tworząc alias definiujesz dla niego login i domenę oraz cel. Celem może 
		być jedno lub więcej istniejących kont. Uwaga: aby utworzyć alias do konta,
		które znajduje się na obcym serwerze należy utworzyć konto i podać adres przekierowania.</P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="MENU-HOSTING-DOMAINS"
>3.9.5. Domeny</A
></H2
><P
>Na liście przedstawione są podstawowe informacje o zdefiniowanych
	    domenach. Możliwe jest dowolne sortowanie listy poprzez kliknięcie nazwy
	    kolumny. Możliwa jest edycja danych domeny po wybraniu ikony [Edytuj].</P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="MENU-HOSTING-NEW-DOMAIN"
>3.9.6. Nowa domena</A
></H2
><P
>Dane domeny zawierają nazwę oraz opis. Domena może zostać przypisana do 
		klienta.</P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="MENU-HOSTING-SEARCH"
>3.9.7. Szukaj</A
></H2
><P
>Wyszukiwanie kont, aliasów i domen według zadanych kryteriów.</P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="HOSTING-EXAMPLES"
>3.9.8. Przykłady</A
></H2
><P
>Poniższy listing zawiera istotne fragmenty pliku konfiguracyjnego
	    demona proftpd (w wersji 1.2.10) umożliwiający przechowywanie danych
	    o kontach ftp w bazie LMSa. Przykład zawiera konfigurację dla bazy
	    danych PostgreSQL, w komentarzach podano rozwiązania dla MySQLa:
	    <DIV
CLASS="EXAMPLE"
><A
NAME="HOSTING-E1"
></A
><P
><B
>Przyk&#322;ad 3-1. Konta. Konfiguracja proftpd.</B
></P
><PRE
CLASS="SCREEN"
>  ServerName	"LMS FTP Server"
  
  #nazwa_bazy@host:port klient hasło
  SQLConnectInfo lms@localhost:5432 lms mypassword
  
  SQLAuthTypes Crypt Plaintext
  SQLUserInfo passwd login password uid NULL home NULL
  RequireValidShell off
  SQLAuthenticate users
  
  # utworzenie katalogu domowego gdy nie istnieje
  SQLHomedirOnDemand on
  
  # komunikat przy logowaniu
  SQLShowInfo PASS "230" "Last login: %{getlastlogin}"
  SQLLog PASS setlastlogin
  
  # SQLNamedQuery getlastlogin SELECT "CASE lastlogin WHEN 0 THEN '' ELSE FROM_UNIXTIME(lastlogin) END FROM passwd WHERE login='%u'"
  # SQLNamedQuery setlastlogin UPDATE "lastlogin=UNIX_TIMESTAMP() WHERE login='%u'" passwd 
  SQLNamedQuery getlastlogin SELECT "CASE lastlogin WHEN 0 THEN '' ELSE lastlogin::abstime::timestamp::text END FROM passwd WHERE login='%u'"
  SQLNamedQuery setlastlogin UPDATE "lastlogin=EXTRACT(EPOCH FROM CURRENT_TIMESTAMP(0)) WHERE login='%u'" passwd
  
  # Sprawdzamy datę ważności konta oraz ograniczamy szukanie do kont ftp
  # SQLUserWhereClause "type &#38; 8 = 8 AND (expdate = 0 OR expdate &gt; UNIX_TIMESTAMP())"
  SQLUserWhereClause "type &#38; 8 = 8 AND (expdate = 0 OR expdate &gt; EXTRACT(EPOCH FROM CURRENT_TIMESTAMP(0)))"</PRE
></DIV
></P
><P
>W kolejnym przykładzie przedstawimy jak skonfigurować serwer
	    Postfix 2.1.1 oraz Cyrus-SASL 2.1.19, Courier-IMAP/POP3 3.0.4, aby korzystały
	    z bazy danych LMSa. LMS'owe konta będą kontami wirtualnymi, a poczta
	    przechowywana będzie w formacie Maildir.</P
><P
>Ponieważ hasła w LMS'ie są szyfrowane, wymagane jest zainstalowanie
	    SASL'a z łatą pozwalającą na to. W komentarzach podano wartości opcji
	    charakterystycznych dla bazy MySQL. Listing zawiera tylko opcje bezpośrednio
	    związane z bazą danych:
	    <DIV
CLASS="EXAMPLE"
><A
NAME="HOSTING-E2"
></A
><P
><B
>Przyk&#322;ad 3-2. Konta. Konfiguracja serwera pocztowego (postfix+sasl+courier).</B
></P
><PRE
CLASS="SCREEN"
># Plik smtpd.conf (Cyrus-SASL):

pwcheck_method: auxprop
#sql_engine: mysql
sql_engine: pgsql
sql_user: lms
sql_passwd: hasło
sql_hostnames: localhost
sql_database: lms
#sql_select: SELECT password FROM passwd, domains WHERE domainid = domains.id
#       AND login='%u' AND domains.name ='%r' AND type &#38; 2 = 2 
#	AND (expdate = 0 OR expdate &gt; UNIX_TIMESTAMP())
sql_select: SELECT password FROM passwd, domains WHERE domainid = domains.id
	AND login='%u' AND domains.name ='%r' AND type &#38; 2 = 2 
	AND (expdate = 0 OR expdate &gt; EXTRACT(EPOCH FROM CURRENT_TIMESTAMP(0)))
password_format: crypt
mech_list: login plain

# authpgsqlrc (lub authmysqlrc) (Courier):

# użytkownik postfix (właściciel katalogu z pocztą)
#MYSQL_UID_FIELD '1004'
PGSQL_UID_FIELD '1004'
# grupa postfix (właściciel katalogu z pocztą)
#MYSQL_GID_FIELD '1004'
PGSQL_GID_FIELD '1004'
#MYSQL_PORT		3306
PGSQL_PORT		5432
#MYSQL_USERNAME		lms
PGSQL_USERNAME		lms
#MYSQL_PASSWORD		hasło
PGSQL_PASSWORD		hasło
#MYSQL_DATABASE		lms
PGSQL_DATABASE		lms
#MYSQL_SELECT_CLAUSE SELECT login, \
#       password, '', 104, 104, '/var/spool/mail/virtual', \
#       CONCAT(domains.name,'/',login,'/'), '', login, '' \
#       FROM passwd, domains WHERE domainid = domains.id \
#       AND login = '$(local_part)' AND domains.name = '$(domain)' \
#       AND type &#38; 2 = 2 AND (expdate = 0 OR expdate &gt; UNIX_TIMESTAMP())
PGSQL_SELECT_CLAUSE SELECT login, \
        password, '', 104, 104, '/var/spool/mail/virtual', \
        domains.name || '/' || login ||'/', '', login, '' \
        FROM passwd, domains WHERE domainid = domains.id 
        AND login = '$(local_part)' AND domains.name = '$(domain)' \
        AND type &#38; 2 = 2 \
        AND (expdate = 0 OR expdate &gt; EXTRACT(EPOCH FROM CURRENT_TIMESTAMP(0)))

# main.cf (Postfix):

virtual_mailbox_base = /var/spool/mail/virtual
virtual_mailbox_domains = pgsql:/etc/postfix/virtual_domains_maps.cf
virtual_mailbox_maps = pgsql:/etc/postfix/virtual_mailbox_maps.cf
virtual_alias_maps = pgsql:/etc/postfix/virtual_alias_maps.cf
recipient_bcc_maps = pgsql:/etc/postfix/recipient_bcc_maps.cf

# virtual_domains_maps.cf (Postfix):

user = lms
password = hasło
hosts = localhost
dbname = lms
#pgSQL i MySQL
query = SELECT name FROM domains WHERE name = '%s'

# virtual_mailbox_maps.cf (Postfix):

user = lms
password = hasło
hosts = localhost
dbname = lms

# MySQL
#query = SELECT CONCAT(domains.name,'/',login,'/') 
#	FROM passwd, domains WHERE domainid = domains.id
#	AND login = '%u' AND domains.name = '%d' 
#	AND type &#38; 2 = 2 AND (expdate = 0 OR expdate &gt; UNIX_TIMESTAMP())

# pgSQL
query = SELECT domains.name || '/' || login || '/' 
	FROM passwd, domains WHERE domainid = domains.id
        AND login = '%u' AND domains.name = '%d' 
        AND type &#38; 2 = 2 
        AND (expdate = 0 OR expdate &gt; EXTRACT(EPOCH FROM CURRENT_TIMESTAMP(0)))

# virtual_alias_maps.cf (Postfix):

user = lms
password = hasło
hosts = localhost
dbname = lms
# MySQL, PgSQL
query = SELECT CASE WHEN mail_forward != '' THEN mail_forward ELSE p.login || '@' || pd.name END
        FROM passwd p
	JOIN domains pd ON (p.domainid = pd.id)
	WHERE p.id IN (SELECT aa.accountid
		FROM aliases a
		JOIN domains ad ON (a.domainid = ad.id)
		JOIN aliasassignments aa ON (aa.aliasid = a.id)
		WHERE a.login = '%u' AND ad.name = '%d')
	OR (p.login = '%u' AND pd.name = '%d' AND type &#38; 2 = 2)

# recipient_bcc_maps.cf (Postfix):

user = lms
password = hasło
hosts = localhost
dbname = lms
# MySQL, PgSQL
query = SELECT mail_bcc FROM passwd, domains 
	WHERE domainid = domains.id
	        AND login = '%u' AND domains.name = '%d'
		AND type &#38; 2 = 2
		AND mail_bcc != ''
		AND (expdate = 0 OR expdate &gt; EXTRACT(EPOCH FROM CURRENT_TIMESTAMP(0)))
					</PRE
></DIV
></P
><P
>Następny przykład podesłany przez bart'a przedstawia instalację i konfigurację
		serwera pure-ftpd w dystrybucji Gentoo z wykorzystaniem bazy danych MySQL.
		<DIV
CLASS="EXAMPLE"
><A
NAME="ACCOUNTS-E3"
></A
><P
><B
>Przyk&#322;ad 3-3. Konta. Konfiguracja pure-ftpd.</B
></P
><P
>No to zaczynamy od instalacji serwera pure-ftpd. Pod Gentoo wygląda to tak:
<PRE
CLASS="SCREEN"
>bart # emerge pure-ftpd -av
These are the packages that I would merge, in order:
Calculating dependencies ...done!
[ebuild   R   ] net-ftp/pure-ftpd-1.0.20-r1  -caps -ldap +mysql +pam -postgres +ssl +vchroot 459 kB
Total size of downloads: 459 kB</PRE
>
			Co do innych systemów to każdy chyba wie jak się instaluje pakiety w
			swoim systemie, a jeżeli nie to pozostaje kompilacja ze źródeł.
			Po zainstalowaniu przechodzimy do stworzenia pliku, który będzie
			odpowiadał za łączenie się z bazą LMS'a.
			Tworzymy plik <TT
CLASS="FILENAME"
>/etc/pureftpd-mysql.conf</TT
>, który to 
			powinien zawierać minimum:
<PRE
CLASS="SCREEN"
>MYSQLServer     localhost (adres serwera bazy danych - domyślnie 'localhost')
MYSQLPort       3306 (port na którym działa serwer MySql - domyślnie '3306')
MYSQLSocket     /var/run/mysqld/mysqld.sock (
MYSQLUser       lms (nazwa usera z dostępem do bazy)
MYSQLPassword   hasło (tutaj należy podać hasło)
MYSQLDatabase   lms (nazwa bazy danych)
MYSQLCrypt      crypt (sposób przechowywania haseł)
MYSQLGetPW      SELECT password FROM passwd WHERE login="\L" (pobieranie hasła dla usera)
MYSQLGetUID     SELECT uid FROM passwd WHERE login="\L" (pobieranie uid dla usera)
MYSQLGetGID     SELECT gid FROM passwd WHERE login="\L" (pobieranie gid dla usera)
MYSQLGetDir     SELECT home FROM passwd WHERE login="\L" (pobieranie nazwy katalogu domowego dla usera)
MySQLGetQTASZ   SELECT quota_ftp FROM passwd WHERE login="\L" (quota czyli pojemność konta w MB - podając w lms-ui 10 oznacza to pojemność 10MB)</PRE
>
			Teraz pozostaje nam już tylko konfiguracja serwera pure-ftpd. (w gentoo
			plik konfiguracyjny mieści się w <TT
CLASS="FILENAME"
>/etc/conf.d/pure-ftpd</TT
>) 
			a więc:
<PRE
CLASS="SCREEN"
>## Najpierw odkomentujmy tę linię, ponieważ inaczej serwer nie będzie chciał wystartować
IS_CONFIGURED="yes"
## Tutaj podajemy adres naszego serwera i port na którym ma nasłuchiwać
SERVER="-S www.nasza.domena.pl,21"
## Określamy ilość jednoczesnych połączeń do serwera oraz ilość połączeń z tego samego IP
## To już chyba każdy według potrzeb
MAX_CONN="-c 50"
MAX_CONN_IP="-C 2"
## Startujemy daemona w tle
DAEMON="-B"
## Ustalamy procentową zajętość dysku/partycji kiedy serwer powinien przestać zezwalać na przyjmowanie danych
DISK_FULL="-k 90%"
## Jeżeli serwer jest za NATem odkomentuj tę linię
#USE_NAT="-N"
## Autoryzacja ma być pobierana z bazy LMS'a - podajemy ścieżkę do stworzonego przez nas wcześniej pliku
AUTH="-l mysql:/etc/pureftpd-mysql.conf"
## Pozostałe opcje w moim wypadku są takie
MISC_OTHER="-A -x -j"</PRE
></P
></DIV
></P
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="menu-documents.html"
ACCESSKEY="P"
>Poprzedni</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>Spis tre&#347;ci</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="menu-mailing.html"
ACCESSKEY="N"
>Nast&#281;pny</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>Dokumenty</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="user.html"
ACCESSKEY="U"
>Pocz&#261;tek rozdzia&#322;u</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>Mailing</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>