<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN""http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>Parser</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REL="HOME"
TITLE="LMS - LAN Management System 1.7-cvs"
HREF="index.html"><LINK
REL="UP"
TITLE="LMS Daemon"
HREF="daemon.html"><LINK
REL="PREVIOUS"
TITLE="Modules"
HREF="daemon-modules.html"><LINK
REL="NEXT"
TITLE="For curious"
HREF="devel.html"><LINK
REL="STYLESHEET"
TYPE="text/css"
HREF="../images/style.css"><META
HTTP-EQUIV="Content-Type"
CONTENT="text/html; charset=ISO-8859-1"></HEAD
><BODY
CLASS="SECT1"
BGCOLOR="#EBE4D6"
TEXT="#000000"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>LMS - LAN Management System 1.7-cvs</TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="daemon-modules.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
>Chapter 6. LMS Daemon</TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="devel.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="DAEMON-PARSER"
>6.3. Parser</A
></H1
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="DAEMON-PARSER-INTRO"
>6.3.1. Introduction</A
></H2
><P
>Parser module is based on a scripting language
	    <A
HREF="http://silvercoders.com/wiki/index.php?title=T-Script"
TARGET="_top"
>T-Script</A
> which 
	    primary purpose is to generate text files. It can be useful for processing
	    templates with some additional data retrieved from data sources 
	    like SQL databases or text files. In lmsd's module contents of scripts
	    are stored in database, so they can be edited via <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>LMS-UI</I
></SPAN
>.
	    In the future parser should replace almost all lmsd modules.</P
><P
>Before compilation ensure that you have in your system packages
	    <TT
CLASS="FILENAME"
>bison</TT
> (at least 1.875 version) and <TT
CLASS="FILENAME"
>flex</TT
>.
	    </P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="DAEMON-PARSER-CONFIG"
>6.3.2. Configuration</A
></H2
><P
>Parser has following options:</P
><UL
><LI
><P
>script</P
><P
>Contents of script. Default: empty.</P
><P
>Example: <SAMP
CLASS="PROMPT"
>script = '{var=1}variable var={var}'</SAMP
></P
></LI
><LI
><P
>file</P
><P
>Location of output file. Default: empty.</P
><P
>Example: <SAMP
CLASS="PROMPT"
>file = /tmp/parser.out</SAMP
></P
></LI
><LI
><P
>command</P
><P
>Shell command to execute after script compilation. Default: empty</P
><P
>Example: <SAMP
CLASS="PROMPT"
>command = "sh /tmp/parser.out"</SAMP
></P
></LI
></UL
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="DAEMON-PARSER-SYNTAX"
>6.3.3. Syntax</A
></H2
><P
>T-Script language syntax is based on other popular languages like C 
	    or JavaScript with little changes made to make writting templates simpler. 
	    Additional commands should be written inside { } parenthesis. Data
	    outside curly brackets will be writed to output file (or ommited if file 
	    was not specified). All expressions, variables, commands, function names are
	    case-sensitive.</P
><P
>Supported expressions:
	    <UL
><LI
><P
>Literal inside quotes.</P
><P
><PRE
CLASS="SCREEN"
>"some literal"</PRE
></P
></LI
><LI
><P
>Number.</P
><P
><PRE
CLASS="SCREEN"
>1234</PRE
></P
></LI
><LI
><P
>Value of variable "var".</P
><P
><PRE
CLASS="SCREEN"
>var</PRE
></P
></LI
><LI
><P
>N-th element of array "var".</P
><P
><PRE
CLASS="SCREEN"
>var[n]</PRE
></P
></LI
><LI
><P
>Subvariable "n" of variable "var".</P
><P
><PRE
CLASS="SCREEN"
>var.n</PRE
></P
></LI
><LI
><P
>Value of expression inside parenthesis.</P
><P
><PRE
CLASS="SCREEN"
>( &lt;expression&gt; )</PRE
></P
></LI
><LI
><P
>1 if value of expression is false, otherwise 0.</P
><P
><PRE
CLASS="SCREEN"
>! &lt;expression&gt;</PRE
></P
></LI
><LI
><P
>Evaluates to 1 if expression1 value equals expression2 
		    value or 0 if not.</P
><P
><PRE
CLASS="SCREEN"
>&lt;expression1&gt; == &lt;expression2&gt;</PRE
></P
></LI
><LI
><P
>Evaluates to 1 if expression1 value doesn't equal 
		    expression2 value or 0 if it does.</P
><P
><PRE
CLASS="SCREEN"
>&lt;expression1&gt; != &lt;expression2&gt;</PRE
></P
></LI
><LI
><P
>Evaluates to 1 if expression1 value is less than 
		    expression2 value.</P
><P
><PRE
CLASS="SCREEN"
>&lt;expression1&gt; &lt; &lt;expression2&gt;</PRE
></P
></LI
><LI
><P
>Evaluates to 1 if expression1 value is greater than 
		    expression2 value.</P
><P
><PRE
CLASS="SCREEN"
>&lt;expression1&gt; &gt; &lt;expression2&gt;</PRE
></P
></LI
><LI
><P
>Evaluates to 1 if expression1 value or expression2 value 
		    are true.</P
><P
><PRE
CLASS="SCREEN"
>&lt;expression1&gt; || &lt;expression2&gt;</PRE
></P
></LI
><LI
><P
>Evaluates to 1 if expression1 value and expression2 value 
		    are true.</P
><P
><PRE
CLASS="SCREEN"
>&lt;expression1&gt; &#38;&#38; &lt;expression2&gt;</PRE
></P
></LI
><LI
><P
>When both expression values have numeric type evaluates 
		    to result of arithmetic operation. In other situation treats 
		    expressions as strings and performs string concatenation.</P
><P
><PRE
CLASS="SCREEN"
>&lt;expression1&gt; + &lt;expression2&gt;</PRE
></P
></LI
><LI
><P
>Evaluates to result of arithmetic operation on two expression values.</P
><P
><PRE
CLASS="SCREEN"
>&lt;expression1&gt; - &lt;expression2&gt;
&lt;expression1&gt; * &lt;expression2&gt;
&lt;expression1&gt; / &lt;expression2&gt;
&lt;expression1&gt; % &lt;expression2&gt;</PRE
></P
></LI
><LI
><P
>Evaluates to 1 if expression1 value match with regular expression2, else
		    0.</P
><P
><PRE
CLASS="SCREEN"
>&lt;expression1&gt; =~ &lt;expression2&gt;</PRE
></P
></LI
></UL
>
	    </P
><P
>Comments:
	    <UL
><LI
><P
>C-style comment.</P
><P
><PRE
CLASS="SCREEN"
>{/* this is a comment - it can be also multiline */}</PRE
></P
></LI
></UL
>
	    </P
><P
>Basic commands:
	    <UL
><LI
><P
>Assigns expression value to specified variable.</P
><P
>		    <PRE
CLASS="SCREEN"
>{&lt;variable_name&gt; = &lt;expression&gt;}</PRE
></P
></LI
><LI
><P
>Executes command only if expression is true. Second form executes 
		    command1 if expression is true or command2 if expression is false.</P
><P
><PRE
CLASS="SCREEN"
>{if ( &lt;expression&gt; }) &lt;command&gt; {/if}
{if ( &lt;expression&gt; }) &lt;commands1&gt; {else} &lt;commands2&gt; {/if}</PRE
></P
><P
>Text between command blocks is treated as a command so the following example is correct:
<PRE
CLASS="SCREEN"
>Some text 
{if (a==1)} 
a equals 1 
{else} 
a doesn't equal 1 
{/if} </PRE
>
You can put backslash between command block and end of line to eat \n 
symbol and keep normal text flow. For example: 
<PRE
CLASS="SCREEN"
>Some text 
{if (a==1)}\ 
a equals 1 
{else}\ 
a doesn't equal 1 
{/if}\</PRE
></P
></LI
><LI
><P
>Executes first command1 as loop initialization command. Then executes 
		    commands and command2 while expression is true.</P
><P
><PRE
CLASS="SCREEN"
>{for ( &lt;command1&gt; ; &lt;expression&gt; ; &lt;command2&gt; )} &lt;commands&gt; {/for}</PRE
></P
></LI
><LI
><P
>Redirects script output to file. Data will be appended to file.</P
><P
><PRE
CLASS="SCREEN"
>{file &lt;file_name&gt;} &lt;commands&gt; {/file}</PRE
></P
></LI
></UL
>
	    </P
><P
>Basic functions:
	    <UL
><LI
><P
>Converts numeric variable to string value.</P
><P
><PRE
CLASS="SCREEN"
>{string(&lt;variable_name&gt;)}</PRE
></P
></LI
><LI
><P
>Converts string variable to numeric value. For arrays returns number of items in array.</P
><P
><PRE
CLASS="SCREEN"
>{number(&lt;variable_name&gt;)}</PRE
></P
></LI
></UL
>
	    </P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="DAEMON-PARSER-EXT"
>6.3.4. Extensions</A
></H2
><P
>Extensions are <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>tscript</I
></SPAN
> library supplements. 
		That are functions and constants, wich can be used in scripts. Below
		are described extensions implemented in <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>lmsd</I
></SPAN
>.
		<DIV
CLASS="NOTE"
><TABLE
CLASS="NOTE"
WIDTH="100%"
BORDER="0"
><TR
><TD
WIDTH="25"
ALIGN="CENTER"
VALIGN="TOP"
><IMG
SRC="../images/note.gif"
HSPACE="5"
ALT="Note"></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>Functions have two calling forms: with brackets
		(<SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>{function(var)}</I
></SPAN
>) and without brackets
		(<SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>{function {var}}</I
></SPAN
>).</P
></TD
></TR
></TABLE
></DIV
>
		</P
><DIV
CLASS="SECT3"
><H3
CLASS="SECT3"
><A
NAME="EXEC"
>6.3.4.1. Exec</A
></H3
><P
>Shell commands execution is possible with exec(). 
		You can run many commands separated by semicolons in one function 
		call.</P
><UL
><LI
><P
>Shell commands execution.</P
><P
><PRE
CLASS="SCREEN"
>{exec &lt;command&gt;}</PRE
></P
></LI
></UL
></DIV
><DIV
CLASS="SECT3"
><H3
CLASS="SECT3"
><A
NAME="STRING"
>6.3.4.2. String</A
></H3
><P
>'String' consists basic functions for strings operations.</P
><UL
><LI
><P
>Deleting of whitespace signs from the beginning and the end 
			of string.</P
><P
><PRE
CLASS="SCREEN"
>{trim &lt;string&gt;}</PRE
></P
></LI
></UL
></DIV
><DIV
CLASS="SECT3"
><H3
CLASS="SECT3"
><A
NAME="SQL"
>6.3.4.3. SQL</A
></H3
><P
>SQL extension implements functions for database operations.
		Allows to run SQL commands.</P
><UL
><LI
><P
>SQL commands</P
><P
><PRE
CLASS="SCREEN"
>{SELECT &lt;the_rest_of_query&gt;}
{INSERT &lt;the_rest_of_query&gt;}
{DELETE &lt;the_rest_of_query&gt;}
{UPDATE &lt;the_rest_of_query&gt;}
{CREATE &lt;the_rest_of_query&gt;}
{DROP &lt;the_rest_of_query&gt;}</PRE
></P
></LI
><LI
><P
>Returns SQL result rows count. Use it for non-select commands.</P
><P
><PRE
CLASS="SCREEN"
>{rows(&lt;sql&gt;)}</PRE
></P
></LI
><LI
><P
>Escapes a string for use within an SQL commands.</P
><P
><PRE
CLASS="SCREEN"
>{escape(&lt;string&gt;)}</PRE
></P
></LI
></UL
></DIV
><DIV
CLASS="SECT3"
><H3
CLASS="SECT3"
><A
NAME="CONSTS"
>6.3.4.4. Consts</A
></H3
><P
>Extension closely connected with LMS. Makes possible to
		create scripts without of LMS's database structure knowledge.
		Contains predefined constants, which consists data from database.
		Query defined in program is executed when constant is used first
		time. Constants names are uppercase. Each constant is an array
		with rows indexed starting from zero, and each row consist
		subvariables accessible by name (lowercase).</P
><UL
><LI
><P
>CUSTOMERS - customers list:
			    <TABLE
BORDER="0"
><TBODY
><TR
><TD
>id - customer ID</TD
></TR
><TR
><TD
>lastname - customer lastname</TD
></TR
><TR
><TD
>name - customer name</TD
></TR
><TR
><TD
>status - status</TD
></TR
><TR
><TD
>address - address</TD
></TR
><TR
><TD
>zip - postal code</TD
></TR
><TR
><TD
>city - city</TD
></TR
><TR
><TD
>email - email address</TD
></TR
><TR
><TD
>phone1, phone2, phone3 - phone numbers</TD
></TR
><TR
><TD
>ten - tax exempt number</TD
></TR
><TR
><TD
>ssn - security serial number</TD
></TR
><TR
><TD
>info - additional informations</TD
></TR
><TR
><TD
>message - warning contents</TD
></TR
><TR
><TD
>warning - warning status (status of all customer's nodes summary)</TD
></TR
><TR
><TD
>access - accessibility status (status of all customer's nodes summary)</TD
></TR
><TR
><TD
>balance - customer's balance</TD
></TR
></TBODY
></TABLE
>
			</P
></LI
><LI
><P
>NODES - nodes list (and network devices addresses):
			    <TABLE
BORDER="0"
><TBODY
><TR
><TD
>id - node ID</TD
></TR
><TR
><TD
>owner - customer name and lastname</TD
></TR
><TR
><TD
>ownerid - customer ID ('0' for devices)</TD
></TR
><TR
><TD
>name - node (device's address) name</TD
></TR
><TR
><TD
>access - status: connected/disconnected (1/0)</TD
></TR
><TR
><TD
>warning - warnings status: enabled/disabled (1/0)</TD
></TR
><TR
><TD
>netdev - device ID, to which is connected</TD
></TR
><TR
><TD
>lastonline - last activity timestamp</TD
></TR
><TR
><TD
>info - additional informations</TD
></TR
><TR
><TD
>message - warning message contents</TD
></TR
><TR
><TD
>mac - MAC address</TD
></TR
><TR
><TD
>passwd - password</TD
></TR
><TR
><TD
>ip - IP address</TD
></TR
><TR
><TD
>ip_pub - public IP address</TD
></TR
><TR
><TD
>linktype - connection type (0-cable, 1-air)</TD
></TR
></TBODY
></TABLE
>
			</P
></LI
><LI
><P
>NETWORKS - networks list:
			    <TABLE
BORDER="0"
><TBODY
><TR
><TD
>id - network ID</TD
></TR
><TR
><TD
>name - network name</TD
></TR
><TR
><TD
>address - IP address</TD
></TR
><TR
><TD
>mask - subnet mask (xxx.xxx.xxx.xxx)</TD
></TR
><TR
><TD
>prefix - number of bits in mask</TD
></TR
><TR
><TD
>size - network size (number of addresses)</TD
></TR
><TR
><TD
>interface - interface name</TD
></TR
><TR
><TD
>gateway - gateway address</TD
></TR
><TR
><TD
>dns - primary DNS server</TD
></TR
><TR
><TD
>dns2 - secondary DNS server</TD
></TR
><TR
><TD
>wins - WINS server</TD
></TR
><TR
><TD
>domain - domain name</TD
></TR
><TR
><TD
>dhcpstart - start of DHCP range</TD
></TR
><TR
><TD
>dhcpend - end of DHCP range</TD
></TR
></TBODY
></TABLE
>
			</P
></LI
></UL
></DIV
><DIV
CLASS="SECT3"
><H3
CLASS="SECT3"
><A
NAME="NET"
>6.3.4.5. Net</A
></H3
><P
>In this extension are included two functions (with lowercase names)
		destined to IP addresses and subnet masks operations.</P
><UL
><LI
><P
>Returns number of bits in subnet mask.</P
><P
><PRE
CLASS="SCREEN"
>mask2prefix(&lt;mask&gt;)</PRE
></P
></LI
><LI
><P
>Change octal IP address to long number.</P
><P
><PRE
CLASS="SCREEN"
>ip2long(&lt;address&gt;)</PRE
></P
></LI
><LI
><P
>Change long number to IP address octal format (xxx.xxx.xxx.xxx).</P
><P
><PRE
CLASS="SCREEN"
>long2ip(&lt;number&gt;)</PRE
></P
></LI
><LI
><P
>Calculate broadcast address from specified IP address and
			mask (any mask format).</P
><P
><PRE
CLASS="SCREEN"
>broadcast(&lt;address/mask&gt;)</PRE
></P
></LI
></UL
></DIV
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="DAEMON-PARSER-EXAMPLES"
>6.3.5. Example Scripts</A
></H2
><P
>Let's begin from simple script creating file <TT
CLASS="FILENAME"
>/etc/hosts</TT
>
	    with list of computers (and devices) IPs and names list. 
	    <DIV
CLASS="EXAMPLE"
><A
NAME="PARSER-E1"
></A
><P
><B
>Example 6-1. Parser: Creating /etc/hosts file</B
></P
><PRE
CLASS="SCREEN"
>{result = SELECT name, inet_ntoa(ipaddr) AS ip FROM nodes}\
127.0.0.1	localhost
{for (r=0; r&lt;number(result); r++)}\
{result[r].name}\t{result[r].ip}
{/for}\</PRE
></DIV
></P
><P
>How to create debtors list? It's easy with use of predefined 
	    constants.
	    <DIV
CLASS="EXAMPLE"
><A
NAME="PARSER-E2"
></A
><P
><B
>Example 6-2. Parser: Debtors list</B
></P
><PRE
CLASS="SCREEN"
>{for (r=0; r&lt;number(CUSTOMERS); r++)}\
    {if (CUSTOMERS[r].balance &#60; 0)}\
{CUSTOMERS[r].lastname} {CUSTOMERS[r].name}\t{CUSTOMERS[r].balance}
    {/if}\
{/for}\</PRE
></DIV
>
	    </P
><P
>Next example is longer. Here we are using especially 'exec'.
	    Script sends e-mails to customers with balance less than specified limit.	    
	    <DIV
CLASS="EXAMPLE"
><A
NAME="PARSER-E3"
></A
><P
><B
>Example 6-3. Parser: Notify module replacement</B
></P
><PRE
CLASS="SCREEN"
>{limit = 0}
{month = exec date +%B}
{year = exec date +%Y}
{customers = SELECT customers.id AS id, email, pin, name, lastname,
        SUM((type * -2 +7) * cash.value) AS balance
        FROM customers
        LEFT JOIN cash ON customers.id = cash.customerid AND (cash.type = 3 OR cash.type = 4)
        WHERE deleted = 0 AND email!=''
        GROUP BY customers.id, name, lastname, email, pin
        HAVING SUM((type * -2 +7) * cash.value) &lt; {limit}}

{for(i=0; i&lt;number(customers); i++)}

    {exec echo "NOTE: This message has been generated automatically.

We kindly remind that you have debt on your internet service provide account
for the amount of $ {customers[i].balance}.

If you have already regulated your subscription fees for current month, that
is {trim(month)} {trim(year)}, please just skip this message.

If you think this message was sent to you in error, please contact our
customer service representative.

All information about payments could be also found at:
http://bigpro.com/myAccount/

If you want to regulate your account status, please contact our accountant:

Aldfert Rule
phone: 0-509031337
e-mail: alde@staff.bigpro.com

PS. Last 10 operations on your account has been attached below for your
convenience.
--------------+--------------+-----------------------------
     Date     |    Value     |           Comment
--------------+--------------+-----------------------------" &gt; /tmp/mail}

    {last10 = SELECT comment, time, CASE WHEN type=4 THEN value*-1 ELSE value END AS value
            FROM cash WHERE customerid = {customers[i].id}
            ORDER BY time DESC LIMIT 10}
    
    {for(j=0; j&lt;number(last10); j++)}
    
        {exec echo "{last10[j].time}|\t{last10[j].value}|\t{last10[j].comment}" &gt;&gt; /tmp/mail}
    
    {/for}

    {exec mail -s "Liabilities information" -r lms@domain.tld {customers[i].email} &lt; /tmp/mail}

{/for}</PRE
></DIV
>
	    </P
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="daemon-modules.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>Home</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="devel.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>Modules</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="daemon.html"
ACCESSKEY="U"
>Up</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>For curious</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>