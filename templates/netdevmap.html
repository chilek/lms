{include file="header.html"}
<!--// $Id$ //-->
<H1>{$layout.pagetitle}</H1>
{if $emptydb}
    <TABLE WIDTH="100%"><TR><TD WIDTH="100%" ALIGN="Center">
	<BR><BR><FONT class="alert">{t}No such devices in database.{/t}</FONT>
    </TD></TR></TABLE>
{elseif !$ming && $type == 'flash'}
    <TABLE WIDTH="100%"><TR><TD WIDTH="100%" ALIGN="Center">
	<BR><BR><FONT class="alert">{t}Your PHP does not support Ming library required for map generation!{/t}</FONT>
    </TD></TR></TABLE>
{elseif $ming && (!$type || $type=='flash')}
<P ALIGN="CENTER">
<OBJECT classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,0,0" WIDTH="100%" HEIGHT="400" id="intro">
<PARAM NAME="movie" VALUE="?m=netdevmap&graph=flash&start={$start}{if $mini}&mini=1{/if}">
<PARAM NAME="loop" VALUE="false">
<PARAM NAME="quality" VALUE="high">
<PARAM NAME="bgcolor" VALUE="#EBE4D6">
<EMBED src="?m=netdevmap&graph=flash&start={$start}{if $mini}&mini=1{/if}" loop="false" quality="high" bgcolor="#EBE4D6" WIDTH="100%" HEIGHT="400" NAME="map"
  TYPE="application/x-shockwave-flash" PLUGINSPAGE="http://www.macromedia.com/go/getflashplayer"></EMBED>
</OBJECT>
</P>
{elseif $type=='openlayers'}
<script type="text/javascript" language="JavaScript" src="img/OpenLayers/OpenLayers.js"></script>
<script type="text/javascript" language="JavaScript" src="http://maps.google.com/maps/api/js?v=3.2&sensor=false"></script>
<div id="map"></div>
<script type="text/javascript" language="JavaScript">
<!--
	var map, devpopup = null, nodepopup = null;

	map = new OpenLayers.Map("map");
	var osmap = new OpenLayers.Layer.OSM();
	var gmap = new OpenLayers.Layer.Google("Google Maps");
	map.addLayer(gmap);
	map.addLayer(osmap);

//	var renderer = OpenLayers.Layer.Vector.prototype.renderers;

	var devicestyle = new OpenLayers.Style(
		{
			graphicWidth: 16,
			graphicHeight: 16,
			graphicXOffset: -8,
			graphicYOffset: -8
		},
		{
			rules: [
				new OpenLayers.Rule({
					filter: new OpenLayers.Filter.Comparison({
						type: OpenLayers.Filter.Comparison.EQUAL_TO,
						property: "state",
						value: 0
					}),
					symbolizer: {
						externalGraphic: "img/netdev_unk.png"
					}
				}),
				new OpenLayers.Rule({
					filter: new OpenLayers.Filter.Comparison({
						type: OpenLayers.Filter.Comparison.EQUAL_TO,
						property: "state",
						value: 1
					}),
					symbolizer: {
						externalGraphic: "img/netdev_on.png"
					}
				}),
				new OpenLayers.Rule({
					filter: new OpenLayers.Filter.Comparison({
						type: OpenLayers.Filter.Comparison.EQUAL_TO,
						property: "state",
						value: 2
					}),
					symbolizer: {
						externalGraphic: "img/netdev_off.png"
					}
				}),
				new OpenLayers.Rule({
					elseFilter: true,
					symbolizer: {
						externalGraphic: "img/netdev.png"
					}
				})
			]
		}
	);

	var nodestyle = new OpenLayers.Style(
		{
			graphicWidth: 16,
			graphicHeight: 16,
			graphicXOffset: -8,
			graphicYOffset: -8
		},
		{
			rules: [
				new OpenLayers.Rule({
					filter: new OpenLayers.Filter.Comparison({
						type: OpenLayers.Filter.Comparison.EQUAL_TO,
						property: "state",
						value: 0
					}),
					symbolizer: {
						externalGraphic: "img/node_unk.png"
					}
				}),
				new OpenLayers.Rule({
					filter: new OpenLayers.Filter.Comparison({
						type: OpenLayers.Filter.Comparison.EQUAL_TO,
						property: "state",
						value: 1
					}),
					symbolizer: {
						externalGraphic: "img/node_on.png"
					}
				}),
				new OpenLayers.Rule({
					filter: new OpenLayers.Filter.Comparison({
						type: OpenLayers.Filter.Comparison.EQUAL_TO,
						property: "state",
						value: 2
					}),
					symbolizer: {
						externalGraphic: "img/node_off.png"
					}
				}),
				new OpenLayers.Rule({
					elseFilter: true,
					symbolizer: {
						externalGraphic: "img/node.png"
					}
				})
			]
		}
	);

	var area = new OpenLayers.Bounds();
	var devices = [];
	{foreach from=$devices item=device}
		var lonLat = new OpenLayers.LonLat({$device.longitude}, {$device.latitude})
			.transform(new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject());
		area.extend(lonLat);
		devices.push(new OpenLayers.Feature.Vector(
			new OpenLayers.Geometry.Point(
				lonLat.lon,
				lonLat.lat
			), {
				state: {$device.state},
				name: "{$device.name}",
				lonlat: lonLat,
				id: {$device.id}
			}
		));
	{/foreach}

	var devicelayer = new OpenLayers.Layer.Vector("Devices", {
		styleMap: new OpenLayers.StyleMap(devicestyle)
	});
	devicelayer.addFeatures(devices);
	map.addLayer(devicelayer);

	var devlinks = [];
	{foreach from=$links item=link}
		var points = new Array(
			new OpenLayers.Geometry.Point({$link.srclon}, {$link.srclat})
				.transform(
					new OpenLayers.Projection("EPSG:4326"),
					map.getProjectionObject()
				),
			new OpenLayers.Geometry.Point({$link.dstlon}, {$link.dstlat})
				.transform(
					new OpenLayers.Projection("EPSG:4326"),
					map.getProjectionObject()
				)
			);
		var line = new OpenLayers.Geometry.LineString(points);
		{if !$link.type}
			var style = { strokeColor: '#00ff00',
		{else}
			{if $link.type == 2}
				var style = { strokeColor: '#ff0000',
			{else}
				var style = { strokeColor: '#0000ff',
			{/if}
		{/if}
				strokeOpacity: 0.5,
				strokeWidth: 2
			};
		var devlink = new OpenLayers.Feature.Vector(line, null, style);
		devlinks.push(devlink);
	{/foreach}

	var devlinklayer = new OpenLayers.Layer.Vector("Device Links");
	devlinklayer.addFeatures(devlinks);
	map.addLayer(devlinklayer);

	highlightdevicelayer = new OpenLayers.Control.SelectFeature(devicelayer, {
		hover: true,
		highlightOnly: true,
		clickout: false,
		toggle: false,
		multiple: false,
		eventListeners: {
			"featurehighlighted": function(e) {
				devpopup = new OpenLayers.Popup(null, e.feature.data.lonlat, new OpenLayers.Size(150, 50), e.feature.data.name);
				devpopup.setOpacity(0.8);
				devpopup.closeOnMove = true;
				map.addPopup(devpopup);
				OpenLayers.Event.stop(e);
			},
			"featureunhighlighted": function(e) {
				if (devpopup != null)
				{
					map.removePopup(devpopup);
					devpopup.destroy();
					devpopup = null;
				}
				OpenLayers.Event.stop(e);
			}
		}
	});
	selectdevicelayer = new OpenLayers.Control.SelectFeature(devicelayer, {
		clickout: true, toggle: false,
		multiple: false, hover: false,
		toggleKey: "ctrlKey", // ctrl key removes from selection
		multipleKey: "shiftKey", // shift key adds to selection
		onSelect: function(e) {
			document.location = "?m=netdevinfo&id=" + e.data.id;
			OpenLayers.Event.stop(e);
		}
	});
	map.addControl(highlightdevicelayer);
	map.addControl(selectdevicelayer);

	highlightdevicelayer.activate();
	selectdevicelayer.activate();

	var nodes = [];
	{foreach from=$nodes item=node}
		var lonLat = new OpenLayers.LonLat({$node.longitude}, {$node.latitude})
			.transform(new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject());
		area.extend(lonLat);
		nodes.push(new OpenLayers.Feature.Vector(
			new OpenLayers.Geometry.Point(
				lonLat.lon,
				lonLat.lat
			), {
				state: {$node.state},
				name: "{$node.name}",
				lonlat: lonLat,
				id: {$node.id}
			}
		));
	{/foreach}

	var nodelayer = new OpenLayers.Layer.Vector("Nodes", {
		styleMap: new OpenLayers.StyleMap(nodestyle)
	});
	nodelayer.addFeatures(nodes);
	map.addLayer(nodelayer);

	var nodelinks = [];
	{foreach from=$nodelinks item=link}
		var points = new Array(
			new OpenLayers.Geometry.Point({$link.nodelon}, {$link.nodelat})
				.transform(
					new OpenLayers.Projection("EPSG:4326"),
					map.getProjectionObject()
				),
			new OpenLayers.Geometry.Point({$link.netdevlon}, {$link.netdevlat})
				.transform(
					new OpenLayers.Projection("EPSG:4326"),
					map.getProjectionObject()
				)
			);
		var line = new OpenLayers.Geometry.LineString(points);
		{if !$link.type}
			var style = { strokeColor: '#00ff00',
		{else}
			{if $link.type == 2}
				var style = { strokeColor: '#ff0000',
			{else}
				var style = { strokeColor: '#0000ff',
			{/if}
		{/if}
				strokeOpacity: 0.5,
				strokeWidth: 2
			};
		var nodelink = new OpenLayers.Feature.Vector(line, null, style);
		nodelinks.push(nodelink);
	{/foreach}

	var nodelinklayer = new OpenLayers.Layer.Vector("Node Links");
	nodelinklayer.addFeatures(nodelinks);
	map.addLayer(nodelinklayer);

	highlightnodelayer = new OpenLayers.Control.SelectFeature(nodelayer, {
		hover: true,
		highlightOnly: true,
		clickout: false,
		toggle: false,
		multiple: false,
		eventListeners: {
			"featurehighlighted": function(e) {
				nodepopup = new OpenLayers.Popup(null, e.feature.data.lonlat, new OpenLayers.Size(150, 50), e.feature.data.name);
				nodepopup.setOpacity(0.8);
				nodepopup.closeOnMove = true;
				map.addPopup(nodepopup);
				OpenLayers.Event.stop(e);
			},
			"featureunhighlighted": function(e) {
				if (nodepopup != null)
				{
					map.removePopup(nodepopup);
					nodepopup.destroy();
					nodepopup = null;
				}
				OpenLayers.Event.stop(e);
			}
		}
	});
	selectnodelayer = new OpenLayers.Control.SelectFeature(nodelayer, {
		clickout: true, toggle: false,
		multiple: false, hover: false,
		toggleKey: "ctrlKey", // ctrl key removes from selection
		multipleKey: "shiftKey", // shift key adds to selection
		onSelect: function(e) {
			document.location = "?m=nodeinfo&id=" + e.data.id;
			OpenLayers.Event.stop(e);
		}
	});
	map.addControl(highlightnodelayer);
	map.addControl(selectnodelayer);

	highlightnodelayer.activate();
	selectnodelayer.activate();

	map.addControl(new OpenLayers.Control.ScaleLine());
	map.addControl(new OpenLayers.Control.LayerSwitcher());
	map.addControl(new OpenLayers.Control.MousePosition({ displayProjection: new OpenLayers.Projection("EPSG:4326") }));

	{if $devices || $nodes}
		map.zoomToExtent(area);
	{else}
		map.zoomToMaxExtent();
	{/if}
//-->
</script>
{elseif $gd} {* default if $type is not set or not 'flash' *}
<P ALIGN="CENTER">
<IMG SRC="?m=netdevmap&graph=true&start={$start}{if $mini}&mini=1{/if}" ALT="" USEMAP="#devices">
<MAP NAME="devices">
{section name=devicemap loop=$devicemap}
    <AREA SHAPE="CIRCLE" COORDS="{$devicemap[devicemap].x},{$devicemap[devicemap].y},10"  HREF="?m=netdevinfo&id={$devicemap[devicemap].id}">
{/section}
{section name=nodemap loop=$nodemap}
    <AREA SHAPE="CIRCLE" COORDS="{$nodemap[nodemap].x},{$nodemap[nodemap].y},10"  HREF="?m=nodeinfo&id={$nodemap[nodemap].id}">
{/section}
</MAP>
</P>
{else}
    <TABLE WIDTH="100%"><TR><TD WIDTH="100%" ALIGN="Center">
	<BR><BR><FONT class="alert">{t}Your PHP does not support GD library required for map generation!{/t}</FONT>
    </TD></TR></TABLE>
{/if}
{if !$emptydb && $type != 'openlayers'}
<P ALIGN="CENTER">
<FORM METHOD="GET" ACTION="?m=netdevmap" NAME="x">
	<INPUT type="submit" class="hiddenbtn">
	{t}Start map from:{/t}
	<INPUT TYPE="hidden" NAME="m" VALUE="netdevmap">
	<SELECT SIZE="1" NAME="start" onChange="document.x.submit();">
		{section name=a loop=$deviceslist}
		<OPTION VALUE="{$deviceslist[a].id}"{if $deviceslist[a].id eq $start} SELECTED{/if}>{$deviceslist[a].name}</OPTION>
		{/section}
	</SELECT>
	<INPUT TYPE="SUBMIT" VALUE="{t}Generate{/t}">
	<INPUT TYPE="CHECKBOX" NAME="mini" VALUE="1"{if $mini} CHECKED{/if}> {t}only devices{/t}
</FORM>
</P>
{/if}
{include file="footer.html"}
