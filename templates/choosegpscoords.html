<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<!--// $Id$ //-->
<html><head>
<meta name="GENERATOR" content="LMS {$layout.lmsv}">
<meta http-equiv="Content-Language" content="{$LANGDEFS.$_ui_language.html}">
<meta http-equiv="Content-Type" content="text/html; charset={$LANGDEFS.$_ui_language.html}">
<title>::: LMS :{if $layout.pagetitle neq ""} {$layout.pagetitle} :{/if}::</title>
<link href="img/style.css" rel="stylesheet" type="text/css">
<script type="text/javascript" src="img/common.js"></script>
{if $js}<script type="text/javascript">
<!--
	{$js}
//-->
</script>{/if}
{if $part eq "main"}
<script type="text/javascript" language="JavaScript" src="img/OpenLayers/OpenLayers.js"></script>
<script type="text/javascript" language="JavaScript" src="http://maps.google.com/maps/api/js?v=3.2&sensor=false"></script>
<script type="text/javascript" language="JavaScript">
<!--
	var map, devpopup = null, nodepopup = null;

	function click(e)
	{
		var lonlat = map.getLonLatFromViewPortPx(e.xy)
			.transform(map.getProjectionObject(), new OpenLayers.Projection("EPSG:4326"));
		sendvalue(targetfield1, lonlat.lon);
		sendvalue(targetfield2, lonlat.lat);
		OpenLayers.Event.stop(e);
	}

	function init()
	{
		map = new OpenLayers.Map("map");
		var osmap = new OpenLayers.Layer.OSM();
		var gmap = new OpenLayers.Layer.Google("Google Maps");
		map.addLayer(gmap);
		map.addLayer(osmap);

//		var renderer = OpenLayers.Layer.Vector.prototype.renderers;

		var devicestyle = new OpenLayers.Style(
			{
				graphicWidth: 16,
				graphicHeight: 16,
				graphicXOffset: -8,
				graphicYOffset: -8
			},
			{
				rules: [
					new OpenLayers.Rule({
						filter: new OpenLayers.Filter.Comparison({
							type: OpenLayers.Filter.Comparison.EQUAL_TO,
							property: "state",
							value: 0
						}),
						symbolizer: {
							externalGraphic: "img/netdev_unk.png"
						}
					}),
					new OpenLayers.Rule({
						filter: new OpenLayers.Filter.Comparison({
							type: OpenLayers.Filter.Comparison.EQUAL_TO,
							property: "state",
							value: 1
						}),
						symbolizer: {
							externalGraphic: "img/netdev_on.png"
						}
					}),
					new OpenLayers.Rule({
						filter: new OpenLayers.Filter.Comparison({
							type: OpenLayers.Filter.Comparison.EQUAL_TO,
							property: "state",
							value: 2
						}),
						symbolizer: {
							externalGraphic: "img/netdev_off.png"
						}
					}),
					new OpenLayers.Rule({
						elseFilter: true,
						symbolizer: {
							externalGraphic: "img/netdev.png"
						}
					})
				]
			}
		);

		var nodestyle = new OpenLayers.Style(
			{
				graphicWidth: 16,
				graphicHeight: 16,
				graphicXOffset: -8,
				graphicYOffset: -8
			},
			{
				rules: [
					new OpenLayers.Rule({
						filter: new OpenLayers.Filter.Comparison({
							type: OpenLayers.Filter.Comparison.EQUAL_TO,
							property: "state",
							value: 0
						}),
						symbolizer: {
							externalGraphic: "img/node_unk.png"
						}
					}),
					new OpenLayers.Rule({
						filter: new OpenLayers.Filter.Comparison({
							type: OpenLayers.Filter.Comparison.EQUAL_TO,
							property: "state",
							value: 1
						}),
						symbolizer: {
							externalGraphic: "img/node_on.png"
						}
					}),
					new OpenLayers.Rule({
						filter: new OpenLayers.Filter.Comparison({
							type: OpenLayers.Filter.Comparison.EQUAL_TO,
							property: "state",
							value: 2
						}),
						symbolizer: {
							externalGraphic: "img/node_off.png"
						}
					}),
					new OpenLayers.Rule({
						elseFilter: true,
						symbolizer: {
							externalGraphic: "img/node.png"
						}
					})
				]
			}
		);

		var area = new OpenLayers.Bounds();
		var devices = [];
		{foreach from=$devices item=device}
			var lonLat = new OpenLayers.LonLat({$device.longitude}, {$device.latitude})
				.transform(new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject());
			area.extend(lonLat);
			devices.push(new OpenLayers.Feature.Vector(
				new OpenLayers.Geometry.Point(
					lonLat.lon,
					lonLat.lat
				), {
					state: {$device.state},
					name: "{$device.name}",
					lonlat: lonLat,
					id: {$device.id}
				}
			));
		{/foreach}

		var devicelayer = new OpenLayers.Layer.Vector("Devices", {
			styleMap: new OpenLayers.StyleMap(devicestyle)
		});
		devicelayer.addFeatures(devices);
		map.addLayer(devicelayer);

		var devlinks = [];
		{foreach from=$links item=link}
			var points = new Array(
				new OpenLayers.Geometry.Point({$link.srclon}, {$link.srclat})
					.transform(
						new OpenLayers.Projection("EPSG:4326"),
						map.getProjectionObject()
					),
				new OpenLayers.Geometry.Point({$link.dstlon}, {$link.dstlat})
					.transform(
						new OpenLayers.Projection("EPSG:4326"),
						map.getProjectionObject()
					)
				);
			var line = new OpenLayers.Geometry.LineString(points);
			{if !$link.type}
				var style = { strokeColor: '#00ff00',
			{else}
				{if $link.type == 2}
					var style = { strokeColor: '#ff0000',
				{else}
					var style = { strokeColor: '#0000ff',
				{/if}
			{/if}
					strokeOpacity: 0.5,
					strokeWidth: 3
				};
			var devlink = new OpenLayers.Feature.Vector(line, null, style);
			devlinks.push(devlink);
		{/foreach}

		var devlinklayer = new OpenLayers.Layer.Vector("Device Links");
		devlinklayer.addFeatures(devlinks);
		map.addLayer(devlinklayer);

		highlightdevicelayer = new OpenLayers.Control.SelectFeature(devicelayer, {
			hover: true,
			highlightOnly: true,
			clickout: false,
			toggle: false,
			multiple: false,
			eventListeners: {
				"featurehighlighted": function(e) {
					devpopup = new OpenLayers.Popup(null, e.feature.data.lonlat, new OpenLayers.Size(150, 50), e.feature.data.name);
					devpopup.setOpacity(0.8);
					devpopup.closeOnMove = true;
					map.addPopup(devpopup);
					OpenLayers.Event.stop(e);
				},
				"featureunhighlighted": function(e) {
					if (devpopup != null)
					{
						map.removePopup(devpopup);
						devpopup.destroy();
						devpopup = null;
					}
					OpenLayers.Event.stop(e);
				}
			}
		});
		map.addControl(highlightdevicelayer);

		highlightdevicelayer.activate();

		var nodes = [];
		{foreach from=$nodes item=node}
			var lonLat = new OpenLayers.LonLat({$node.longitude}, {$node.latitude})
				.transform(new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject());
			area.extend(lonLat);
			nodes.push(new OpenLayers.Feature.Vector(
				new OpenLayers.Geometry.Point(
					lonLat.lon,
					lonLat.lat
				), {
					state: {$node.state},
					name: "{$node.name}",
					lonlat: lonLat,
					id: {$node.id}
				}
			));
		{/foreach}

		var nodelayer = new OpenLayers.Layer.Vector("Nodes", {
			styleMap: new OpenLayers.StyleMap(nodestyle)
		});
		nodelayer.addFeatures(nodes);
		map.addLayer(nodelayer);

		var nodelinks = [];
		{foreach from=$nodelinks item=link}
			var points = new Array(
				new OpenLayers.Geometry.Point({$link.nodelon}, {$link.nodelat})
					.transform(
						new OpenLayers.Projection("EPSG:4326"),
						map.getProjectionObject()
					),
				new OpenLayers.Geometry.Point({$link.netdevlon}, {$link.netdevlat})
					.transform(
						new OpenLayers.Projection("EPSG:4326"),
						map.getProjectionObject()
					)
				);
			var line = new OpenLayers.Geometry.LineString(points);
			{if !$link.type}
				var style = { strokeColor: '#00ff00',
			{else}
				{if $link.type == 2}
					var style = { strokeColor: '#ff0000',
				{else}
					var style = { strokeColor: '#0000ff',
				{/if}
			{/if}
					strokeOpacity: 0.5,
					strokeWidth: 3
				};
			var nodelink = new OpenLayers.Feature.Vector(line, null, style);
			nodelinks.push(nodelink);
		{/foreach}

		var nodelinklayer = new OpenLayers.Layer.Vector("Node Links");
		nodelinklayer.addFeatures(nodelinks);
		map.addLayer(nodelinklayer);

		highlightnodelayer = new OpenLayers.Control.SelectFeature(nodelayer, {
			hover: true,
			highlightOnly: true,
			clickout: false,
			toggle: false,
			multiple: false,
			eventListeners: {
				"featurehighlighted": function(e) {
					nodepopup = new OpenLayers.Popup(null, e.feature.data.lonlat, new OpenLayers.Size(150, 50), e.feature.data.name);
					nodepopup.setOpacity(0.8);
					nodepopup.closeOnMove = true;
					map.addPopup(nodepopup);
					OpenLayers.Event.stop(e);
				},
				"featureunhighlighted": function(e) {
					if (nodepopup != null)
					{
						map.removePopup(nodepopup);
						nodepopup.destroy();
						nodepopup = null;
					}
					OpenLayers.Event.stop(e);
				}
			}
		});
		map.addControl(highlightnodelayer);

		highlightnodelayer.activate();

		map.addControl(new OpenLayers.Control.ScaleLine());
		map.addControl(new OpenLayers.Control.LayerSwitcher());
		map.addControl(new OpenLayers.Control.MousePosition({ displayProjection: new OpenLayers.Projection("EPSG:4326") }));

		{if $devices || $nodes}
			map.zoomToExtent(area);
		{else}
			map.zoomToMaxExtent();
		{/if}

		map.events.register("click", map, click);
	}
//-->
</script>
{/if}
</head>
{if ! $part}
<frameset frameborder="0" framespacing="0" ROWS="30,*">
	<frame scrolling="no" frameborder="0" marginheight="0" marginwidth="0" name="cal" noresize src="?m=choosegpscoords&p=top">
	<frame scrolling="always" frameborder="0" marginheight="0" marginwidth="0" name="m" noresize src="?m=choosegpscoords&p=main">
</frameset>
{/if}
{if $part eq "main"}
<body onload="init()">
<div id="map" class="smallmap"></div>
</body>
{/if}
{if $part eq "top"}
<body>
<table cellpadding="5" width="100%">
	<tr>
		<td class="fall dark" align="center">
			<B>{t}Select gps coordinates:{/t}</B>
		</td>
	</tr>
</table>
{/if}
</html>
