<script src="img/location_box.js"></script>
{include file="google-maps.html"}

<style>

	.lms-ui-box-row-label {
		width: 12em;
	}

</style>

<form name="netdev" method="post" action="?m={$layout.module}{if $layout.module == 'netdevedit'}&id={$netdev.id}{/if}">
	<input type="submit" class="hiddenbtn">

	<div class="lms-ui-box-container">
		<div class="lms-ui-box-header">
			<img src="img/netdev.gif" alt=""> {trans("Name:")} <input
					type="text" name="netdev[name]" value="{$netdev.name}" maxlength="32" required {tip trigger="name"
			text="Enter device name" bold=1}>
		</div>
		<div class="lms-ui-box-contents">
			<div class="lms-ui-box-panel">
				<div class="lms-ui-box-row">
					<div class="lms-ui-box-row-icon">
						<img src="img/producer.gif" alt="">
					</div>
					<div class="lms-ui-box-row-label">
						{trans("Status:")}
					</div>
					<div class="lms-ui-box-row-field">
						<select name="netdev[status]" {tip text="Select device status" } value="{$netdev.status}">
							{foreach $_NETELEMENTSTATUSES as $idx => $status}
								<option value="{$idx}" {if $netdev.status== $idx} selected{/if}>{$status}</option>
							{/foreach}
						</select>
					</div>
				</div>

				<div class="lms-ui-box-row">
					<div class="lms-ui-box-row-icon">
						<img src="img/producer.gif" alt="">
					</div>
					<div class="lms-ui-box-row-label">
						{trans("Manufacturer:")}
					</div>
					<div class="lms-ui-box-row-field">
						<input type="hidden" id="producer-value" name="netdev[producer]">
						<input type="hidden" id="producerid-value" name="netdev[producerid]">
						<select id="producer" data-value="{$netdev.producer}" data-alt-field="#producerid-value"
								data-alt-invalid-field="#producer-value"
								{tip class="lms-ui-combobox" text="Enter producer name (optional)"}>
							{foreach $producers as $producer}
								<option value="{$producer.id}" {if $producer.id== $netdev.producer} selected{/if}>{$producer.name}</option>
							{/foreach}
						</select>
					</div>
				</div>

				<div class="lms-ui-box-row">
					<div class="lms-ui-box-row-icon">
						<img src="img/netdev_model.gif" alt="">
					</div>
					<div class="lms-ui-box-row-label">
						{trans("Model:")}
					</div>
					<div class="lms-ui-box-row-field">
						<input type="hidden" id="model-value" name="netdev[model]">
						<input type="hidden" id="modelid-value" name="netdev[modelid]">
						<select id="model" data-value="{$netdev.model}" data-alt-field="#modelid-value"
								data-alt-invalid-field="#model-value"
								{tip class="lms-ui-combobox" text="Enter device model (optional)" }> </select>
					</div>
				</div>

				<div class="lms-ui-box-row">
					<div class="lms-ui-box-row-icon">
						<img src="img/serialnumber.gif" alt="">
					</div>
					<div class="lms-ui-box-row-label">
						{trans("Serial number:")}
					</div>
					<div class="lms-ui-box-row-field">
						<input type="text" name="netdev[serialnumber]" value="{$netdev.serialnumber}"
								{tip text="Enter device serial number (optional)" }>
					</div>
				</div>

				<div class="lms-ui-box-row">
					<div class="lms-ui-box-row-icon">
						<img src="img/port.gif" alt="">
					</div>
					<div class="lms-ui-box-row-label">
						{trans("Number of ports:")}
					</div>
					<div class="lms-ui-box-row-field">
						<input type="text" name="netdev[ports]" value="{if $netdev.ports}{$netdev.ports}{/if}"
								{tip trigger="ports" text="Enter number of ports (optional)"}>
					</div>
				</div>

				<div class="lms-ui-box-row">
					<div class="lms-ui-box-row-icon">
						<img src="img/customer.gif" alt="">
					</div>
					<div class="lms-ui-box-row-label">
						{trans("Owner:")}
					</div>
					<div class="lms-ui-box-row-field">
						{if isset($customer.id)}
							{customerlist form="netdev" customers=$customers selected=$customer.id selectname="customer" inputname="netdev[ownerid]" select_id="ownerid_select" input_id="ownerid_input" customOnChange="customerChanged()"}
						{else}
							{customerlist form="netdev" customers=$customers selected=$netdev.ownerid selectname="customer" inputname="netdev[ownerid]" select_id="ownerid_select" input_id="ownerid_input" customOnChange="customerChanged()"}
						{/if}
					</div>
				</div>

				<div class="lms-ui-box-row" id="location_select">
					<div class="lms-ui-box-row-icon">
						<img src="img/home.gif" alt=""></div>
					<div class="lms-ui-box-row-label">
						{trans("Location:")}
					</div>
					<div class="lms-ui-box-row-field">
						<select id="customer_addresses" name="netdev[customer_address_id]" {tip trigger="address_id" }></select>
					</div>
				</div>

				<div class="lms-ui-box-row" id="location_box">
					<div class="lms-ui-box-row-icon">
						<img src="img/home.gif" alt=""></div>
					<div class="lms-ui-box-row-label">
						{trans("Location:")}
					</div>
					<div class="lms-ui-box-row-field">
						{location_box prefix = "netdev" address_id = "{$netdev.address_id}" location_name = "{$netdev.location_name}" location_state_name = "{$netdev.location_state_name}" location_state = "{$netdev.location_state}" location_city_name = "{$netdev.location_city_name}" location_city = "{$netdev.location_city}" location_postoffice = "{$netdev.location_postoffice}" location_street_name = "{$netdev.location_street_name}" location_street = "{$netdev.location_street}" location_house = "{$netdev.location_house}" location_flat = "{$netdev.location_flat}" location_zip = "{$netdev.location_zip}" location_country_id = "{$netdev.location_country_id}" teryt = "{$netdev.teryt}" }
					</div>
				</div>

				<div class="lms-ui-box-row">
					<div class="lms-ui-box-row-icon">
					</div>
					<div class="lms-ui-box-row-label">
					</div>
					<div class="lms-ui-box-row-field">
						<img src="img/network.gif" alt="">
						<span class="lms-ui-button" id="set_gps">{trans("Determine GPS coordinates automatically")}</span>
					</div>
				</div>

				<div class="lms-ui-box-row">
					<div class="lms-ui-box-row-icon">
						<img src="img/home.gif" alt=""></div>
					<div class="lms-ui-box-row-label">
						{trans("GPS longitude:")}
					</div>
					<div class="lms-ui-box-row-field">
						<input id="longitude" type="text" name="netdev[longitude]" value="{$netdev.longitude}"
								{tip text="Enter device longitude (optional)" trigger="longitude"}>
						<a href="javascript:void(0);" onClick="return gpscoordschoosewin(document.netdev.elements['netdev[longitude]'], document.netdev.elements['netdev[latitude]']);"
								{tip text="Click to select gps coordinates from map" }>&raquo;&raquo;&raquo;</A>
					</div>
				</div>

				<div class="lms-ui-box-row">
					<div class="lms-ui-box-row-icon">
						<img src="img/home.gif" alt=""></div>
					<div class="lms-ui-box-row-label">
						{trans("GPS latitude:")}
					</div>
					<div class="lms-ui-box-row-field">
						<input id="latitude" type="text" name="netdev[latitude]" value="{$netdev.latitude}" {tip text="Enter device latitude (optional)" trigger="latitude" }>
						<a href="javascript:void(0);"
								onClick="return gpscoordschoosewin(document.netdev.elements['netdev[longitude]'], document.netdev.elements['netdev[latitude]']);"
								{tip text="Click to select gps coordinates from map"}>&raquo;&raquo;&raquo;</A>
					</div>
				</div>

				{if ConfigHelper::checkConfig('phpui.radius')}
					<div class="lms-ui-box-row">
						<div class="lms-ui-box-row-icon">
							<img src="img/radius.gif" alt="">
						</div>
						<div class="lms-ui-box-row-label">
							{trans("Shortname:")}
						</div>
						<div class="lms-ui-box-row-field">
							<input type="text" name="netdev[shortname]" value="{$netdev.shortname}" maxlength="32" {tip
							trigger="shortname" text="Enter shortname (optional)"}>
						</div>
					</div>
					<div class="lms-ui-box-row">
						<div class="lms-ui-box-row-icon">
							<img src="img/radius.gif" alt="">
						</div>
						<div class="lms-ui-box-row-label">
							{trans("Type:")}
						</div>
						<div class="lms-ui-box-row-field">
							<select name="netdev[nastype]" {tip text="Select type (optional)" trigger="nastype"}>
								<option value="0"></option>
								{foreach $nastypes as $key => $item}
									<option value="{$key}" {if $key== $netdev.nastype} selected{/if}>{$item.name}</option>
								{/foreach}
							</select>
						</div>
					</div>
					<div class="lms-ui-box-row">
						<div class="lms-ui-box-row-icon">
							<img src="img/radius.gif" alt="">
						</div>
						<div class="lms-ui-box-row-label">
							{trans("Max clients:")}
						</div>
						<div class="lms-ui-box-row-field">
							<input type="text" name="netdev[clients]" value="{if $netdev.clients}{$netdev.clients}{/if}" {tip trigger="clients"
							text="Enter max clients (optional)"}>
						</div>
					</div>
					<div class="lms-ui-box-row">
						<div class="lms-ui-box-row-icon">
							<img src="img/radius.gif" alt=""></div>
						<div class="lms-ui-box-row-label">
							{trans("Secret:")}
						</div>
						<div class="lms-ui-box-row-field">
							<input type="text" name="netdev[secret]" value="{$netdev.secret}" maxlength="60" {tip
							text="Enter secret (optional)" }>
						</div>
					</div>
					<div class="lms-ui-box-row">
						<div class="lms-ui-box-row-icon">
							<img src="img/radius.gif" alt=""></div>
						<div class="lms-ui-box-row-label">
							{trans("Community:")}
						</div>
						<div class="lms-ui-box-row-field">
							<input type="text" name="netdev[community]" value="{$netdev.community}" maxlength="50" {tip text="Enter community (optional)" }>
						</div>
					</div>
				{/if}

				{if isset($channels)}
					<div class="lms-ui-box-row">
						<div class="lms-ui-box-row-icon">
							<img src="img/channel.gif" alt=""></div>
						<div class="lms-ui-box-row-label">
							{trans("Channel:")}
						</div>
						<div class="lms-ui-box-row-field">
							<select name="netdev[channelid]" {tip text="Select channel (optional)" trigger="channelid"}>
								<option value="">- {trans("none")} -
								</option>
								{foreach from=$channels item=item}
									<option value="{$item.id}" {if
											$item.id== $netdev.channelid}
									selected{/if}>{$item.name}</option>
								{/foreach}
							</select>
						</div>
					</div>
				{/if}

			</div>
			<div class="lms-ui-box-panel">

				<div class="lms-ui-box-row">
					<div class="lms-ui-box-row-icon">
						<img src="img/calendar.gif" alt="">
					</div>
					<div class="lms-ui-box-row-label">
						{trans("Purchase date:")}
					</div>
					<div class="lms-ui-box-row-field">
						<input type="text" name="netdev[purchasedate]" value="{if $netdev.purchasedate}{$netdev.purchasedate}{/if}" size="10" maxlength="10"
								placeholder="{trans(" yyyy/mm/dd")}" {tip class="calendar" trigger="purchasedate" text="Enter device purchase date in 'yyyy/mm/dd' format or click to choose date from calendar (optional)"}>
					</div>
				</div>

				<div class="lms-ui-box-row">
					<div class="lms-ui-box-row-icon">
						<img src="img/guarantee.png" alt=""></div>
					<div class="lms-ui-box-row-label">
						{trans("Guarantee period:")}
					</div>
					<div class="lms-ui-box-row-field">
						<select size="1" name="netdev[guaranteeperiod]" {tip text="Select device guarantee period (optional)"}>
							{foreach from=$_GUARANTEEPERIODS key=key item=period}
								<option value="{$key}" {if $netdev.guaranteeperiod== $key} selected{/if}>{$period}</option>
							{/foreach}
						</select>
					</div>
				</div>

				<div class="lms-ui-box-row">
					<div class="lms-ui-box-row-icon">
						<img src="img/desc.gif" alt=""></div>
					<div class="lms-ui-box-row-label">
						{trans("Description:")}
					</div>
					<div class="lms-ui-box-row-field">
						<textarea name="netdev[description]" cols="40" rows="5" {tip text="Enter additional information (optional)" }>{$netdev.description}</textarea>
					</div>
				</div>

				<div class="lms-ui-box-row">
					<div class="lms-ui-box-row-icon">
						<img src="img/money.gif" alt="">
					</div>
					<div class="lms-ui-box-row-label">
						{trans("Investment project:")}
					</div>
					<div class="lms-ui-box-row-field">
						<select name="netdev[invprojectid]" id="project" {tip text="Select project for this node"}>
							<option value="-2" {if ($netdev.invprojectid== '-2')} selected{/if}>- {trans("none")} -</option>
							<option value="-1" {if ($netdev.invprojectid== '-1')} selected{/if}>{trans("New project")}</option>
							<option value="1" {if ($netdev.invprojectid== '1')} selected{/if}>{trans("From root device")}</option>
							{foreach $NNprojects as $project}
								<option value="{$project.id}" {if ($netdev.invprojectid == $project.id)} selected{/if}>{$project.name}</option>
							{/foreach}
						</select> <input type="text" name="netdev[projectname]" value="{$netdev.projectname}"
								{tip text="Enter new project name" trigger="projectname"} id="projectname">
					</div>
				</div>

				<div class="lms-ui-box-row">
					<div class="lms-ui-box-row-icon">
						<img src="img/netnode.png" alt=""></div>
					<div class="lms-ui-box-row-label">
						{trans("Network node:")}
					</div>
					<div class="lms-ui-box-row-field">
						<select name="netdev[netnodeid]" {tip text="Select node"}>
							<option value="-1">
								{trans("None")}
							</option>
							{foreach $NNnodes as $node}
								<option value="{$node.id}"{if ($netdev.netnodeid == $node.id)} selected{/if}>{$node.name}</option>
							{/foreach}
						</select>
					</div>
				</div>

			</div>
		</div>
		<div class="lms-ui-box-buttons">
			{block name="netdevmodify-buttons"}
				<a href="javascript:void(0);" id="submit_button" accesskey="s">{trans("Submit")}
					<img src="img/save.gif" alt=""></a>
				<a href="?m=netdevlist">{trans("Cancel")} <img src="img/cancel.gif" alt=""></a>
			{/block}
		</div>
	</div>
</form>

<script>

	var models = JSON.parse('{$models}');

	function updateModels(producerid) {
		var modelelem = $('#model');
		var modelid = modelelem.scombobox('val');
		var modelonlist = false;
		var values = [];

		if (producerid.match(/^[0-9]+$/)) {
			$.each(models['p' + producerid], function (key, item) {
				if (item.id == modelid) {
					modelonlist = true;
				}
				values.push({
					value: item.id,
					text: item.name
				});
			});
		} else {
			if (producerid == '') {
				$('#producer').scombobox('val', '');
			}
			if (modelid == '') {
				$('#model').scombobox('val', '');
			} else if (!modelid.match(/^[0-9]+$/)) {
				modelonlist = true;
			}
		}
		modelelem.scombobox('fill', values);
		if (producerid.match(/^[0-9]+$/)) {
			modelelem.scombobox('val', models['p' + producerid][Object.keys(models['p' + producerid])[0]].id);
			modelelem.trigger('change');
		}
		if (modelonlist) {
			modelelem.scombobox('val', modelid);
		}
	}

	$(function () {
		$('[name="netdev[name]"]').focus();

		$('#project').change(function () {
			if ($(this).val() == '-1') {
				$('#projectname').show();
			} else {
				$('#projectname').hide();
			}
		}).change();

		updateModels('{$netdev.producer}');

		$('#producer').scombobox('change', function () {
			updateModels($(this).closest('.scombobox').scombobox('val'));
		});

		$('#submit_button').click(function() {
			$('form[name="netdev"]').submit();
		});
	});

	/*
     * \brief Update address location coordinates. Require google API key.
     */
	$('#set_gps').click(function () {
		var owner_id = $('#ownerid_input').val();
		var location = null;

		if (owner_id != 'undefined' && owner_id > 0 && $('#customer_addresses').val() > 0) {
			location = {
				address_id: $('#customer_addresses').val()
			}
		} else if ($('[data-address="city"]').val().length) {
			location = {
				street: $('[data-address="street"]').val(),
				house: $('[data-address="house"]').val(),
				flat: $('[data-address="flat"]').val()
			}
			if ($('[data-address="teryt-checkbox"]').prop('checked') && $('[data-address="city-hidden"]').val() > 0) {
				location.city_id = $('[data-address="city-hidden"]').val();
				location.street_id = $('[data-address="street-hidden"]').val();
			} else {
				location.state = $('[data-address="state"]').val();
				location.zip = $('[data-address="zip"]').val();
				location.city = $('[data-address="city"]').val();
			}
		}

		if (location) {
			xajax_get_gps_coordinates(location, 'latitude', 'longitude');
		}
	});

	/*
		$(function () {
			$("#modelselect").click(function () {
				netdevmodelchoosewin('netdev', 'netdev', $('#netdevmodelid'), $('#producer').val(), $('#model').val());
				event.preventDefault();
			});
		});
	*/

	/*!
     * \brief Show / hide location choose box.
     * If owner id is set then show list with customer addresses,
     * else show location box to manual set location for network device.
     *
     * \param customer_id
     */
	function updateLocationBoxesDisplay(customer_id) {
		if (customer_id == 'undefined' || customer_id == 0) {
			$('#location_select').hide();
			$('#location_box').show();
		} else {
			$('#location_select').show();
			$('#location_box').hide();
		}
	}

	var customer_addresses = new LmsUiIconSelectMenu("#customer_addresses");

	/*!
     * \brief Update customer addresses list on input change.
     */
	function customerChanged() {
		var id = $('#ownerid_input').val();

		updateLocationBoxesDisplay(id);

		getCustomerAddresses(id, function (addresses) {
			customer_addresses.setAddressList(addresses);
		});
	}

	updateLocationBoxesDisplay({intval($netdev.ownerid)});

	getCustomerAddresses({intval($netdev.ownerid)},
		function (addresses) {
			customer_addresses.setAddressList(addresses);
			{if $netdev.address_id && $netdev.ownerid}
			$('#customer_addresses').val({$netdev.address_id});
			{/if}
			customer_addresses.init();
		}
	);

</script>
