{extends file="layout.html"}
{block name=title}LMS: {$layout.pagetitle|striphtml}{/block}
{block name=module_content}
<!--// $Id$ //-->
<H1>{$layout.pagetitle}</H1>
{if $docid}
<SCRIPT type="text/javascript">
<!--
	window.open('?m=documentview&id={$docid}');
//-->
</SCRIPT>
{/if}
<SCRIPT type="text/javascript">
<!--
	function delete_docs()
	{
		if (!confirm('{trans("Are you sure, you want to delete selected documents?")}'))
			return;

		document.page.action="?m=documentdel&is_sure=1";
		document.page.target="";
		document.page.submit();
	}

	function print_docs()
	{
		document.page.action="?m=documentview";
		document.page.target="_blank";
		document.page.submit();
	}

	function mark_docs()
	{
		document.page.action="?m=documentedit&action=confirm";
		document.page.target="";
		document.page.submit();
	}

	function send_documents() {
		document.page.action="?m=documentsend";
		document.page.target="_blank";
		document.page.submit();
	}

	function filter() {
		// uncheck checkboxes, we don't need them in GET
		for (var i=0; i<document.page.elements.length; i++)
		{
			var e = document.page.elements[i];
			if (e.type == 'checkbox')
				e.checked = "";
		}
		document.page.action="";
		document.page.target="";
		document.page.method="get";
		document.page.submit();
	}

	function toggle_all_attachments(docid) {
		var elem = $('#allattachments-' + docid);
		var toggle = $('#allattachments-toggle-' + docid);
		elem.toggle();
		if (elem.is(':visible'))
			toggle.html('<img src="img/desc_order.gif">');
		else
			toggle.html('<img src="img/asc_order.gif">');
	}
//-->
</SCRIPT>
<FORM METHOD="POST" NAME="page" ACTION="?m=documentedit&amp;action=confirm">
<INPUT type="hidden" name="m" value="documentlist">
<INPUT type="hidden" name="page" value="1">
<TABLE class="lmsbox">
	<COLGROUP>
		<COL style="width: 1%;">
		<COL style="width: 1%;">
		<COL style="width: 1%;">
		<COL style="width: 96%;">
		<COL style="width: 1%;">
	</COLGROUP>
    <THEAD>
	<TR>
		<TD class="nobr">
			<A href="?m=documentlist&o=cdate{if $listdata.direction == "asc" && $listdata.order == "cdate"},desc{/if}">{trans("Creation date<!document>")}</A>{if $listdata.order == "cdate"}<IMG src="img/{if $listdata.direction == "desc"}asc{else}desc{/if}_order.gif" alt="">{/if}
			/ <A href="?m=documentlist&o=sdate{if $listdata.direction == "asc" && $listdata.order == "sdate"},desc{/if}">{trans("Confirmation date<!document>")}:</A>{if $listdata.order == "sdate"}<IMG src="img/{if $listdata.direction == "desc"}asc{else}desc{/if}_order.gif" alt="">{/if}
			<BR><B>{trans("Number:")}</B>
		</TD>
		<TD class="nobr">
			<A href="?m=documentlist&o=user{if $listdata.direction == "asc" && $listdata.order == "user"},desc{/if}">{trans("Created by<!document>")}</A>{if $listdata.order == "user"}<IMG src="img/{if $listdata.direction == "desc"}asc{else}desc{/if}_order.gif" alt="">{/if}
			/ <A href="?m=documentlist&o=cuser{if $listdata.direction == "asc" && $listdata.order == "cuser"},desc{/if}">{trans("Confirmed by<!document>")}:</A>{if $listdata.order == "cuser"}<IMG src="img/{if $listdata.direction == "desc"}asc{else}desc{/if}_order.gif" alt="">{/if}
			<BR><A href="?m=documentlist&o=type{if $listdata.direction == "asc" && $listdata.order == "type"},desc{/if}"><B>{trans("Type:")}</B></A>{if $listdata.order == "type"}<IMG src="img/{if $listdata.direction == "desc"}asc{else}desc{/if}_order.gif" alt="">{/if}
		</TD>
		<TD class="nobr">
			<A href="?m=documentlist&amp;o=title{if $listdata.direction == "asc" && $listdata.order == "title"},desc{/if}">{trans("Title:")}</A>{if $listdata.order == "title"}<IMG src="img/{if $listdata.direction == "desc"}asc{else}desc{/if}_order.gif" alt="">{/if}
			<BR>{trans("Period:")}
			<BR>{trans("Reference document:")}
		</TD>
		<TD class="nobr"> <A href="?m=documentlist&amp;o=customer{if $listdata.direction == "asc" && $listdata.order == "customer"},desc{/if}">{trans("Customer:")}</A>{if $listdata.order == "customer"}<IMG src="img/{if $listdata.direction == "desc"}asc{else}desc{/if}_order.gif" alt="">{/if}</TD>
		<TD class="text-right nobr">
			<A href="?m=documentadd&amp;cid={$listdata.customer}&amp;typeOD={$listdata.type}">{trans("New Document")}</A> <IMG src="img/save.gif" alt="">
		</TD>
	</TR>
	<TR>
		<TD colspan="5">
			<table>
				<tr>
					<td>
						<table>
							<tr>
								<td>
									<span class="bold">{trans("Filter:")}</span> {trans("Customer:")}
										{customerlist form="page" customers=$customers selected=$listdata.customer selectname="customer" inputname="c" firstoption="- all customers -"}
									&nbsp;{trans("Type:")}
									<SELECT size="1" name="t" ONCHANGE="filter()">
										<OPTION value="0"{if !$listdata.type} SELECTED {/if}>{trans("- all -")}</OPTION>
										{foreach from=$_DOCTYPES key=key item=item}{if $key < 0}
										<OPTION VALUE="{$key}"{if $listdata.type==$key} SELECTED{/if}>{$item}</OPTION>
										{/if}{/foreach}
									</SELECT>&nbsp;
									{trans("User:")}&nbsp;
									{if empty($users)}
									<input type="hidden" name="usertype" value="">
									<input type="hidden" name="u" value="">
									{else}
									<SELECT name="usertype" onchange="filter()">
										<option value="creator"{if empty($listdata.usertype) || $listdata.usertype == 'creator'} selected{/if}>{trans("creator")}</option>
										<option value="authorising"{if $listdata.usertype == 'authorising'} selected{/if}>{trans("authorising")}</option>
									</SELECT>&nbsp;
									<SELECT name="u" onchange="filter()">
										<option value=""{if empty($listdata.userid)} selected{/if}>{trans("- all -")}</option>
										{foreach $users as $user}
										<option value="{$user.id}"{if $user.id == $listdata.userid} selected{/if}>{$user.name}</option>
										{/foreach}
									</SELECT>
									{/if}
								</td>
							</tr>
							<tr>
								<td>
									<span class="bold">{trans("Period:")}</span>&nbsp;
									<SELECT name="periodtype" ONCHANGE="filter()">
										<OPTION value="creationdate"{if empty($listdata.periodtype) || $listdata.periodtype == 'creationdate'} selected{/if}>{trans("creation date")}</OPTION>
										<OPTION value="confirmationdate"{if $listdata.periodtype == 'confirmationdate'} selected{/if}>{trans("confirmation date")}</OPTION>
										<OPTION value="fromdate"{if $listdata.periodtype == 'fromdate'} selected{/if}>{trans("'from' date")}</OPTION>
										<OPTION value="todate"{if $listdata.periodtype == 'todate'} selected{/if}>{trans("'to' date")}</OPTION>
									</SELECT>
									{trans("from")}&nbsp;<INPUT TYPE="text" NAME="from" SIZE="10" maxlength="10" value="{if $listdata.from > 0}{$listdata.from|date_format:"%Y/%m/%d"}{/if}" {tip class="calendar" text="Enter date in YYYY/MM/DD format (empty field means no limit) or click to choose it from calendar"}>
									{trans("to")}&nbsp;<INPUT TYPE="text" NAME="to" SIZE="10" maxlength="10" value="{if $listdata.to > 0}{$listdata.to|date_format:"%Y/%m/%d"}{/if}" {tip class="calendar" text="Enter date in YYYY/MM/DD format (empty field means no limit) or click to choose it from calendar"}>&nbsp;

									{if count($numberplans) > 0}
									{trans("Number plan:")}
									<SELECT name="p" onChange="filter()" {tip text="Select numbering plan"}>
										<OPTION value="0">- {trans("all")} -</OPTION>
										{foreach $numberplans as $plan}
										{$period = $plan.period}
										<OPTION value="{$plan.id}"{if $listdata.numberplan == $plan.id} selected{/if}>{number number=$plan.next template=$plan.template time=$invoice.cdate customerid=$listdata.customer} ({$_NUM_PERIODS.$period})</OPTION>
										{/foreach}
									</SELECT>&nbsp;
									{else}
									<input type="hidden" name="p" value="0">
									{/if}

									{trans("Status:")}
									<SELECT name="s" onChange="filter()" {tip text="Select document status"}>
										<OPTION value="-1">- {trans("all")} - </OPTION>
										<OPTION value="0"{if $listdata.status == 0} selected{/if}>{trans("unconfirmed")}</OPTION>
										<OPTION value="1"{if $listdata.status == 1} selected{/if}>{trans("confirmed")}</OPTION>
									</SELECT>&nbsp;
								</td>
							</tr>
						</table>
					</td>
					<td>
						<A href="javascript: filter();">&raquo;&raquo;&raquo;</A>&nbsp;
					</td>
				</tr>
			</table>
		</TD>
	</TR>
	{if $listdata.total != 0}
	<TR>
		<TD class="pagination" COLSPAN="5">
			{include file="scroller.html" loop=$documentlist}
		</TD>
	</TR>
	{/if}
    </THEAD>
    <TBODY class="lms-ui-multi-check">
	{cycle values="light,lucid" print=false}
	{section loop=$documentlist name=documentlist start=$start max=$pagelimit}
	{assign var=doc value=$documentlist[documentlist]}
	{assign var=docid value=$doc.docid}
	<TR class="highlight {cycle}{if $doc.closed} blend{/if}"  >
		<TD class="nobr" onclick="window.open('?m=documentview&amp;id={$doc.docid}');"{if $doc.description} {tip text=$doc.description}{/if}>
			{$doc.cdate|date_format:"%Y/%m/%d %H:%M"}{if $doc.sdate} / {$doc.sdate|date_format:"%Y/%m/%d %H:%M"}{/if}
			{if $doc.number}<BR>
				<B>{number number=$doc.number template=$doc.template time=$doc.cdate customerid=$doc.customerid}</B>
			{/if}
		</TD>
		<TD class="nobr" onclick="window.open('?m=documentview&amp;id={$doc.docid}');">
			{$doc.username}{if $doc.cuserid} / {$doc.cusername}{/if}
			<BR><B>{assign var=type value=$doc.type}{$_DOCTYPES.$type}</B>
		</TD>
		<TD class="nobr" onclick="window.open('?m=documentview&amp;id={$doc.docid}');">
			{$doc.title|truncate:40:"...":true}
			{if $doc.fromdate || $doc.todate}<BR>
			    {if $doc.fromdate}{trans("from")} {$doc.fromdate|date_format:"%Y/%m/%d"}{/if}
			    {if $doc.todate}{trans("to")} {$doc.todate|date_format:"%Y/%m/%d"}{/if}
			{/if}
			{if $doc.reference}<br>
			<a href="?m=documentview&id={$doc.reference.id}" rel="external">
				{t a=$_DOCTYPES[$doc.reference.type] b=$doc.reference.fullnumber c=$doc.reference.cdate|date_format:"%Y/%m/%d"}$a no. $b issued on $c{/t}
			</a>
			{/if}
		</TD>
		<TD class="nobr"><A href="?m=customerinfo&amp;id={$doc.customerid}">{$doc.name|truncate:40:"...":true}</A></TD>
		<TD class="text-right nobr">
			{if $doc.senddocuments}
			<a class="documentsend" href="?m=documentsend&id={$doc.docid}"><img src="img/mail.gif" alt="{trans("Document send")}" title="{trans("Document send")}"></a>
			{/if}
			{assign var=type value=$doc.type}
			<a href="?m=documentview&amp;id={$doc.docid}&amp;save=1"><img src="img/save.gif" alt="{trans("Save")}" title="{trans("Save")}"></a>
			{if ! $doc.closed && ($docrights.$type.rights & 4)}
			<a href="?m=documentedit&amp;id={$doc.docid}&amp;action=confirm"><img src="img/confirm.gif" alt="{trans("Confirm")}" title="{trans("Confirm")}"></a>
			{/if}
			{if ($docrights.$type.rights & 16)}
			<a onclick="return confirmLink(this, '{trans("Are you sure, you want to remove that document?")}')" HREF="?m=documentdel&amp;id={$doc.docid}"><img src="img/delete.gif" alt="{trans("Delete")}" title="{trans("Delete")}"></a>
			{/if}
			{if ($docrights.$type.rights & 8)}
			<a href="?m=documentedit&amp;id={$doc.docid}"><img src="img/edit.gif" alt="{trans("Edit")}" title="{trans("Edit")}"></a>
			{/if}
			{$docattach = $doc.attachments[0]}
			{if $docattach.main || count($doc.attachments) == 1}
			{documentview id="{$doc.docid}-{$docattach.id}" type=$docattach.contenttype name=$docattach.filename
				url="?m=documentview&id={$doc.docid}" external=true
				text="<img src=\"img/{if preg_match('/pdf/',$docattach.contenttype)}pdf{elseif preg_match('/csv|excel|spreadsheet/',$docattach.contenttype)}xls{else}view{/if}.gif\">"}
			{/if}
			{if count($doc.attachments) > 1}
			<a href="#" id="allattachments-toggle-{$doc.docid}" onclick="toggle_all_attachments({$doc.docid}); return false;" title="{trans("more document attachments")}">
				<img src="img/asc_order.gif">
			</a>
			{/if}
			<INPUT TYPE="checkbox" NAME="marks[{$docid}]" VALUE="{$docid}" class="lms-ui-multi-check"{if $marks.$docid} checked{/if}>
			<div id="allattachments-{$doc.docid}" style="display: none;">
				{foreach $doc.attachments as $docattach}
				{if $docattach@first && $docattach.main}{continue}{/if}
				{documentview id="{$doc.docid}-{$docattach.id}" type=$docattach.contenttype name=$docattach.filename
					url="?m=documentview&id={$doc.docid}&attachmentid={$docattach.id}" external=true
					text="{$docattach.filename} <img src=\"img/{if preg_match('/pdf/',$docattach.contenttype)}pdf{elseif preg_match('/csv|excel|spreadsheet/',$docattach.contenttype)}xls{else}view{/if}.gif\">"}
				<br>
				{/foreach}
			</div>
		</TD>
	</TR>
	{sectionelse}
	<TR>
		<TD colspan="5" class="empty-table">
			<p>{trans("No such documents matching search criteria or list is empty.")}</p>
		</TD>
	</TR>
	{/section}
    </TBODY>
    <TFOOT>
	{if $listdata.total != 0}
	<TR>
		<TD class="pagination" COLSPAN="5">
			{include file="scroller.html" loop=$documentlist}
		</TD>
	</TR>
	{/if}
	<TR>
		<TD COLSPAN="5">
			{if count($documentlist) > 0}
			<TABLE WIDTH="100%">
				<TR>
					<TD class="nobr">
						<A href="javascript:send_documents();" OnClick="return confirm('{trans("Are you sure, you want to send documents to customers?")}')">{trans("Send documents")} <IMG src="img/mail.gif" alt=""></A>&nbsp;
						<A HREF="javascript:print_docs();">{trans("Print")} <IMG SRC="img/print.gif" ALT="{trans("Print")}"></A>&nbsp;
						<A HREF="javascript:mark_docs();">{trans("Confirm")} <IMG SRC="img/confirm.gif" ALT="{trans("Confirm")}"></A>&nbsp;
						<A HREF="javascript:delete_docs();">{trans("Delete")} <IMG SRC="img/delete.gif" ALT="{trans("Delete")}"></A>
					</TD>
					<TD class="text-right nobr">
						<label>
							{trans("Check All")}
							<INPUT TYPE="checkbox" NAME="allbox" class="lms-ui-multi-check-all" VALUE="1">
						</label>
					</TD>
				</TR>
			</TABLE>
			{/if}
		</TD>
	</TR>
    </TFOOT>
</TABLE>
</FORM>
<script>
	$('.documentsend').click(function() {
		if (!confirm('{trans("Are you sure, you want to send document to customer?")}')) {
			return false;
		}
		window.open($(this).attr('href'));
		return false;
	});
</script>
{/block}
