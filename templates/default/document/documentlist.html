{extends file="layout.html"}
{block name=title}LMS: {$layout.pagetitle|striphtml}{/block}
{block name=module_content}
<!--// $Id$ //-->
<H1>{$layout.pagetitle}</H1>
{if $docid}
<SCRIPT>

	window.open('?m=documentview&id={$docid}');

</SCRIPT>
{/if}
<SCRIPT>
	function delete_docs()
	{
		if (!confirm('{trans("Are you sure, you want to delete selected documents?")}'))
			return;

		document.page.action="?m=documentdel&is_sure=1";
		document.page.target="";
		document.page.submit();
	}

	function print_docs()
	{
		document.page.action="?m=documentview";
		document.page.target="_blank";
		document.page.submit();
	}

	function mark_docs()
	{
		document.page.action="?m=documentedit&action=confirm";
		document.page.target="";
		document.page.submit();
	}

	function archive_docs() {
		document.page.action="?m=documentedit&action=archive";
		document.page.target="";
		document.page.submit();
	}

	function send_documents() {
		document.page.action="?m=documentsend";
		document.page.target="_blank";
		document.page.submit();
	}

	function toggle_all_attachments(docid) {
		var elem = $('#allattachments-' + docid);
		var toggle = $('#allattachments-toggle-' + docid);
		elem.toggle();
		if (elem.is(':visible'))
			toggle.html('<img src="img/desc_order.gif">');
		else
			toggle.html('<img src="img/asc_order.gif">');
	}

	function applyFilter() {
		document.choosefilter.submit();
	}
</SCRIPT>
<TABLE class="lmsbox lms-ui-background-cycle">
	<COLGROUP>
		<COL style="width: 1%;">
		<COL style="width: 1%;">
		<COL style="width: 1%;">
		<COL style="width: 96%;">
		<COL style="width: 1%;">
	</COLGROUP>
    <THEAD>
	<TR>
		<TD class="nobr">
			<A href="?m=documentlist&o=cdate{if $filter.direction == "asc" && $filter.order == "cdate"},desc{/if}">{trans("Creation date<!document>")}</A>{if $filter.order == "cdate"}<IMG src="img/{if $filter.direction == "desc"}asc{else}desc{/if}_order.gif" alt="">{/if}
			/ <A href="?m=documentlist&o=sdate{if $filter.direction == "asc" && $filter.order == "sdate"},desc{/if}">{trans("Confirmation date<!document>")}:</A>{if $filter.order == "sdate"}<IMG src="img/{if $filter.direction == "desc"}asc{else}desc{/if}_order.gif" alt="">{/if}
			<BR><B>{trans("Number:")}</B>
		</TD>
		<TD class="nobr">
			<A href="?m=documentlist&o=user{if $filter.direction == "asc" && $filter.order == "user"},desc{/if}">{trans("Created by<!document>")}</A>{if $filter.order == "user"}<IMG src="img/{if $filter.direction == "desc"}asc{else}desc{/if}_order.gif" alt="">{/if}
			/ <A href="?m=documentlist&o=cuser{if $filter.direction == "asc" && $filter.order == "cuser"},desc{/if}">{trans("Confirmed by<!document>")}:</A>{if $filter.order == "cuser"}<IMG src="img/{if $filter.direction == "desc"}asc{else}desc{/if}_order.gif" alt="">{/if}
			<BR><A href="?m=documentlist&o=type{if $filter.direction == "asc" && $filter.order == "type"},desc{/if}"><B>{trans("Type:")}</B></A>{if $filter.order == "type"}<IMG src="img/{if $filter.direction == "desc"}asc{else}desc{/if}_order.gif" alt="">{/if}
		</TD>
		<TD class="nobr">
			<A href="?m=documentlist&amp;o=title{if $filter.direction == "asc" && $filter.order == "title"},desc{/if}">{trans("Title:")}</A>{if $filter.order == "title"}<IMG src="img/{if $filter.direction == "desc"}asc{else}desc{/if}_order.gif" alt="">{/if}
			<BR>{trans("Period:")}
			<BR>{trans("Reference document:")}
		</TD>
		<TD class="nobr"> <A href="?m=documentlist&amp;o=customer{if $filter.direction == "asc" && $filter.order == "customer"},desc{/if}">{trans("Customer:")}</A>{if $filter.order == "customer"}<IMG src="img/{if $filter.direction == "desc"}asc{else}desc{/if}_order.gif" alt="">{/if}</TD>
		<TD class="text-right nobr">
			<A href="?m=documentadd&amp;cid={$filter.customer}&amp;typeOD={$filter.type}">{trans("New Document")}</A> <IMG src="img/save.gif" alt="">
		</TD>
	</TR>
	<TR>
		<TD colspan="5">
			<div class="lms-ui-filter-container">
				<div class="lms-ui-filter-definition">
                    <FORM method="GET" name="choosefilter">
					<input type="hidden" name="m" value="documentlist">

					<span class="bold">{trans("Filter:")}</span> {trans("Customer:")}
					{customerlist form="page" customers=$customers selected=$filter.customer selectname="customer" inputname="c" firstoption="- all customers -"}

					{trans("Type:")}
					<input type="hidden" name="t[]" value="0">
					<SELECT size="1" name="t[]" onChange="javascript:applyFilter();" multiple class="lms-ui-multiselect" data-default-value="{trans("- all -")}">
						{foreach $_DOCTYPES as $key => $item}{if $key < 0}
						<OPTION VALUE="{$key}"{if is_array($filter.type) && in_array($key, $filter.type)} selected{/if}>{$item}</OPTION>
						{/if}{/foreach}
					</SELECT>

					{trans("Service:")}
					<input type="hidden" name="service[]" value="0">
					<SELECT size="1" name="service[]" onChange="javascript:applyFilter();" multiple class="lms-ui-multiselect" data-default-value="{trans("- all -")}">
						{foreach $_SERVICETYPES as $key => $item}
						<OPTION VALUE="{$key}"{if is_array($filter.service) && in_array($key, $filter.service)} selected{/if}>{$item}</OPTION>
						{/foreach}
					</SELECT>

					{trans("User:")}
					{if empty($users)}
					<input type="hidden" name="usertype" value="">
					<input type="hidden" name="u[]" value="0">
					{else}
					<SELECT name="usertype" onChange="javascript:applyFilter();">
						<option value="creator"{if empty($filter.usertype) || $filter.usertype == 'creator'} selected{/if}>{trans("creator")}</option>
						<option value="authorising"{if $filter.usertype == 'authorising'} selected{/if}>{trans("authorising")}</option>
						<option value="archivizator"{if empty($filter.usertype) || $filter.usertype == 'archivizator'} selected{/if}>{trans("archiwizator")}</option>
					</SELECT>

					<input type="hidden" name="u[]" value="0">
					<SELECT name="u[]" onChange="javascript:applyFilter();" multiple class="lms-ui-multiselect" data-default-value="{trans("- all -")}">
						{foreach $users as $user}
						<option value="{$user.id}"{if is_array($filter.userid) && in_array($user.id, $filter.userid)} selected{/if}>{$user.name}</option>
						{/foreach}
					</SELECT>

					{/if}
					{trans("Period:")}
					<SELECT name="periodtype" onChange="javascript:applyFilter();">
						<OPTION value="creationdate"{if empty($filter.periodtype) || $filter.periodtype == 'creationdate'} selected{/if}>{trans("creation date")}</OPTION>
						<OPTION value="confirmationdate"{if $filter.periodtype == 'confirmationdate'} selected{/if}>{trans("confirmation date")}</OPTION>
						<OPTION value="archivizationdate"{if $filter.periodtype == 'archivizationdate'} selected{/if}>{trans("archivization date")}</OPTION>
						<OPTION value="fromdate"{if $filter.periodtype == 'fromdate'} selected{/if}>{trans("'from' date")}</OPTION>
						<OPTION value="todate"{if $filter.periodtype == 'todate'} selected{/if}>{trans("'to' date")}</OPTION>
					</SELECT>

					<span class="nobr">
                        {trans("from")}
                        <INPUT TYPE="text" NAME="from" SIZE="10" maxlength="10" value="{if $filter.from > 0}{$filter.from|date_format:"%Y/%m/%d"}{/if}"
								onChange="javascript:applyFilter();"
								{tip class="calendar" text="Enter date in YYYY/MM/DD format (empty field means no limit) or click to choose it from calendar"}>
                    </span>
                    <span class="nobr">
					    {trans("to")}
                        <INPUT TYPE="text" NAME="to" SIZE="10" maxlength="10" value="{if $filter.to > 0}{$filter.to|date_format:"%Y/%m/%d"}{/if}"
								onChange="javascript:applyFilter();"
								{tip class="calendar" text="Enter date in YYYY/MM/DD format (empty field means no limit) or click to choose it from calendar"}>
                    </span>

					{if !empty($numberplans) && count($numberplans)}
					{trans("Number plan:")}
					<SELECT name="p" onChange="javascript:applyFilter();" {tip text="Select numbering plan"}>
						<OPTION value="0">- {trans("all")} -</OPTION>
						{foreach $numberplans as $plan}
						{$period = $plan.period}
						<OPTION value="{$plan.id}"{if $filter.numberplan == $plan.id} selected{/if}>{number number=$plan.next template=$plan.template time=$invoice.cdate customerid=$filter.customer} ({$_NUM_PERIODS.$period})</OPTION>
						{/foreach}
					</SELECT>
					{else}
					<input type="hidden" name="p" value="0">
					{/if}

					{trans("Status:")}
					<SELECT name="s" onChange="javascript:applyFilter();" {tip text="Select document status"}>
						<OPTION value="-1">- {trans("all")} - </OPTION>
						<OPTION value="0"{if $filter.status == 0} selected{/if}>{trans("unconfirmed")}</OPTION>
						<OPTION value="1"{if $filter.status == 1} selected{/if}>{trans("confirmed")}</OPTION>
					</SELECT>

					{trans("Archived:")}
					<SELECT name="archived" onChange="javascript:applyFilter();" {tip text="Select document archived state"}>
						<OPTION value="-1">- {trans("all")} - </OPTION>
						<OPTION value="1"{if $filter.archived == 1} selected{/if}>{trans("yes")}</OPTION>
						<OPTION value="0"{if $filter.archived == 0} selected{/if}>{trans("no")}</OPTION>
					</SELECT>

					<A href="javascript:applyFilter();">&raquo;&raquo;&raquo;</A>
                    </form>
				</div>
				{persistent_filter}
			</div>
		</TD>
	</TR>
	{if $pagination->getTotal() != 0}
	<TR>
		<TD class="lms-ui-pagination" COLSPAN="5">
			{include file="pagination.html" form="page-form"}
		</TD>
	</TR>
	{/if}
    </THEAD>
    <TBODY class="lms-ui-multi-check">
	<FORM METHOD="POST" NAME="page" id="page-form" ACTION="?m=documentedit&action=confirm">
	{foreach $documentlist as $doc}
	{assign var=docid value=$doc.docid}
	<TR class="highlight{if $doc.closed} blend{/if}{if $doc.archived} lms-ui-document-archived{/if}">
		<TD class="nobr" onclick="window.open('?m=documentview&amp;id={$doc.docid}');"{if $doc.description} {tip text=$doc.description}{/if}>
			{$doc.cdate|date_format:"%Y/%m/%d %H:%M"}{if $doc.sdate} / {$doc.sdate|date_format:"%Y/%m/%d %H:%M"}{/if}
			{if $doc.number}<BR>
				<B>{number number=$doc.number template=$doc.template time=$doc.cdate customerid=$doc.customerid}</B>
			{/if}
		</TD>
		<TD class="nobr" onclick="window.open('?m=documentview&amp;id={$doc.docid}');">
			{$doc.username}{if $doc.cuserid} / {$doc.cusername}{/if}
			<BR><B>{assign var=type value=$doc.type}{$_DOCTYPES.$type}</B>
		</TD>
		<TD class="nobr" onclick="window.open('?m=documentview&amp;id={$doc.docid}');">
			{$doc.title|truncate:40:"...":true}
			{if $doc.fromdate || $doc.todate}<BR>
			    {if $doc.fromdate}{trans("from")} {$doc.fromdate|date_format:"%Y/%m/%d"}{/if}
			    {if $doc.todate}{trans("to")} {$doc.todate|date_format:"%Y/%m/%d"}{/if}
			{/if}
			{if $doc.reference}<br>
			<a href="?m=documentview&id={$doc.reference.id}" rel="external">
				{t a=$_DOCTYPES[$doc.reference.type] b=$doc.reference.fullnumber c=$doc.reference.cdate|date_format:"%Y/%m/%d"}$a no. $b issued on $c{/t}
			</a>
			{/if}
		</TD>
		<TD class="nobr"><A href="?m=customerinfo&amp;id={$doc.customerid}">{$doc.name|truncate:40:"...":true}</A></TD>
		<TD class="text-right nobr">
			{if $doc.senddocuments}
				{button type="link" class="documentsend" icon="mail" href="?m=documentsend&id={$doc.docid}"
					tip="Document send"}
			{/if}
			{assign var=type value=$doc.type}
			{button type="link" icon="save" href="?m=documentview&id={$doc.docid}&save=1" tip="Save"}
			{if ! $doc.closed && ($docrights.$type.rights & $smarty.const.DOCRIGHT_CONFIRM)}
				{button type="link" icon="confirm" href="?m=documentedit&id={$doc.docid}&action=confirm" tip="Confirm"}
			{/if}
			{if $doc.closed && !$doc.archived && ($docrights.$type.rights & $smarty.const.DOCRIGHT_ARCHIVE)}
				{button type="link" icon="archive" href="?m=documentedit&id={$doc.docid}&action=archive" tip="Archive"
					onclick="return confirmLink(this, '{trans("Are you sure, you want to archive that document?")}')"}
			{/if}
			{if ($docrights.$type.rights & $smarty.const.DOCRIGHT_DELETE)}
				{button type="link" icon="delete" onclick="return confirmLink(this, '{trans("Are you sure, you want to remove that document?")}')"
					href="?m=documentdel&id={$doc.docid}" tip="Remove document"}
			{/if}
			{if ($docrights.$type.rights & $smarty.const.DOCRIGHT_EDIT)}
				{button type="link" icon="edit" href="?m=documentedit&id={$doc.docid}" tip="Edit"}
			{/if}
			{$docattach = $doc.attachments[0]}
			{if $docattach.main || count($doc.attachments) == 1}
				{documentview id="{$doc.docid}-{$docattach.id}" type=$docattach.contenttype name=$docattach.filename
					url="?m=documentview&id={$doc.docid}" external=true
					text="<i class=\"{if preg_match('/pdf/',$docattach.contenttype)}pdf{elseif preg_match('/csv|excel|spreadsheet/',$docattach.contenttype)}xls{/if}\"></i>"}
			{/if}
			{if count($doc.attachments) > 1}
			<a href="#" id="allattachments-toggle-{$doc.docid}" onclick="toggle_all_attachments({$doc.docid}); return false;" title="{trans("more document attachments")}">
				<img src="img/asc_order.gif">
			</a>
			{/if}
			<INPUT TYPE="checkbox" NAME="marks[{$docid}]" VALUE="{$docid}" class="lms-ui-multi-check"{if $marks.$docid} checked{/if}>
			<div id="allattachments-{$doc.docid}" style="display: none;">
				{foreach $doc.attachments as $docattach}
					{if $docattach@first && $docattach.main}{continue}{/if}
					{documentview id="{$doc.docid}-{$docattach.id}" type=$docattach.contenttype name=$docattach.filename
						url="?m=documentview&id={$doc.docid}&attachmentid={$docattach.id}" external=true
						text="{$docattach.filename} <img src=\"img/{if preg_match('/pdf/',$docattach.contenttype)}pdf{elseif preg_match('/csv|excel|spreadsheet/',$docattach.contenttype)}xls{else}view{/if}.gif\">"}
					<br>
				{/foreach}
			</div>
		</TD>
	</TR>
	{foreachelse}
	<TR>
		<TD colspan="5" class="empty-table">
			<p>{trans("No such documents matching search criteria or list is empty.")}</p>
		</TD>
	</TR>
	{/foreach}
	</FORM>
    </TBODY>
    <TFOOT>
	{if $pagination->getTotal() != 0}
	<TR>
		<TD class="lms-ui-pagination" COLSPAN="5">
			{include file="pagination.html" form="page-form"}
		</TD>
	</TR>
	{/if}
	<TR>
		<TD COLSPAN="5">
			{if count($documentlist) > 0}
			<TABLE WIDTH="100%">
				<TR>
					<TD class="nobr">
						<button type="button" class="lms-ui-button lms-ui-button-mail"
								onclick="if (confirm('{trans("Are you sure, you want to send documents to customer?")}')) send_documents();">
							<i></i> {trans("Send documents")}
						</button>
						<button type="button" class="lms-ui-button lms-ui-button-print" onclick="javascript:print_docs();">
							<i></i> {trans("Print")}
						</button>
						<button type="button" class="lms-ui-button lms-ui-button-confirm" onclick="javascript:mark_docs();">
							<i></i> {trans("Confirm")}
						</button>
						<button type="button" class="lms-ui-button lms-ui-button-archive" onclick="javascript:archive_docs();">
							<i></i> {trans("Archive")}
						</button>
						<button type="button" class="lms-ui-button lms-ui-button-delete" onclick="javascript:delete_docs();">
							<i></i> {trans("Delete")}
						</button>
					</TD>
					<TD class="text-right nobr">
						<label>
							{trans("Check All")}
							<INPUT TYPE="checkbox" class="lms-ui-multi-check-all" VALUE="1">
						</label>
					</TD>
				</TR>
			</TABLE>
			{/if}
		</TD>
	</TR>
    </TFOOT>
</TABLE>
<script>
	$('.documentsend').click(function() {
		if (!confirm('{trans("Are you sure, you want to send document to customer?")}')) {
			return false;
		}
		window.open($(this).attr('href'));
		return false;
	});
</script>
{/block}
