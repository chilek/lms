<!--// $Id$ //-->
<TABLE class="lmsbox">
	<THEAD>
	<TR>
		<TD style="width: 100%;" class="hand text-left bold nobr" onClick="showOrHide('promotionschemadata');">
			<IMG src="img/money.gif" alt="">
			{t a=count($schema.tariffs)}Schema's Tariffs ($a):{/t}
		</TD>
	</TR>
	</THEAD>
	<TBODY>
	{$periodcnt = count($schema.periods)}
	<TR id="promotionschemadata" style="display: none;">
		<TD style="width: 100%;">
			<FORM method="post" name="tariffs" action="?m=promotionschemaedit&id={$schema.id}&action=tariff">
			<TABLE class="lmsbox-inner lms-ui-background-cycle" id="schematariffs">
				<THEAD>
				<TR>
					<TD style="width: {math equation="96-x" x=$periodcnt}%;" class="bold nobr">
						<INPUT type="submit" class="hiddenbtn">
						{trans("Name:")}
					</TD>
					<TD style="width: 1%;" class="text-right bold nobr">{trans("Value")}:</TD>
					<TD style="width: 1%;" class="text-right nobr">{trans("Optional")}:</TD>
					<TD style="width: 1%;" class="text-right nobr">{trans("<!promotionassignment>Label")}:</TD>
					{foreach from=$schema.periods item=period}
					<TD style="width: 1%;" class="text-right nobr">{$period}:</TD>
					{/foreach}
					<TD style="width: 1%;">&nbsp;</TD>
				</TR>
				</THEAD>
				<TBODY>
				{foreach $schema.tariffs as $tariff}
				<TR class="highlight schematariff" data-assignment="{$tariff.id}">
					<TD class="valign-top">
						<img src="img/money.gif" class="drag-icon">&nbsp;<A href="?m=tariffinfo&id={$tariff.tariffid}" class="bold">{$tariff.name}</A>
					</TD>
					<TD class="text-right valign-top bold nobr">
						{$tariff.value|string_format:"%.2f"}
					</TD>
					<TD class="text-right valign-top nobr">
						<SPAN class="tariff-view" {if $error && $formdata.aid == $tariff.id} style="display:none"{/if}
								data-optional="{$tariff.optional}">
							{if $tariff.optional}{trans("yes")}{else}{trans("no")}{/if}
						</SPAN>
						<INPUT type="checkbox" class="tariff-edit optional-edit" name="form[{$tariff.id}][optional]" value="1"
								{tip text="Check if tariff should be optional"}
								{if $formdata[$tariff.id].optional} checked{/if}
								{if !$error || $formdata.aid != $tariff.id} style="display: none;"{/if}>
					</TD>
					<TD class="text-right valign-top nobr">
						<SPAN class="tariff-view"{if $error && $formdata.aid == $tariff.id} style="display: none;"{/if}
							data-selectable="{$tariff.label}">
							{if $tariff.label}{$tariff.label}{/if}
						</SPAN>
						<span class="tariff-edit"{if !$error || $formdata.aid != $tariff.id} style="display: none;"{/if}>
							<SELECT name="form[{$tariff.id}][selectable]" class="selectable selectable-edit" {tip text="Choose selection list"}>
								<OPTION value="0"{if !$formdata[$tariff.id].selectable} selected{/if}>{trans("<!promotionassignment>- none -")}</OPTION>
								<OPTION value="-1"{if $formdata[$tariff.id].selectable == -1} selected{/if}>{trans("<!promotionassignment>- new -")}</OPTION>
								{foreach $schema.selections as $selid}
								<OPTION value="{$selid}"{if $selid == $formdata[$tariff.id].selectable} selected{/if}>{$selid}</OPTION>
								{/foreach}
							</SELECT>
							<br>
							<input type="text" size="15" name="form[{$tariff.id}][label]" class="label-edit"
									value="{$formdata[$tariff.id].label}"
									{if $formdata[$tariff.id].selectable != -1} style="display: none;"{/if}
									{tip text="<!promotionassignment>Enter new label"}>
						</span>
					</TD>
					{foreach $schema.periods as $key => $period}
					<TD class="text-right valign-top nobr">
						<SPAN class="tariff-view"{if $error && $formdata.aid == $tariff.id} style="display: none;"{/if}
								data-value="{$tariff.data.value[$key]}" data-period="{$tariff.data.period[$key]}"
								data-users="{implode(',', $tariff.data.users[$key])}">
							{if !empty($tariff.data.users[$key])}
								<i class="lms-ui-icon-user" title="{t a=$tariff.data.users_text[$key]}modifiable by selected users:<br><strong>$a</strong>{/t}"></i>
							{/if}
							{if $tariff.data.value[$key] != 'NULL'}{$tariff.data.value[$key]|string_format:"%.2f"}{/if}
							{if $tariff.data.period[$key]}({$_PERIODS[$tariff.data.period[$key]]}){/if}
						</SPAN>
						<span class="tariff-edit"{if !$error || $formdata.aid != $tariff.id} style="display: none;"{/if}>
							<div style="display: inline-block; vertical-align: middle;">
								<SELECT name="form[{$tariff.id}][users][{$key}][]" class="lms-ui-multiselect-deferred user-edit" data-type="tiny"
										data-button='<i class="lms-ui-icon-user"></i>'
										data-tooltip-message="modifiable by selected users:<br><strong>$a</strong>" data-separator="<br>"
										multiple>
									{foreach $users as $user}
									<option value="{$user.id}"{if in_array($user.id, $formdata[$tariff.id].users[$key])} selected{/if}>{$user.rname}</option>
									{/foreach}
								</SELECT>
							</div>
							<INPUT type="text" size="8" name="form[{$tariff.id}][value][{$key}]" class="value-edit"
									value="{$formdata[$tariff.id].value[$key]}"
									{if $key}
										{tip text="Enter subscription value for specified period"}
									{else}
										{tip text="Enter activation value"}
									{/if}>
							{if $key}
							<BR>
							<SELECT name="form[{$tariff.id}][period][{$key}]" class="period-edit"
									{tip text="Select accounting period (optional) - overwrites customer liability's period"}>
								<OPTION value="0" {if !$formdata[$tariff.id].period[$key]} selected{/if}>-</OPTION>
								{foreach $_PERIODS as $pkey => $item}
									{if $pkey}
									<OPTION value="{$pkey}"{if $pkey == $formdata[$tariff.id].period[$key]} selected{/if}>{$item}</OPTION>
									{/if}
								{/foreach}
							</SELECT>
							{/if}
						</span>
					</TD>
					{/foreach}
					<TD class="nobr">
						<A class="tariff-view button-del" href="?m=promotionschemaedit&action=tariffdel&id={$schema.id}&aid={$tariff.id}"
								{if $error && $formdata.aid == $tariff.id} style="display: none;"{/if}>
							<IMG src="img/delete.gif" alt="{trans("Delete assignment")}" title="{trans("Delete assignment")}">
						</A>
						<A class="tariff-view button-edit"
								{if $error && $formdata.aid == $tariff.id} style="display: none;"{/if}>
							<IMG src="img/edit.gif" alt="{trans("Edit assignment")}" title="{trans("Edit assignment")}">
						</A>
						<A class="tariff-edit button-cancel"
								{if !$error || $formdata.aid != $tariff.id} style="display: none;"{/if}>
							<IMG src="img/cancel.gif" alt="{trans("Cancel")}" title="{trans("Cancel")}">
						</A>
						<A class="tariff-edit button-save" href="javascript:save_tariff({$tariff.id})"
								{if !$error || $formdata.aid != $tariff.id} style="display: none;"{/if}>
							<IMG src="img/save.gif" alt="{trans("Save")}" title="{trans("Save")}">
						</A>
					</TD>
				</TR>
				{foreachelse}
				<TR>
					<TD colspan="{$periodcnt+5}" class="empty-table">
						<p>{trans("This schema has no assigned tariffs.")}</p>
					</TD>
				</TR>
				{/foreach}
				</TBODY>
				{if $tariffs}
				<TFOOT>
				<TR>
					<TD colspan="2" class="ftop valign-top">
						<SELECT name="form[tariffid]" {tip text="Select subscription" trigger="tariffid"}>
							{foreach from=$tariffs item=t}
							<OPTION value="{$t.id}" {if $t.id == $formdata.tariffid}selected{/if}>
							{$t.name|truncate:40:"...":true} ({$t.value|money_format}{if $t.upceil || $t.downceil}, {$t.downceil}/{$t.upceil} kbit/s{/if})
							</OPTION>
							{/foreach}
						</SELECT>
					</TD>
					<TD class="ftop text-right valign-top nobr">
						<INPUT type="checkbox" name="form[optional]" value="1" {tip text="Check if tariff should be optional"}
								{if $formdata.optional} checked{/if}>
					</TD>
					<TD class="ftop text-right valign-top nobr">
						<SELECT name="form[selectable]" class="selectable" {tip text="Choose selection list"}>
							<OPTION value="0" {if !$formdata.selectable}selected{/if}>{trans("<!promotionassignment>- none -")}</OPTION>
							<OPTION value="-1" {if $formdata.selectable == -1}selected{/if}>{trans("<!promotionassignment>- new -")}</OPTION>
							{foreach $schema.selections as $selid}
							<OPTION value="{$selid}"{if $selid == $formdata.selectable} selected{/if}>{$selid}</OPTION>
							{/foreach}
						</SELECT>
						<br>
						<input type="text" size="15" name="form[label]"{if $formdata.selectable != -1} style="display: none;"{/if}
							value="{$formdata.label}" {tip text="<!promotionassignment>Enter new label"}
					</TD>
					{foreach $schema.periods as $key => $period}
					<TD class="ftop text-right valign-top nobr">
						<div style="display: inline-block; vertical-align: middle;">
							<SELECT name="form[users][{$key}][]" class="lms-ui-multiselect-deferred" data-type="tiny"
									data-button='<i class="lms-ui-icon-user"></i>'
									data-tooltip-message="modifiable by selected users:<br><strong>$a</strong>" data-separator="<br>"
									multiple>
								{foreach $users as $user}
								<option value="{$user.id}"{if in_array($user.id, $formdata.users[$key])} selected{/if}>{$user.rname}</option>
								{/foreach}
							</SELECT>
						</div>
						<INPUT type="text" size="8" name="form[value][{$key}]" value="{$formdata.value[$key]}"
								{if $key}
									{tip text="Enter subscription value for specified period"}
								{else}
									{tip text="Enter activation value"}
								{/if}>
						{if $key}
						<BR>
						<SELECT name="form[period][{$key}]" {tip text="Select accounting period (optional) - overwrites customer liability's period"}>
							<OPTION value="0" {if !$formdata.period[$key]}selected{/if}>-</OPTION>
							{foreach $_PERIODS as $pkey => $p}
								{if $pkey}
								<OPTION value="{$pkey}"{if $pkey == $formdata.period[$key]} selected{/if}>{$p}</OPTION>
								{/if}
							{/foreach}
						</SELECT>
						{/if}
					</TD>
					{/foreach}
					<TD class="ftop text-right valign-top">
						<A href="javascript:document.tariffs.submit()"><IMG src="img/save.gif" alt="{trans("Add assignment")}" title="{trans("Add assignment")}"></A>
					</TD>
				</TR>
				{/if}
				</TFOOT>
			</TABLE>
			</FORM>
		</TD>
	</TR>
	</TBODY>
</TABLE>
<SCRIPT>

	function save_tariff(id) {
		document.tariffs.action += '&aid=' + id;
		document.tariffs.submit();
	}

	$(function () {
		$('#schematariffs').sortable({
			items: 'tbody > tr.schematariff',
			handle: 'img.drag-icon',
			opacity: 0.9,
			axis: 'y',
			placeholder: 'light',
			update: function (event, ui) {
				var assignments = [];
				ui.item.parent().children('tr[data-assignment]').each(function (index, value) {
					assignments.push($(this).attr('data-assignment'));
				});
				$.ajax('?m=promotionschemaedit&id={$schema.id}&action=tariff-reorder', {
					method: "POST",
					data: {
						assignments: assignments
					},
					dataType: "json",
					success: function (data, textStatus, qXHR) {
						if (data.result === undefined || data.result != 'OK') {
							$('#userpanel-modules').sortable('cancel');
							alert('{trans("LMS: operation failed!")}');
						}
					},
					error: function (jqXHR, textStatus, errorThrown) {
						$('#schematariffs').sortable('cancel');
						alert('{trans("AJAX: Invalid result - status:")}' + textStatus + '!');
					}
				});
			}
		});

		$('.selectable').change(function() {
			$(this).siblings('input[type="text"]').toggle($(this).val() == -1);
		});

		$('.button-edit').click(function() {
			var row = $(this).closest('tr');

			if ($('.tariff-edit:visible').length) {
				alert($t('Unable to edit two rows at once!'));
				return false;
			}

			row.find('.tariff-view').hide();
			row.find('.tariff-edit').show().each(function() {
				var edit = $(this);
				$(this).siblings('.tariff-view').each(function() {
					if ($(this).is('[data-optional]')) {
						edit.prop('checked', parseInt($(this).attr('data-optional')) == 1);
					} else if ($(this).is('[data-selectable]')) {
						edit.find('.selectable-edit').val($(this).attr('data-selectable'));
					} else if ($(this).is('[data-value]')) {
						var value = $(this).attr('data-value');
						if (value != 'NULL') {
							edit.find('.value-edit').val(value);
						}
						edit.find('.period-edit').val($(this).attr('data-period'));
						var users = $(this).attr('data-users').split(',');
						var userms = edit.find('.user-edit').data('multiselect-object');
						if (userms) {
							userms.updateSelection(users);
						} else {
							edit.find('.user-edit').val(users);
						}
					}
				});
			});
			init_multiselects('select.lms-ui-multiselect-deferred:visible');
		});

		$('.button-cancel').click(function() {
			var row = $(this).closest('tr');

			row.find('.tariff-edit').hide();
			row.find('.tariff-view').show();
		});

		init_multiselects('select.lms-ui-multiselect-deferred:visible');
	});

	if (getCookie('promotionschemadata') == '1') {
		$('#promotionschemadata').show();
	}

	$('.tariff-view, .button-del').click(function() {
		confirmDialog($t("Are you sure, you want to delete this assignment?"), this).done(function() {
			location.href = $(this).attr('href');
		});
		return false;
	});

</SCRIPT>
