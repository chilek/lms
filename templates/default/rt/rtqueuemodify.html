{extends file="layout.html"}
{block name=title}LMS: {$layout.pagetitle|striphtml}{/block}
{block name=module_content}
<!--// $Id$ //-->

<style>

	.lms-ui-box,
	.lms-ui-box-row-nested-box {
		border: 1px solid black;
		border-radius: 5px;
		background-color: #DFD5BD;
	}

	.lms-ui-box-header,
	.lms-ui-box-body,
	.lms-ui-box-footer {
		padding: 0.7em;
	}

	.lms-ui-box-header {
		border-bottom: 1px solid black;
		border-top-left-radius: 4px;
		border-top-right-radius: 4px;
		background-color: #CEBD9B;

		display: flex;
		flex-grow: 1;
	}

	.lms-ui-box-body {
		display: flex;
		flex-grow: 1;
		flex-wrap: wrap;
		justify-content: space-between;
	}

	.lms-ui-box-body.lms-ui-box-flex-column {
		flex-direction: column;
	}

	.lms-ui-box-panel {
		padding: 1em;
		padding-top: 0;
		padding-bottom: 0;
		display: flex;
		flex-direction: column;
		width: fit-content;
	}

	#left-panel {
		flex-grow: 2;
	}

	#right-panel {
		flex-wrap: nowrap;
		flex-grow: 3;
	}

	#right-panel .lms-ui-box-row fieldset {
		display: flex;
		margin-bottom: 1em;
		flex-grow: 1;
	}

	.lms-ui-box-row {
		display: flex;
		justify-content: stretch;
		flex-grow: 1;
	}

	.lms-ui-box-row-field {
		padding: 0.5em 0.7em 0.5em 0.7em;
	}

	.lms-ui-box-row-field {
		display: flex;
	}

	.lms-ui-box-body .lms-ui-box-row-field {
		padding-top: 0.3em;
		padding-bottom: 0.3em;
	}

	.lms-ui-background-cycle .lms-ui-box-body .lms-ui-box-row {
		border-bottom: 1px dotted grey;
	}

	.lms-ui-background-cycle .lms-ui-box-body .lms-ui-box-row:nth-child(even) {
		background-color: #EBE4D6;
	}

	.lms-ui-background-cycle .lms-ui-box-body .lms-ui-box-row:nth-child(odd) {
		background-color: #DFD5BD;
	}

	.lms-ui-box-row-field-label {
		padding-top: 0.5em;
		padding-bottom: 0.5em;
	}

	.lms-ui-box-row-field-label i {
		margin-right: 0.2em;
	}

	.lms-ui-box-row-field,
	.lms-ui-box-row-field input[type="text"]:not(.chosen-search-input),
	.lms-ui-box-row-field input[type="email"] {
		width: 100%;
		min-width: 20em;
		/*max-width: 50em;*/
	}

	.lms-ui-box-row-field {
		flex-direction: column;
	}

	.lms-ui-box-row-field.single-line {
		flex-direction: row;
	}

	.lms-ui-box-row-field.single-line > *:not(:first-child) {
		margin-left: 0.5em;
	}

	.lms-ui-box-row-nested-box .lms-ui-box-row {
		width: 100%;
	}

	.lms-ui-box-row-nested-box .lms-ui-box-row-field {
		min-width: unset;
	}

	.lms-ui-box-row-field textarea {
		width: 100%;
		min-width: 20em;
		/*max-width: 50em;*/
	}

	.lms-ui-box-buttons {
		background-image: linear-gradient(to right, black 33%, rgba(255,255,255,0) 0%);
		background-position: left 0.5em;
		background-size: 3px 1px;
		background-repeat: repeat-x;
		padding: 1em 0.5em 0.5em 0.5em;
	}

	.lms-ui-box-buttons > *:not(:first-child) {
		margin-left: 0.3em;
	}




	#verifier-notifications {
		margin: 1.8em;
	}

	#notification-tabs {
		width: 100%;
	}

	#notification-tabs table {
		width: 100%;
	}

	#notification-tabs input[type="text"] {
		width: 100%;
		min-width: 20em;
	}

	#notification-tabs textarea {
		width: 100%;
		min-width: 20em;
	}

	#verifier-notifications {
		width: 100%;
	}

	#verifier-notifications input[type="text"] {
		width: 100%;
		min-width: 20em;
	}

	#verifier-notifications textarea {
		width: 100%;
		min-width: 20em;
	}

	.rotation-wrapper-container {
		position: relative;
	}

	.rotation-wrapper-element {
		writing-mode: vertical-rl;
		transform: rotate(0deg);
		white-space: nowrap;
		display: inline-block;
		overflow: visible;
	}

	.lms-ui-box-body .username,
	.lms-ui-box-body .permission {
		align-self: flex-end;
		align-items: flex-start;
	}

	.lms-ui-box-body .permission {
		flex-grow: 1;
	}

	.lms-ui-box-footer .username {
		text-align: right;
	}

	.username {
		width: 15em;
	}

	#queue-name {
		max-width: 40em;
	}

	.user-login {
		transform: scale(0.8);
		transform-origin: left;
	}

	.permission {
		width: 1em;
	}

</style>

<H1>{$layout.pagetitle}</H1>

<form METHOD="POST" NAME="queue" ACTION="?m={$layout.module}{if isset($queue.id)}&id={$queue.id}{/if}">
<INPUT type="submit" class="hiddenbtn">

<div class="lms-ui-box">
	<div class="lms-ui-box-header">
		<div class="lms-ui-box-row">
			<div class="lms-ui-box-row-field single-line">
				<label for="queue-name">
					{icon name="queue" class="fa-fw"}
					<strong>{trans("Name")}</strong>
				</label>
				<input type="text" name="queue[name]" value="{$queue.name}" id="queue-name"
					{tip text="Enter queue name" trigger="name" bold=1}>
				{if isset($queue.id)}
					<strong>({$queue.id|string_format:"%04d"})</strong>
				{/if}
			</div>
		</div>
	</div>
	<div class="lms-ui-box-body lms-ui-box-flex-row">
		<div class="lms-ui-box-panel" id="left-panel">
			<div class="lms-ui-box-row">
				<div class="lms-ui-box-row-field">
					<div class="lms-ui-box-row-field-label">
						<label for="queue-email">
							{icon name="mail" class="fa-fw"}
							<strong>{trans("E-mail")}</strong>
						</label>
					</div>
					<div class="lms-ui-box-row-field-value">
						<input TYPE="email" NAME="queue[email]" id="queue-email" VALUE="{$queue.email}"
							{tip text="Enter e-mail address" trigger="email"}>
					</div>
				</div>
			</div>
			<div class="lms-ui-box-row">
				<div class="lms-ui-box-row-field">
					<div class="lms-ui-box-row-field-label">
						<label for="queue-description">
							{icon name="description" class="fa-fw"}
							<strong>{trans("Description")}</strong>
						</label>
					</div>
					<div class="lms-ui-box-row-field-value">
						<TEXTAREA NAME="queue[description]" ROWS="3" id="queue-description"
							{tip text="Enter additional information (optional)"}>{$queue.description}</TEXTAREA>
					</div>
				</div>
			</div>
			<div class="lms-ui-box-row">
				<div class="lms-ui-box-row-field">
					<div class="lms-ui-box-row-field-label">
						<label for="queue-verifierid">
							{icon name="verifier" class="fa-fw"}
							<strong>{trans("<!rt>Verifier")}</strong>
						</label>
					</div>
					<div class="lms-ui-box-row-field-value">
						<SELECT size="1" id="queue-verifierid"
								name="queue[verifierid]" {tip text="Select user" trigger="verifierid"}>
							<OPTION value="">- {trans("select user")} -</OPTION>
							{foreach $userlist as $user}
								<OPTION value="{$user.id}" {if $user.id == $queue.verifierid} selected{/if}>{$user.rname}
									({$user.login})
								</OPTION>
							{/foreach}
						</SELECT>
					</div>
				</div>
			</div>
			<div class="lms-ui-box-row">
				<div class="lms-ui-box-row-field">
					<div class="lms-ui-box-row-field-label">
						<label>
							{icon name="queue" class="fa-fw"}
							<strong>{trans("Default categories")}</strong>
							<input type="checkbox" id="checkall">
						</label>
					</div>
					<div class="lms-ui-box-row-field-value">
						{include file="rt/rtcategoryselection.html" id="categories" name_prefix="queue[categories]" categories=$categories}
					</div>
				</div>
			</div>
			<div class="lms-ui-box-row">
				<div class="lms-ui-box-row-field">
					<div class="lms-ui-box-row-field-label">
						{icon name="user" class="fa-fw"}
						<strong>{trans("Permissions")}</strong>
					</div>
					<div class="lms-ui-box-row-field-value lms-ui-box-row-nested-box lms-ui-background-cycle">
						<div class="lms-ui-box-header">
							<div class="lms-ui-box-row">
								<div class="lms-ui-box-row-field username">
									<strong>{trans("User")}</strong>
									{*<COL style="width: {100-count($_RT_RIGHTS)}%">*}
								</div>
								{foreach $_RT_RIGHTS as $label}
									<div class="lms-ui-box-row-field permission rotation-wrapper-container">
										<div class="rotation-wrapper-element">
											<strong>
												{$label}
											</strong>
										</div>
									</div>
								{/foreach}
							</div>
						</div>
						<div class="lms-ui-box-body lms-ui-box-flex-column">
							{foreach $queue.rights as $right}
								<div class="lms-ui-box-row highlight lms-ui-row-all-check">
									<div class="lms-ui-box-row-field username">
										<a href="?m=userinfo&id={$right.id}">{$right.rname}</a>
										<span class="user-login">({$right.login})</span>
										<INPUT type="hidden" name="queue[usernames][{$right.id}]" value="{$right.rname}">
										<INPUT type="hidden" name="queue[userlogins][{$right.id}]" value="{$right.login}">
									</div>
									{foreach $_RT_RIGHTS as $rightvalue => $label}
										<div class="lms-ui-box-row-field permission">
											<input type="checkbox" name="queue[users][{$right.id}][{$rightvalue}]"
												value="{$rightvalue}"{if ($right.rights & $rightvalue) == $rightvalue} checked{/if}>
										</div>
									{/foreach}
								</div>
							{/foreach}
						</div>
						<div class="lms-ui-box-footer">
							<div class="lms-ui-box-row">
								<div class="lms-ui-box-row-field username">
									<strong>
										{trans("Check All")}
									</strong>
								</div>
								{foreach $_RT_RIGHTS as $rightvalue => $label}
									<div class="lms-ui-box-row-field permission">
										<input TYPE="checkbox" NAME="allbox[{$rightvalue}]" data-value="{$rightvalue}">
									</div>
								{/foreach}
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="lms-ui-box-panel" id="right-panel">
			<div class="lms-ui-box-row">
				<fieldset>
					<legend>
						{icon name="notifications"}
						<strong>{trans("Customer notifications")}</strong>
					</legend>
					<div id="notification-tabs">
						<ul>
							<li><a href="#notification-tab-email">{trans("Email")}</a></li>
							<li><a href="#notification-tab-sms">{trans("SMS")}</a></li>
						</ul>
						<div id="notification-tab-email" class="notification-tab">
							<TABLE cellpadding="3">
								<TR>
									<TD>
										<strong>
											{trans("Subject (new ticket)")}
										</strong>
									</TD>
								</TR>
								<tr>
									<TD>
										{capture assign="tip"}{trans("Subject of mail sent after new ticket is created")}<br><br>{trans("<!customer-notification-subject>The following special symbols are supported:<br><strong>%tid</strong> - ticket identifier,<br><strong>%title</strong> - ticket title.<br>")}{/capture}
										<INPUT type="text" name="queue[newticketsubject]" value="{$queue.newticketsubject}"
											{tip text=$tip trigger="newticketsubject"}>
									</TD>
								</tr>
								<TR>
									<TD>
										<strong>
											{trans("Body (new ticket)")}
										</strong>
									</TD>
								</TR>
								<TR>
									<TD>
										{capture assign="tip"}{trans("Body of mail sent after new ticket is created")}<br><br>{trans("<!customer-notification-body>The following special symbols are supported:<br><strong>%tid</strong> - ticket identifier,<br><strong>%cid</strong> - customer identifier,<br><strong>%pin</strong> - customer PIN,<br><strong>%customername</strong> - customer full name,<br><strong>%title</strong> - ticket title.<br>")}{/capture}
										<TEXTAREA name="queue[newticketbody]" rows="10"
											{tip text=$tip trigger="newticketbody"}
											>{$queue.newticketbody}</TEXTAREA>
									</TD>
								</TR>
								<TR>
									<TD>
										<strong>
											{trans("Subject (new message)")}
										</strong>
									</TD>
								<TR>
									<TD>
										{capture assign="tip"}{trans("Subject of mail sent after new message is added")}<br><br>{trans("<!customer-notification-subject>The following special symbols are supported:<br><strong>%tid</strong> - ticket identifier,<br><strong>%title</strong> - ticket title.<br>")}{/capture}
										<INPUT type="text" name="queue[newmessagesubject]" value="{$queue.newmessagesubject}"
											{tip text=$tip trigger="newmessagesubject"}>
									</TD>
								</TR>
								<TR>
									<TD>
										<strong>
											{trans("Body (new message)")}
										</strong>
									</TD>
								</TR>
								<TR>
									<TD>
										{capture assign="tip"}{trans("Body of mail sent after new message is added")}<br><br>{trans("<!customer-notification-body>The following special symbols are supported:<br><strong>%tid</strong> - ticket identifier,<br><strong>%cid</strong> - customer identifier,<br><strong>%pin</strong> - customer PIN,<br><strong>%customername</strong> - customer full name,<br><strong>%title</strong> - ticket title.<br>")}{/capture}
										<TEXTAREA name="queue[newmessagebody]" rows="10"
											{tip text=$tip trigger="newmessagebody"}
											>{$queue.newmessagebody}</TEXTAREA>
									</TD>
								</TR>
								<TR>
									<TD>
										<strong>
											{trans("Subject (resolve ticket)")}
										</strong>
									</TD>
								</TR>
								<TR>
									<TD>
										{capture assign="tip"}{trans("Subject of mail sent after ticket is resolved")}<br><br>{trans("<!customer-notification-subject>The following special symbols are supported:<br><strong>%tid</strong> - ticket identifier,<br><strong>%title</strong> - ticket title.<br>")}{/capture}
										<INPUT type="text" name="queue[resolveticketsubject]" value="{$queue.resolveticketsubject}"
											{tip text=$tip trigger="resolveticketsubject"}>
									</TD>
								</TR>
								<TR>
									<TD>
										<strong>
											{trans("Body (resolve ticket)")}
										</strong>
									</TD>
								</TR>
								<TR>
									<TD>
										{capture assign="tip"}{trans("Body of mail sent after ticket is resolved")}<br><br>{trans("<!customer-notification-body>The following special symbols are supported:<br><strong>%tid</strong> - ticket identifier,<br><strong>%cid</strong> - customer identifier,<br><strong>%pin</strong> - customer PIN,<br><strong>%customername</strong> - customer full name,<br><strong>%title</strong> - ticket title.<br>")}{/capture}
										<TEXTAREA name="queue[resolveticketbody]" rows="10"
											{tip text=$tip trigger="resolveticketbody"}
											>{$queue.resolveticketbody}</TEXTAREA>
									</TD>
								</TR>
							</TABLE>
						</div>
						<div id="notification-tab-sms" class="notification-tab">
							<TABLE cellpadding="3">
								<TR>
									<TD>
										<strong>
											{trans("Body (new ticket)")}
										</strong>
									</TD>
								</TR>
								<TR>
									<TD>
										{capture assign="tip"}{trans("SMS sent after new ticket is created")}<br><br>{trans("<!customer-notification-body>The following special symbols are supported:<br><strong>%tid</strong> - ticket identifier,<br><strong>%cid</strong> - customer identifier,<br><strong>%pin</strong> - customer PIN,<br><strong>%customername</strong> - customer full name,<br><strong>%title</strong> - ticket title.<br>")}{/capture}
										<TEXTAREA name="queue[newticketsmsbody]" rows="10"
											{tip text=$tip trigger="newticketsmsbody"}
											>{$queue.newticketsmsbody}</TEXTAREA>
									</TD>
								</TR>
								<TR>
									<TD>
										<strong>
											{trans("Body (new message)")}
										</strong>
									</TD>
								</TR>
								<TR>
									<TD>
										{capture assign="tip"}{trans("SMS sent after new message is added")}<br><br>{trans("<!customer-notification-body>The following special symbols are supported:<br><strong>%tid</strong> - ticket identifier,<br><strong>%cid</strong> - customer identifier,<br><strong>%pin</strong> - customer PIN,<br><strong>%customername</strong> - customer full name,<br><strong>%title</strong> - ticket title.<br>")}{/capture}
										<TEXTAREA name="queue[newmessagesmsbody]" rows="10"
											{tip text=$tip trigger="newmessagesmsbody"}
											>{$queue.newmessagesmsbody}</TEXTAREA>
									</TD>
								</TR>
								<TR>
									<TD>
										<strong>
											{trans("Body (resolve ticket)")}
										</strong>
									</TD>
								</TR>
								<TR>
									<TD>
										{capture assign="tip"}{trans("SMS sent after ticket is resolved")}<br><br>{trans("<!customer-notification-body>The following special symbols are supported:<br><strong>%tid</strong> - ticket identifier,<br><strong>%cid</strong> - customer identifier,<br><strong>%pin</strong> - customer PIN,<br><strong>%customername</strong> - customer full name,<br><strong>%title</strong> - ticket title.<br>")}{/capture}
										<TEXTAREA name="queue[resolveticketsmsbody]" rows="10"
											{tip text=$tip trigger="resolveticketsmsbody"}
											>{$queue.resolveticketsmsbody}</TEXTAREA>
									</TD>
								</TR>
							</TABLE>
						</div>
					</div>
				</fieldset>
			</div>
			<div class="lms-ui-box-row">
				<fieldset>
					<legend>
						{icon name="verifier"}
						<strong>{trans("Verifier notifications")}</strong>
					</legend>
					<table id="verifier-notifications">
						<tr>
							<td>
								<strong>
									{trans("Subject (ticket verifier)")}
								</strong>
							</td>
						</tr>
						<TR>
							<TD>
								{capture assign="tip"}{trans("Subject of mail sent to verifier after ticket is transferred to him")}<br><br>{trans("<!customer-notification-subject>The following special symbols are supported:<br><strong>%tid</strong> - ticket identifier,<br><strong>%title</strong> - ticket title.<br>")}{/capture}
								<INPUT type="text" name="queue[verifierticketsubject]" value="{$queue.verifierticketsubject}"
									{tip text=$tip trigger="verifierticketsubject"}>
							</TD>
						</TR>
						<TR>
							<TD>
								<strong>
									{trans("Body (ticket verifier)")}
								</strong>
							</TD>
						</TR>
						<TR>
							<TD>
								{capture assign="tip"}{trans("Body of mail sent to verifier after ticket is transferred to him")}<br><br>{trans("<!customer-notification-body>The following special symbols are supported:<br><strong>%tid</strong> - ticket identifier,<br><strong>%cid</strong> - customer identifier,<br><strong>%pin</strong> - customer PIN,<br><strong>%customername</strong> - customer full name,<br><strong>%title</strong> - ticket title.<br>")}{/capture}
								<TEXTAREA name="queue[verifierticketbody]" rows="10"
									{tip text=$tip trigger="verifierticketbody"}
									>{$queue.verifierticketbody}</TEXTAREA>
							</TD>
						</TR>
					</table>
				</fieldset>
			</div>
		</div>
		<div class="lms-ui-box-panel">
			&nbsp;
		</div>
	</div>
	<div class="lms-ui-box-buttons">
		{button type="submit" icon="save" label="Submit" onclick="javascript:document.queue.submit()"}
		{if $layout.module == 'rtqueueedit'}
			{button id="delete-rtqueue" icon="delete" label="Delete"
				onclick="location.href=='?m=rtqueuedel&id={$queue.id}&qaction=delete';" data_name=$queue.name}
		{/if}
		{button icon="cancel" label="Cancel" onclick="location.href='?m=rtqueuelist';"}
	</div>
</div>
</form>

<script>

	$(function() {
		$('form[name="queue"] [name="queue[name]"]').focus();

		for (var i = 0; i < {count($_RT_RIGHTS)}; i++) {
			$('input:checkbox[name="allbox[' + Math.pow(2, i) + ']"]').click(function() {
				$('input:checkbox[name*="queue[users]"][value="' + $(this).attr('data-value') + '"]').prop('checked', this.checked);
			});
		}

		$('#checkall').click(function() {
			$('#categories option').attr('selected', $(this).prop('checked')).trigger('chosen:updated');
		});

		var categories = $('#categories option');
		$('#checkall').prop('checked', categories.length == categories.filter(':selected').length);
		$('#categories').change(function() {
			$('#checkall').prop('checked', categories.length == categories.filter(':selected').length);
		});

		$('#delete-rtqueue').click(function() {
			var name = $(this).attr('data-name');
			confirmDialog($t("Are you sure, you want to remove queue '$a' and all assigned tickets and messages?", name), this).done(function() {
				location.href = $(this).attr('href');
			});
			return false;
		});

		$('[name="queue"]').submit(function() {
			window.sessionStorage.setItem('rtqueuemodify-active-notification-tab', $('.notification-tab:visible').attr('id'));
		});

		var activeNotificationTab = window.sessionStorage.getItem('rtqueuemodify-active-notification-tab');
		if (activeNotificationTab) {
			window.sessionStorage.removeItem('rtqueuemodify-active-notification-tab');
		}

		var errors = [];
		$('.notification-tab').each(function() {
			if ($(this).find('.lms-ui-error').length) {
				errors.push($(this).attr('id'));
			}
		});

		var newActiveNotificationTab;

		if (activeNotificationTab) {
			newActiveNotificationTab = activeNotificationTab;
		}
		if (errors.length && errors.indexOf(activeNotificationTab) == -1) {
			newActiveNotificationTab = errors[0];
		}

		if (newActiveNotificationTab) {
			newActiveNotificationTab = $('.notification-tab').index('#' + newActiveNotificationTab);
		} else {
			newActiveNotificationTab = $('.notification-tab').first();
		}
		$('#notification-tabs').tabs({
			active: newActiveNotificationTab
		});

		$.each(errors, function(index, value) {
			$('[href="#' + value + '"]').closest('.ui-tab').addClass('lms-ui-error');
		});
	});

</script>
{/block}
