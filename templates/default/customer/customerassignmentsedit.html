{extends file="layout.html"}
{block name=title}::: LMS :{$layout.pagetitle|striphtml} :::{/block}
{block name=module_content}
<!--// $Id$ //-->
<H1>{$layout.pagetitle}</H1>
<FORM method="POST" name="assignment" action="?m={$layout.module}{if $assignment.id}&id={$assignment.id}{if $assignment.liabilityid}&lid={$assignment.liabilityid}{/if}{else}&id={$customerinfo.id}{/if}">
<INPUT type="submit" class="hiddenbtn">
<TABLE class="lmsbox">
	<COLGROUP>
		<COL style="width: 1%;">
		<COL style="width: 1%;">
		<COL style="width: 98%;">
	</COLGROUP>

    <THEAD>
		<TR>
			<TD colspan="3">
				<table>
					<tr>
						<td>
							<IMG src="img/money.gif" alt="">
						</TD>
						<TD class="bold">
							{trans("Type")}/{trans("Tariff")}:
						</TD>
						<td>
							<input type="hidden" value="" name="assignment[tarifftype]" id="tarifftype">
							<select id="tariff-select" size="1" name="assignment[tariffid]" {tip text="Select liability type" trigger="tariffid"}>
								<option value=""   data-tarifftype="0" {if !$assignment.tariffid} selected{/if}>- {trans("tariffless liability")} -</option>
								<option value="-1" data-tarifftype="0" {if $assignment.tariffid == -1} selected{/if}>{trans("- all liabilities suspended -")}</option>

								{if !empty($promotions)}
									<option value="-2" data-tarifftype="0" {if $assignment.tariffid == -2} selected{/if}>- {trans("per promotion schema")} -</option>
								{/if}

								{foreach $tariffs as $tariff}
									<option value="{$tariff.id}" data-tarifftype="{$tariff.tarifftype}" data-tariffaccess="{$tariff.authtype}" data-tarifftags="{$tariff.tags}" {if $tariff.id==$assignment.tariffid} selected{/if} data-valid="{$tariff.valid}"{if !$tariff.valid} class="blend"{if !$assignment.alltariffs} style="display: none;"{/if}{/if}>
									{$tariff.name} ({if ConfigHelper::checkConfig('privileges.superuser') || !ConfigHelper::checkConfig('privileges.hide_finances')}{$tariff.value|money_format}{/if}{if $tariff.upceil || $tariff.downceil}, {$tariff.downceil}/{$tariff.upceil} kbit/s{/if})
									</option>
								{/foreach}
							</select>
						</td>
					</tr>
					<tr>
						<td colspan="2">
						</td>
						<td>
							<label>
								<input type="checkbox" name="assignment[alltariffs]" {tip text="Check if all tariffs should be displayed" trigger="alltariffs"}{if $assignment.alltariffs} checked{/if}>
								{trans("show all tariffs")}
							</label>
							{if !empty($tags)}
							&nbsp;&nbsp;{trans("Tags:")}
							{/if}
							<SELECT size="5" id="assignment-tags" name="assignment[tags][]" class="lms-ui-multiselect" {tip text="Select tariff tags"} multiple onchange="javascript:updateTariffs();"{if empty($tags)} style="display: none;"{/if}>
								{foreach $tags as $tag}
								<OPTION value="{$tag.id}">{$tag.name}</OPTION>
								{/foreach}
							</SELECT>
						</td>
					</tr>
				</table>
			</td>
		</TR>
    </THEAD>

    <TBODY>
		{if !empty($promotions)}
		<tr>
			<td colspan="3" class="container">

                <!-- +++ PROMOTION CODE //-->
                <style>
                    div.lms-ui-multiselect hr {
                        margin-top: 0px;
                        margin-bottom: 0px;
                    }
                </style>

                <table id="a_promotions">
					<tr>
						<td>
							<img src="img/location.png" alt="">
						</td>
						<td class="bold">
							{trans("Location:")}
						</td>
						<td style="width: 98%;">
							<select name="assignment[location]" id="location-select" {tip text="Select promotion location"}>
								<OPTION value="">{trans("- all -")}</OPTION>
								{foreach $locations as $location}
								<OPTION value="{$location}"{if $assignment.location == $location} selected{/if}>{$location}</OPTION>
								{/foreach}
							</select>
						</td>
					</tr>
					<TR>
						<TD>
							<IMG src="img/promoschema.gif" alt="">
						</TD>
						<TD class="bold">
							{trans("Schema")}:
						</TD>
						<TD style="width: 98%;">
							<SELECT size="1" name="assignment[schemaid]" id="promotion-select" {tip text="Select promotion schema"}>
								{foreach $promotions as $promotion}
									<optgroup label="{$promotion.name}" data-valid="{$promotion.valid}"{if !$promotion.valid} class="blend"{if !$assignment.alltariffs} style="display: none;"{/if}{/if}>
										{foreach $promotion.schemas as $schemaid => $schema}
												<OPTION value="{$schemaid}"{if $assignment.schemaid == $schemaid} SELECTED{/if} data-valid="{$promotion.valid}"{if !$promotion.valid} class="blend"{/if}>{$schema.name|truncate:40:"...":true}</OPTION>
										{/foreach}
									</optgroup>
								{/foreach}
							</SELECT>
						</TD>
					</TR>
					<TR>
						<TD></TD>
						<TD colspan="2">
							{foreach $promotions as $promotionid => $promotion}
								{foreach $promotion.schemas as $schemaid => $schema}
									<table class="promotion-table" id="schema{$schemaid}">
										{foreach $schema.items as $label => $item}
										<tr>
											<td class="valign-top text-right">
												{t a=$label}<!tariffselection>$a:{/t}
											</td>
											<td class="valign-top" style="padding-bottom: 10px; padding-top: 0;">
												<table>
													<tr>
														{if isset($item.single)}
														<td class="valign-top{if !$item.single.optional} blend{/if}">
															<label>
																<input class="schema-tariff-checkbox" type="checkbox" name="assignment[stariffid][{$schemaid}][{$label}]"
																	value="{$item.single.tariffid}" data-label="{$label}"
																	{if isset($assignment.stariffid[$schemaid][$label]) || !$item.single.optional} checked{/if}
																	{if !$item.single.optional} disabled data-mandatory="1"{/if} data-tariffaccess="{$item.single.authtype}">
																{$item.single.tariff}
															</label>
														</td>
														{else}
														<td class="valign-top">
															<select class="schema-tariff-selection" name="assignment[stariffid][{$schemaid}][{$label}]" data-label="{$label}">
																{if !$item.selection.required}
																<option value="0" data-tariffaccess="-1">{trans("- none -")}</option>
																{/if}
																{foreach $item.selection.items as $item}
																<option value="{$item.tariffid}" data-tariffaccess="{$item.authtype}"
																	{if in_array($item.tariffid, $assignment.stariffid[$schemaid])} selected{/if}>{$item.tariff}</option>
																{/foreach}
															</select>
														</td>
														{/if}
													</tr>
													<tr class="customernodes" data-schemaid="{$schemaid}" data-label="{$label}">
														{*
															content of this row is generated by ajax
															?m=customernodes&api=1&customerid=... call
														*}
													</tr>
												</table>
											</td>
										</tr>
										{/foreach}
									</table>
								{/foreach}
							{/foreach}
						</TD>
					</TR>
				</table>
                <!-- --- PROMOTION CODE //-->
			</td>
		</tr>
		{/if}

		<TR>
		    <TD colspan="3" class="container">
		        <TABLE class="lmsbox-inner">
					<COLGROUP>
						<COL style="width: 50%;">
						<COL style="width: 50%;">
					</COLGROUP>
	
					<TBODY>
			            <TR>
			                <TD class="valign-top">
			                    <TABLE style="width: 100%;" cellpadding="3">
									<COLGROUP>
										<COL style="width: 1%;">
										<COL style="width: 1%;">
										<COL style="width: 98%;">
									</COLGROUP>
			
									<TBODY>
									
										<TR id="a_name">
											<TD>
												<IMG src="img/money.gif" alt="">
											</TD>
											<TD class="bold nobr">
												{trans("Name:")}
											</TD>
											<TD>
												<INPUT type="text" name="assignment[name]" value="{if $assignment.tariffid<=0}{$assignment.name}{/if}" size="30" {tip text="Enter liability name/description (tariffless liabilities only)" trigger="name"}>
											</TD>
										</TR>
									
										<TR id="a_attribute">
											<TD>
												<IMG src="img/money.gif" alt="">
											</TD>
											<TD class="bold nobr">
												{trans("Attribute:")}
											</TD>
											<TD>
												<INPUT type="text" name="assignment[attribute]" value="{if $assignment.attribute}{$assignment.attribute}{/if}" size="30" {tip text="Enter tariff attribute" trigger="attribute"}>
											</TD>
										</TR>
									
										<TR id="a_day">
											<TD>
												<IMG src="img/calendar.gif" alt="">
											</TD>
											<TD class="bold nobr">
												{trans("Accounting:")}
											</TD>
											<TD>
												<SELECT size="1" name="assignment[period]" {tip text="Select time period to account liability"}>
													{foreach from=$_PERIODS key=key item=item}
														<OPTION value="{$key}"{if $assignment.period == $key} SELECTED{/if}>{$item}</OPTION>
													{/foreach}
												</SELECT>
									
												<INPUT type="TEXT" name="assignment[at]" value="{if $assignment.at}{$assignment.at}{/if}" {tip text="Enter accounting time. For disposable accounting enter date in format YYYY/MM/DD, for weekly accounting enter day of week (Monday = 1), for monthly accounting enter day of month (1 to 28), for yearly accounting enter day and month in format DD/MM (15/09 means September 15th), for half-yearly DD/MM (MM <=6) and for quarterly DD/MM (MM <= 3)" trigger="at"} SIZE="8">
												{if $assignment.atwarning}
													<INPUT type="hidden" name="assignment[atwarning]" value="1">
												{/if}
											</TD>
										</TR>

										<TR id="a_period">
											<TD>
												<IMG src="img/calendar.gif" alt="">
											</TD>
											<TD class="bold nobr">
												{trans("Period:")}
											</TD>
											<TD class="nobr">
												{trans("from:")}
												<INPUT type="TEXT" name="assignment[datefrom]" value="{if $assignment.datefrom}{$assignment.datefrom}{/if}" placeholder="{trans("yyyy/mm/dd")}" {tip class="calendar" text="Enter accounting start date in YYYY/MM/DD format. If you don't want to define 'From' date leave this field empty" trigger="datefrom"} SIZE="10">
												
												{trans("to:")}
												<INPUT type="TEXT" name="assignment[dateto]" value="{if $assignment.dateto}{$assignment.dateto}{/if}" placeholder="{trans("yyyy/mm/dd")}" {tip class="calendar" text="Enter accounting end date in YYYY/MM/DD format. Leave this field empty if you don't want to set expiration date" trigger="dateto"} SIZE="10">
											</TD>
										</TR>
									
										<TR id="a_value">
											<TD>
												<IMG src="img/value.gif" alt="">
											</TD>
											<TD class="bold">
												{trans("Value:")}
											</TD>
											<TD>
												<INPUT type="text" name="assignment[value]" value="{if $assignment.value}{$assignment.value}{/if}" size="10" {tip text="Enter liability value (tariffless liabilities only)" trigger="value"}>
											</TD>
										</TR>


										<TR id="a_discount">
											<TD style="{if !ConfigHelper::checkConfig('privileges.superuser') && ConfigHelper::checkConfig('privileges.hide_finances')} display: none;{/if}">
												<IMG src="img/value.gif" alt="">
											</TD>
											<TD class="bold" style="{if !ConfigHelper::checkConfig('privileges.superuser') && ConfigHelper::checkConfig('privileges.hide_finances')} display: none;{/if}">
												<span class="bold">{trans("Discount:")}</span>
											</TD>
											<TD style="{if !ConfigHelper::checkConfig('privileges.superuser') && ConfigHelper::checkConfig('privileges.hide_finances')} display: none;{/if}">
												<INPUT type="text" size="8" name="assignment[discount]" value="{if $assignment.pdiscount != 0}{$assignment.pdiscount|string_format:"%.2f"}{else}{if $assignment.vdiscount != 0}{$assignment.vdiscount|string_format:"%.2f"}{/if}{/if}" {tip text="Enter discount percentage or amount" trigger="discount"}>
												<SELECT name="assignment[discount_type]">
													{foreach from=$_DISCOUNTTYPES item=item key=key}
														<OPTION value="{$key}"{if $assignment.discount_type == $key} selected{/if}>{$item}</OPTION>
													{/foreach}
												</SELECT>
											</TD>
										</TR>

										<TR id="a_tax">
											<TD>
												<IMG src="img/tax.gif" alt="">
											</TD>
											<TD class="bold">
												{trans("Tax:")}
											</TD>
											<TD>
												<SELECT SIZE="1" name="assignment[taxid]" {tip text="Select Tax value"}>
													{foreach item=tax from=$taxeslist}
														<OPTION value="{$tax.id}"{if ($assignment.taxid && $tax.id == $assignment.taxid) || (!$assignment.taxid && $tax.value == ConfigHelper::getConfig('phpui.default_taxrate'))} selected{/if}>{$tax.label}</OPTION>
													{/foreach}
												</SELECT>
											</TD>
										</TR>

										<TR id="a_productid">
											<TD>
												<IMG src="img/class.gif" alt="">
											</TD>
											<TD class="bold">
												{trans("Product ID:")}
											</TD>
											<TD>
												<INPUT type="text" name="assignment[prodid]" value="{$assignment.prodid}" size="10" {tip text="Enter liability Product ID (tariffless liabilities only)"}>
											</TD>
										</TR>
									
										<TR id="a_numberplan">
											<TD>
												<IMG src="img/id.gif" alt="">
											</TD>
											<TD class="bold nobr">
												{trans("Numbering Plan:")}
											</TD>
											<TD>
												<SELECT name="assignment[numberplanid]" {tip text="Select numbering plan"}>
													<OPTION value=""{if !$assignment.numberplanid} selected{/if}>- {trans("default")} -</OPTION>
									
													{foreach item=plan from=$numberplanlist}
														{assign var=period value=$plan.period}
														<OPTION value="{$plan.id}"{if $plan.id==$assignment.numberplanid} SELECTED{/if}>{$plan.template} ({$_NUM_PERIODS.$period})</OPTION>
													{/foreach}
												</SELECT>
											</TD>
										</TR>

										<TR id="a_paytype">
											<TD>
												<IMG src="img/print.gif" alt="">
											</TD>
											<TD class="bold nobr">
												{trans("Payment Type:")}
											</TD>
											<TD>
												<SELECT name="assignment[paytype]" {tip text="Select payment type" trigger="paytype"}>
													<OPTION value=""{if !$assignment.paytype} selected{/if}>- {trans("default")} -</OPTION>

													{foreach from=$_PAYTYPES item=item key=key}
														<OPTION value="{$key}"{if $assignment.paytype==$key} selected{/if}>{$item}</OPTION>
													{/foreach}
												</SELECT>
											</TD>
										</TR>

										<tr id="a_address">
											<td>
												<img src="img/info3.gif" alt="">
											</td>
											<td class="bold">
												<span class="bold">{trans("Recipient:")}</span>
											</td>
											<td>
												<select name="assignment[recipient_address_id]">
													<option value="-1">{trans("none")}</option>
													{foreach $customeraddresses as $v}
														<option value="{$v.address_id}"{if $assignment.recipient_address_id == $v.address_id} selected{/if}>{$v.location}</option>
													{/foreach}
												</select>
											</td>
										</tr>

									</TBODY>
								</TABLE>
							</TD>
							<TD class="valign-top">
								<TABLE style="width: 100%;" cellpadding="3">
									<COLGROUP>
										<COL style="width: 1%;">
										<COL style="width: 1%;">
										<COL style="width: 98%;">
									</COLGROUP>

									<TBODY>
										<TR id="a_options">
											<TD>
												<IMG src="img/options.gif" alt="">
											</TD>
											<TD class="bold">
												{trans("Options:")}
											</TD>
											<TD class="nobr">
												<label>
													<INPUT type="checkbox" name="assignment[invoice]" value="1"{if $assignment.invoice} checked{/if}>
													{trans("with invoice")}
												</label>
												<br>
												<label>
													<input type="checkbox" name="assignment[separateinvoice]" value="1"{if $assignment.separateinvoice} checked{/if}>
													{trans("separate invoice")}
												</label>
												<br>
												<label>
													<INPUT type="checkbox" name="assignment[settlement]" value="1"{if $assignment.settlement} checked{/if}>
													{trans("with settlement of first deficient period")}
												</label>
											</TD>
										</TR>

										{if $customernodes}
										<tr id="a_nodes">
											<td>
												<img src="img/node.gif" alt="">
											</td>
											<td class="bold">
												{trans("Nodes:")}
											</td>
											<td class="nobr" id="nodelist">
												{foreach $customernodes as $customernode}
													<span data-tariffaccess="{$customernode.authtype}" class="global-node-checkbox">
													<label>
														<input type="checkbox" name="assignment[nodes][{counter}]" value="{$customernode.id}"{if in_array($customernode.id, (array)$assignment.nodes)} checked{/if}>
														<span class="bold">{$customernode.name}</span> ({$customernode.id|string_format:"%04d"}){if $customernode.location} / {$customernode.location|truncate:"60":"...":true}{/if}
													</label>
													<br>
													</span>
												{/foreach}
											</td>
										</tr>
										{/if}

										{if $customernetdevnodes}
										<tr id="a_netdevnodes">
											<td>
												<img src="img/netdev.gif" alt="">
											</td>
											<td class="bold">
												{trans("Network Devices:")}
											</td>
											<td class="nobr" id="nodelist">
												{foreach $customernetdevnodes as $customernode}
													<span data-tariffaccess="{$customernode.authtype}" class="global-node-checkbox">
													<label>
														<input type="checkbox" name="assignment[nodes][{counter}]" value="{$customernode.id}"{if in_array($customernode.id, (array)$assignment.nodes)} checked{/if}>
														<span class="bold">{$customernode.name}</span> {if !empty($customernode.netdev_name)} / {$customernode.netdev_name}{/if}  ({$customernode.id|string_format:"%04d"}){if $customernode.location} / {$customernode.location|truncate:"60":"...":true}{/if}
													</label>
													<br>
													</span>
												{/foreach}
											</td>
										</tr>
										{/if}
										
										{if $customervoipaccs}
										<tr id="a_phones">
											<td>
												<img src="img/voip.gif" alt="">
											</td>
											<td class="bold">
												{trans("Phones:")}
											</td>
											<td class="nobr" id="nodelist">
												{foreach $customervoipaccs.accounts as $acc}
													{foreach $acc.phones as $p}
                                                        <label>
															<input type="checkbox" name="assignment[phones][]" value="{$p.id}" {if !empty($assignment.phones) && in_array($p.id, $assignment.phones)} checked{/if}>
															<span class="bold">{$p.phone}</span> / {$acc.login}
														</label>
														<br>
													{/foreach}
												{/foreach}
											</td>
										</tr>
										{/if}

										{if count($customernodes) || count($customernetdevnodes)}
										<tr id="a_checkall">
											<td colspan=2"></td>
											<td>
												<label>
													<INPUT TYPE="checkbox" NAME="allbox" onchange="javascript:checkAllNodes();" VALUE="1">
													{trans("check all<!items>")}
												</label>
											</td>
										</tr>
										{/if}
									</TBODY>
								</TABLE>
							</TD>
						</TR>
					</TBODY>
				</TABLE>
			</TD>
		</TR>

		<TR>
			<TD class="buttons" colspan="3">
				<A href="#" id="assignment-submit">{trans("Submit")} <IMG src="img/save.gif" alt=""></A>&nbsp;
				<A href="?m=customerinfo&id={$customerinfo.id}">{trans("Cancel")} <IMG src="img/cancel.gif" alt=""></A>
			</TD>
		</TR>
    </TBODY>
</TABLE>
</FORM>
<BR>

{include file="customer/customerassignments.html"}
<SCRIPT>
	var tariffTypes = [];
	{foreach $tariffs as $tariff}
	tariffTypes[{$tariff.id}] = {$tariff.tarifftype};
	{/foreach}

	var promotions = new Promotions({
		customerid: {$customerinfo.id},
		selected: {if !empty($assignment.snodes)}{json_encode($assignment.snodes)}{else}{}{/if},
		internetTariffType: {$smarty.const.TARIFF_INTERNET},
		tariffTypes: tariffTypes,
        variablePrefix: 'assignment'
	});

	$(function() {
		$('#assignment-submit').click(function(e) {
			{if ConfigHelper::checkConfig('phpui.node_assignment_warning')}
			var tariffid = parseInt($('form[name="assignment"] select[name="assignment[tariffid]"]').val());

			if (isNaN(tariffid)) {
				document.assignment.submit();
				return;
			}

			switch (tariffid) {
				case -1:
					document.assignment.submit();
					return;
				case -2:
                    if (!promotions.validate(e))
                    	return;
					break;
				default:
					if (tariffTypes[tariffid] == {$smarty.const.TARIFF_INTERNET}
				        && !$('#nodelist :checked:not([name="allbox"])').length
				        && !confirm('{trans("No nodes has been selected for assignment, by at least one is recommended! Are you sure you want to continue despite of this?")}')) {
					    e.stopImmediatePropagation();
					    return;
				    }
					break;
			}
			{/if}

            document.assignment.submit();
		});
	});

	$(function() {
		$('[name="assignment[alltariffs]"]').click(function() {
			updateTariffs();

			var checked = this.checked;

			// +++ PROMOTION CODE
			var promotion_select = $('#promotion-select');
			$('optgroup', promotion_select).each(function() {
				if ($(this).attr('data-valid') == '0') {
					$(this).css('display', checked ? '' : 'none');
				}
			});
			if (!checked && $('option[data-valid="0"]', promotion_select).filter(':selected').val() == promotion_select.val()) {
				promotion_select.val($('option[data-valid="1"]:nth(0)', promotion_select).val());
				promotion_select.trigger('change');
			}
			// +++ PROMOTION CODE
		});

		updateCheckAllNodes();
	});

	function updateCheckAllNodes() {
		$('[name="allbox"]').prop('checked',
			$('[name^="assignment[nodes]"]').length == $('[name^="assignment[nodes]"]:checked').length);
	}

	function checkAllNodes() {
		$('[name^="assignment[nodes]"]').prop('checked', $('[name="allbox"]').prop('checked'));
	}

	$('[name^="assignment[nodes]"]').click(function() {
		updateCheckAllNodes();
	});

	$( '#tariff-select' ).change( function() {
		var selected = $(this).find(':selected');
		var tarifftype = selected.attr('data-tarifftype');
		var tariffaccess = selected.attr('data-tariffaccess');
		if (typeof(tariffaccess) == 'undefined') {
			tariffaccess = 0;
		} else {
			tariffaccess = parseInt(tariffaccess);
		}
		var val = $(this).val();

		$('#tarifftype').val(tarifftype);

		if (val == -2) {
			$('#a_promotions').show();
		} else {
			$('#a_promotions').hide();
		}

		if (val == '') {
			$('#a_tax,#a_value,#a_productid,#a_name').show();
			$('#a_attribute').hide();
		} else {
			$('#a_tax,#a_value,#a_productid,#a_name').hide();
			if (val == -1) {
				$('#a_attribute').hide();
			} else {
				$('#a_attribute').show();
			}
		}

		if (val == -1) {
			$('#a_numberplan,#a_paytype,#a_address,#a_options,#a_day').hide();
		} else {
			$('#a_numberplan,#a_paytype,#a_address,#a_options,#a_day').show();
		}

		if (tarifftype == {$smarty.const.TARIFF_PHONE}) {
			$('#a_phones,#a_checkall').show();
			$('#a_nodes,#a_netdevnodes').hide();
		} else {
			$('#a_phones').hide();
			if (val == -1 || val == -2) {
				$('#a_nodes,#a_netdevnodes,#a_checkall').hide();
			} else {
				$('#a_nodes,#a_netdevnodes,#a_checkall').show();
			}
		}

		{if ConfigHelper::checkConfig('privileges.superuser') || !ConfigHelper::checkConfig('privileges.hide_finances')}
		if (val <= -1) {
			$('#a_discount').hide();
		} else {
			$('#a_discount').show();
		}
		{/if}

		$('span.global-node-checkbox').each(function(key, value) {
			var authtype = parseInt($(this).attr('data-tariffaccess'));
			if ((authtype && (authtype & tariffaccess)) || !tariffaccess) {
				$(this).show();
			} else {
				$(this).hide();
				$(':checkbox', this).prop('checked', false);
			}
		});
    });

	function updateTariffs() {
		var valid_checked = $('[name="assignment[alltariffs]"]').is(':checked');
		var tariff_select = $('#tariff-select');

		var tags = [];
		$('[name="assignment[tags][]"]:checked').each(function() {
			tags.push(parseInt($(this).val()));
		});

		$('option', tariff_select).each(function() {
			var option = $(this);

			if (option.val() <= 0) {
				return;
			}

			if (tags.length) {
				option.css('display', 'none');

				var tarifftags = option.attr('data-tarifftags');
				if (typeof(tarifftags) === 'undefined' || !tarifftags.length) {
					return;
				}

				tarifftags = JSON.parse('[' +  tarifftags + ']');

				$.each(tarifftags, function(key, value) {
					if (tags.indexOf(value) > -1) {
						if (option.attr('data-valid') == '0') {
							option.css('display', valid_checked ? '' : 'none');
						} else {
							option.css('display', '');
						}
					}
				});
			} else {
				if (option.attr('data-valid') == '0') {
					option.css('display', valid_checked ? '' : 'none');
				} else {
					option.css('display', '');
				}
			}
		});

		if ($('option:selected', tariff_select).css('display') == 'none') {
			tariff_select.val($('option:nth(0)').val());
		}
	}

// +++ PROMOTION CODE
	function Promotions(options) {
		var promotion = this;

		if (typeof options === 'object') {
			if ('customerid' in options) {
				this.customerid = options["customerid"];
		    } else {
				this.customerid = 0;
			}

			if ('selected' in options) {
				this.selected = options["selected"];
			} else {
				this.selected = {};
			}

			if ('internetTariffType' in options) {
				this.internetTariffType = options["internetTariffType"];
			} else {
				this.internetTariffType = 0;
			}

			if ('tariffTypes' in options) {
				this.tariffTypes = options["tariffTypes"];
			} else {
				this.tariffTypes = tariffTypes;
			}

			if ('variablePrefix' in options) {
				this.variablePrefix = options["variablePrefix"];
			} else {
				this.variablePrefix = tariffTypes;
			}
        } else {
			this.customerid = 0;
			this.selected = {};
			this.internetTariffType = 0;
			this.tariffTypes = {};
			this.variablePrefix = 'assignment';
        }

        if (!this.customerid) {
			console.log('WARNING! customerid is empty!');
		}

		this.initEventHandlers = function() {
			$('#assignment-submit').click(function () {
				$('.schema-tariff-checkbox[data-mandatory]:checkbox').removeAttr('disabled');
			});

			$('#promotion-select').change(this.promotionSelectionHandler);
			$('#location-select').change(this.locationSelectionHandler);

			$('.schema-tariff-selection').change(this.tariffSelectionHandler);
			$('.schema-tariff-checkbox').change(this.tariffCheckboxHandler);
		}

		this.validate = function(e) {
			var schemaid = $('#promotion-select').val();
			var tariffs = {};
			$('[name^="' + promotion.variablePrefix + '[stariffid][' + schemaid + ']"]').each(function () {
				if ($(this).is('.schema-tariff-selection') || $(this).prop('checked')) {
					if ($(this).val() > 0) {
						tariffs[$(this).attr('data-label')] = $(this).val();
					}
				}
			});
			if ($.isEmptyObject(tariffs)) {
				return false;
			}
			var cancelled = 0;
			$.each(tariffs, function (label, tariffid) {
				if (cancelled) {
					return false;
				}
				if (promotion.tariffTypes[tariffid] == promotion.internetTariffType
			        && !$('[name^="' + promotion.variablePrefix + '[snodes][' + schemaid + '][' + label + ']"]:checked').length
				    && !confirm(lmsMessages.nodeAssignmentWarning)) {
					cancelled = 1;
				}
			});
			if (cancelled) {
				e.stopImmediatePropagation();
				$('.schema-tariff-checkbox[data-mandatory]:checkbox').attr('disabled', true);
				return false;
			}
            return true;
		}

		this.promotionSelectionHandler = function() {
			$('.promotion-table').hide();

			var t = $(this).find('option:selected').val();

			$("#schema" + t).show();

			init_multiselects('select.lms-ui-multiselect-deferred:visible');

			$('#location-select').trigger('change');
		}

		this.tariffSelectionHandler = function () {
			var tariffaccess = parseInt($(this).find(':selected').attr('data-tariffaccess'));
			var location_select = $('#location-select').val();
			var tr = $(this).closest('tr').next('.customernodes');

			if (tariffaccess == -1) {
				tr.hide();
			} else {
				tr.show();
			}

			init_multiselects('select.lms-ui-multiselect-deferred:visible');

            var ms = tr.find('.lms-ui-multiselect').data('multiselect-object');
            if (!ms) {
				return;
			}
			ms.getOptions().each(function(key) {
				var authtype = parseInt($(this).attr('data-tariffaccess'));
				var location = $(this).attr('data-location');
				if (((authtype && (authtype & tariffaccess)) || !tariffaccess)
					&& (location == location_select || !location_select.length)) {
					ms.showOption(key);
				} else {
					ms.hideOption(key);
				}
			});
			ms.refreshSelection();
		}

		this.tariffCheckboxHandler = function() {
			var tariffaccess = parseInt($(this).find(':selected').attr('data-tariffaccess'));
			var location_select = $('#location-select').val();
			var tr = $(this).closest('tr').next('.customernodes');

			var checked = this.checked;
			if (checked) {
				tr.show();
			} else {
				tr.hide();
			}

			init_multiselects('select.lms-ui-multiselect-deferred:visible');

			var ms = tr.find('.lms-ui-multiselect').data('multiselect-object');
			if (!ms) {
				return;
			}
			ms.getOptions().each(function (key) {
				if (checked) {
					var authtype = parseInt($(this).attr('data-tariffaccess'));
					var location = $(this).attr('data-location');
					if (((authtype && (authtype & tariffaccess)) || !tariffaccess)
						&& (location == location_select || !location_select.length)) {
						ms.showOption(key);
					} else {
						ms.hideOption(key);
					}
				} else {
					ms.hideOption(key);
				}
			});
			ms.refreshSelection();
		}

        this.locationSelectionHandler = function() {
			$('.schema-tariff-selection').trigger('change');
			$('.schema-tariff-checkbox').trigger('change');
		}

		this.getCustomerNodes = function() {
			if (typeof this.customerid === 'undefined') {
				return;
			}
			var customerid = parseInt(this.customerid);
			if (isNaN(customerid)) {
				return;
			}

			if (typeof this.selected === 'undefined') {
				selected = {};
			} else {
				selected = this.selected;
			}

			$('#a_promotions').hide();

			$.ajax('?m=customernodes&api=1&customerid=' + customerid, {
				async: true,
				method: 'POST',
				dataType: 'json',
				success: function(data) {
					String.prototype.lpad = function(padString, length) {
						var str = this;
						while (str.length < length)
							str = padString + str;
						return str;
					}

					var customernodes = $('.customernodes');
					$('td', customernodes).remove();

					customernodes.each(function() {
						var schemaid = $(this).attr('data-schemaid');
						var label = $(this).attr('data-label');
						var td = $('<td/>');
						var html = '';
						if (data["customernodes"]) {
							html += '<span class="bold">' + lmsMessages.nodes + '</span><br>';
							html += '<select name="' + promotion.variablePrefix + '[snodes][' + schemaid + ']['
                                + label + '][]" multiple class="lms-ui-multiselect-deferred" data-separator="<hr>">';

							var options = '';
							$.each(data["customernodes"], function(key, node) {
								var location = String(node["location"]);
								if (location.length > 50) {
									location.substr(0, 50) + '...';
								}
								var nodeid = String(node["id"]).lpad('0', 4);
								options += '<option value="' + node["id"] + '"'
									+ ((schemaid in selected) && (label in selected[schemaid])
									&& (selected[schemaid][label].indexOf(node["id"]) > -1) ? ' selected' : '')
									+ ' data-tariffaccess="' + node["authtype"] + '"'
									+ ' data-location="' + node["location"] + '"'
									+ ' data-html-content="<strong>' + node["name"] + '</strong>'
									+ ' (' + nodeid + ')' + (location.length ? ' / ' + location : '') + '"';
								options += '>';
								options += node["name"] + ' (' + nodeid + ')'
									+ (location.length ? ' / ' + location : '');
								options += '</option>';
							});

							html += options;
							html += '</select>';
						}
						if (data["netdevnodes"]) {
							html += '<br><br><span class="bold">' + lmsMessages.netdevices + '</span><br>';
							html += '<select name="' + promotion.variablePrefix + '[snodes][' + schemaid + ']['
                                + label + '][]" multiple class="lms-ui-multiselect-deferred" data-separator="<hr>">';

							var options = '';
							$.each(data["netdevnodes"], function(key, node) {
								var location = String(node["location"]);
								if (location.length > 50) {
									location.substr(0, 50) + '...';
								}
								var nodeid = String(node["id"]).lpad('0', 4);
								options += '<option value="' + node["id"] + '"'
									+ ((schemaid in selected) && (label in selected[schemaid])
									&& (selected[schemaid][label].indexOf(node["id"]) > -1) ? ' selected' : '')
									+ ' data-tariffaccess="' + node["authtype"] + '"'
									+ ' data-location="' + node["location"] + '"'
									+ ' data-html-content="<strong>' + node["name"] + '</strong>'
									+ ' (' + nodeid + ')' + ' / ' + node["netdev_name"] + (location.length ? ' / ' + location : '') + '"';
								options += '>';
								options += node["name"] + ' (' + nodeid + ')'
									+ (location.length ? ' / ' + location : '');
								options += '</option>';
							});

							html += options;
							html += '</select>';
						}
						td.html(html).appendTo(this);
					});

					$('#a_promotions').show();
                    init_multiselects('select.lms-ui-multiselect-deferred:visible');

					$('#promotion-select').trigger('change');
					$('#tariff-select').trigger('change');
                }
			});
        }

        this.getCustomerNodes();
		this.initEventHandlers();
    }
// --- PROMOTION CODE
</SCRIPT>
{/block}
