$Id$

0. Co to?

Ten ma³y zestaw narzêdzi pozwala za pomoc± squida w dosyæ elegancki sposób 
wy¶wietlaæ wiadomo¶ci administracyjne oraz w razie potrzeby blokowaæ dostêp
do w3cache. Oczywi¶cie aby to dzia³a³o w 100%, wszyscy klienci musz± 
korzystaæ ze squida.

1. Instalacja.

Mo¿na wyró¿niæ 3 etapy:

a) konfiguracja squida
b) konfiguracja redirectora
c) konfiguracja serwera wirtualnego

Ad a.

Do squid.conf dodajemy dwie linie:
------
redirector_bypass on
redirect_program /sciezka/do/lms-squid
------
które informuj± squida aby dla ka¿dego adresu u¿ywa³ naszego redirectora.

Ad b.

Otwieramy w naszym ulubionym edytorze plik lms-squid i praktycznie wszystko 
co mo¿na ustawiæ w naszym redirectorze to:
------
my $configfile = '/etc/lms/lms.ini';
------
Czyli po³o¿enie pliku konfiguracyjnego. Reszta konfiguracji ustawiana jest 
w lms.ini, gdzie dopisujemy:
------
[redirector]
redirect        = http://nasz.serwer.pl/winetka/
------
Czyli adres winetki.

Ad c.

Do katalogu gdzie ma byæ widoczna winetka kopiujemy index.php, message.html 
i zawarto¶æ katalog img.

2. W dzia³aniu.

Kluczowym elementem jest redirector. Odpowiada on za to, aby w momencie 
ustawienia dla danego komputera flagi warn lub no access, przekierowywa³ 
wszystkie ¿±dania wysy³ane do squida na nasz, ustalony wcze¶niej adres. 
Przekierowaniu nie ulegaj± adresy zawieraj±ce adres naszej winetki, tak aby 
umo¿liwiæ za³adowanie siê obrazków.

Je¶li komputer ma ustawion± flagê warn, to po przekierowaniu u¿ytkownik ma 
mo¿liwo¶æ oznaczenia wiadomo¶ci jako przeczytanej, po czym skrypt automatycznie 
kieruje przegl±darkê na pierwotnie wywo³ywany URL, w przypadku oznaczeniu danego 
komputera jako wy³±czony, u¿ytkownik bêdzie zawsze przekierowywany na adres 
winetki, bez mo¿liwo¶ci oznaczenia wiadomo¶ci jako przeczytanej.

Po drodze nigdzie nie s± wykorzystywane ¿adne regu³ki firewalla, ani ¿aden
daemon nie jest prze³adowywany. Skrypty podczas dzia³ania nie modyfikuj±
¿adnych plików. Jedyn± wad± mo¿e byæ nieznaczne spowolnienie pracy squida
(przyk³adowo, na moim Athlonie 1.2 przetworzenie 2000 adresów, z czego po³owa 
podlega³a przekierowaniu, a druga nie trwa³o 0,774 sekundy, co daje czas 
przetwarzania oko³o 0,000387 sekundy na adres. W momencie pisania tego tekstu
strona g³ówna Wirtualnej Polski sk³ada³a siê z 62 elementów, przez co 
redirector zwiêkszy³ jej czas ³adowania o 0,023994 sekundy).

3. Co zrobiæ je¶li nie dzia³a.

Je¶li redirector nie dzia³a w ogóle, lub nie dzia³a tak jak by¶my chcieli, 
pierwsze co nale¿y zrobiæ, to sprawdziæ czy nasz system spe³nia wymagania LMSa,
oraz czy zrobili¶my wszystko co jest wymagane podczas instalacji redirectora. 
Nastêpnie, warto zajrzeæ w logi Squida. Je¶li znajdziemy w logach co¶ takiego 
(99% przypadków):

Mar 14 11:20:09 localhost squid[27459]: WARNING: redirector #1 (FD 7) exited 
Mar 14 11:20:09 localhost squid[27459]: WARNING: redirector #2 (FD 8) exited 
Mar 14 11:20:09 localhost squid[27459]: WARNING: redirector #3 (FD 9) exited 
Mar 14 11:20:09 localhost squid[27459]: Too few redirector processes are 
running 
Mar 14 11:20:09 localhost squid[27459]: The redirector helpers are crashing too 
rapidly, need help! 

to wszystkiemu winien jest sam redirector. Uruchamiamy wiêc redirector "z 
palca" czy te¿ jak mówi± inni - w trybie interaktywnym, czyli wydajemy komendê:

./lms-squid

najlepiej bêd±c zalogowanym jako root. Wszystko co powinni¶my teraz zobaczyæ, 
to migaj±cy kursor. Je¶li widzisz jakie¶ komunikaty, to radzê dok³adnie je 
przeczytaæ, gdy¿ bêd± to komunikaty b³êdów i zarazem wskazówka czego brak. 
Je¶li natomiast widzimy weso³o migaj±cy kursor, wpisujemy dowolny tekst, oraz 
naciskamy enter:

test

Redirector powinien wys³aæ nam co¶ w stylu 

302:http://adres_winetki/?oldurl=test

czyli adres przekierowania, oraz kontynuowaæ pracê. Je¶li redirector w tym 
momencie zamyka siê, oraz wy¶wietla komunikat b³êdu, mamy nastêpn± wskazówkê. 
Je¶li natomiast nadal pracuje wpisujemy:

http://lms.rulez.pl/ 192.168.0.1/-

gdzie 192.168.0.1 jest adresem z naszej sieci, który nie podlega przekierowaniu. 
Redirector powinien odpowiedzieæ dok³adnie tym samym co wpisali¶my. Je¶li nie, 
kolejna wskazówka.

Je¶li redirector nadal kontynuuje pracê, spróbuj wykonaæ powy¿sze czynno¶ci na 
koncie na którym pracuje squid. Czyli robimy np.

su proxy
./lms-squid

Je¶li na koncie na którym pracuje squid redirector dzia³a poprawnie, nale¿y 
sprawdziæ jeszcze raz konfiguracjê squida. Je¶li to nadal nic nie daje, sprawd¼ 
wszystkie nietypowe rzeczy w twoim systemie (byæ mo¿e u¿ywasz chroot, i w 
chrootowanym ¶rodowisku brakuje bibliotek).
